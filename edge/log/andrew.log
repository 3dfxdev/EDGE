Andrew Apted's Log

2006/10/01:

Reworked item pickup code in p_inter.cpp.  Made the hack which
kept keys in CO-OP games into higher quality code.  Fixed weapons
for _old_ DeathMatch so they don't disappear when picked up, and
to also give 2.5 times the normal ammo.

Fixed bots to cope better with old DeathMatch pickup rules.

Fixed IDCLEV cheat to work in DeathMatch mode.

2006/09/16:

For LINES.DDF, tidied up the RTS Enable Tag types, removing the
unnecessary SINGLESIDED flag, and added some extra types for
MONSTER activated lines.

RTS: changed WHEN_PLAYER_NUM so that a single value gives the
minimum number of players.

2006/09/09:

Reworked the way Voodoo Dolls are spawned.

Added support for Boom's SWITCHES and ANIMATED lumps.

2006/09/08:

Made it so after saving a game and you go back to load it,
the skull cursor will be on the slot you just saved.

2006/09/05:

Added 'tag' numbers for things on the map.  These values can
be loaded directly for Hexen map format.

RTS work: keyword parameters for SPAWN_THING command, of the
form "XXX=value".  They must be placed after all the normal
parameters.  Valid keywords are: X,Y,Z,ANGLE,SLOPE,TAG.  The
TAG keyword can also be used on THING_EVENT and DAMAGE_MONSTERS
commands too, and THING_EVENT allows "ANY" for the thing type.

2006/09/01

Been working on supporting BOOM's wind/current/point pushers.
Added THINGS.DDF specials PUSHABLE and POINT_FORCE.  Note that
all things which are SHOOTABLE are automatically PUSHABLE.

Added LINES.DDF sector effects SET_FRICTION, WIND_FORCE,
CURRENT_FORCE and POINT_FORCE, which implement BOOM line types
223, 224, 225 and 226 respectively.

2006/08/17:

Initial implementation for Boom linetype 223 "set friction".
Boom's handling of muddy/icy sectors is quite complicated and
I don't intend to emulate it perfectly, although I'll get as
close as possible using EDGE's physics.

Removed the old "Boom/Edge" compatibility option and detection
code.  EDGE will default to being a BOOM compatible engine.
The EDGE-specific sector types have been renumbered to lie in
the range 4400-4499.  A new option "-ecompat" has been added
to allow any existing mods which use the old numbers to work.

2006/08/16:

The CAPSLOCK and NUMLOCK keys don't behave like normal keys
(they act as if the key is pressed the whole time the light
on the keyboard is on), so I've added a workaround for them.

Experimented with automatically extracting the color for a
dynamic light from the sprite (monster attacks).

2006/08/08:

Automap: draw horizontal/vertical lines as a box, which fixes
really bad rendering on the Voodoo 3.  Ditto for progress bars.

2006/08/04:

Removed the checks in RTS and DDF which required "#VERSION 1.29"
to be present when using certain (new) features.  Also removed the
deprecated warning for the old-style DDF/RTS comments.

Added POWERUP_BARE_BERSERK powerup to ddf, now POWERUP_BERSERK
always gives you the fist and is retained for the level.  That
is a better way to keep backwards compatibility.

Removed hack which made SILENT_TO_MONSTERS apply to both primary
and secondary attacks unless "#VERSION 1.29" was given.  This is
a small break in backwards compatibility though.

2006/08/03:

Added SPAWN_LIMIT to attacks.ddf, which limits the total number
of the spawned objects on the level (both SPAWNER and TRIPLESPAWNER
attacks).  Used for Pain Elemental compatibility with DOOM.

Simplified debug output: -debug (not -debugfile) enables output
to the "debug.txt" file, in the same directory as "edge.log".
Also made screenshots be stored in a "screenshot" directory in
the same place.  Now these features can work when EDGE is installed
in a global (read-only) place, especially in Linux.

2006/08/02:

Fixed bug where console background sometimes flashed over
the whole screen at the start of the drop-down sequence.

Savegames now use ZLIB for compression.

The -warp option and IDCLEV cheats now allow a number,
for better compatibility with original DOOM.

2006/07/31:

Integrated 64-bit fixes by Darren Salt.

Began work on using the "SCons" build system for EDGE.

2006/07/20:

RTS: Added BLOCK_LINES command analogous to the existing
UNBLOCK_LINES command.  However any things (including the
player) touching the line will get permanently stuck.

Fixed bug when MOUSE_LOOK was disabled and you used a melee
attack (punch/saw) on a monster, causing the vertangle to
become "stuck" on a high angle -- rockets/plasma would go
straight up into the ceiling, and punching stopped working.

2006/07/19:

Fixed name matching for keys (REDCARD == RED_CARD).
Fixed #CLEARALL in WEAPONS.DDF to prevent the player
getting weapons previously marked as FREE.

2006/06/27:

Reworked the DeathBot code, making it functional again.
Still very dumb though.  Also fixed the -bots command, and
the BFG spray which stopped working in deathmatch.  Finally
the unused MF_JUSTPICKEDUP flag was removed.

2006/06/22:

Fixed vertical wrapping of midmasked textures (especially
when SMOOTHING was enabled).

2005/10/24:

Music: The win32 MUS player now validates the format (to prevent
trying to play a MIDI file as MUS).  Also updated the code to
prevent a possible race-condition when the song data is deleted.

2005/10/15:

Renderer: default FAR distance is now 64000.

RTS: fixes for SHOW_MENU: (a) allow no choices, (b) when only
one choice, don't prefix with "1.", and allow SPACE/ENTER keys
to accept, (c) 'Q' and 'X' keys can cancel the menu, (d) bump
up maximum lines in TITLE area to 24.

Applied Darren Salt's "no CD music" patch.

2005/10/11:

DEH_EDGE: Fixed the player ammo limits, which were using some names
("DAGGERS" etc) which have since been replaced ("AMMO9" etc).

2005/10/02:

Video: Added 1280x1024 and 1600x1200 as possible resolutions.

2005/09/19:

Implemented (finally) some PNG save code.

2005/09/05:

RTS: Implemented "ALL" keyword for START_MAP, causing the
script to be spawned on every map.

2005/08/30:

Fixed an infinite loop (!) when -music -nosound was given
(or in my case: sound couldn't be initialised) and OGG music
was tried to be played.  Affected the Humidity player too.

2005/08/28:

Increased TIP_SLOT_MAX from 30 to 45.

2005/08/23:

Implemented new attack special "NOTARGET", which forces bullet
and projectile attacks to go straight ahead and ignore the
monster being aimed at.  For object spawners (like the Pain
Elemental), the spawned things won't automatically hate the
player (or whatever their parent has a grudge against).

2005/08/19:

Reworked the flat-flooding emulation to cope a bit better with
the new Doom light-fading stuff.  Also limited the size of the
drawn plane, to prevent some very Slimetrail-like glitches
(e.g. SCYTHE2 MAP17).  Also changed the rendering order of
solid surfaces, now back-to-front.  So far I haven't noticed
any ill effects, which is good, but will revert to the old code
should a significant issue pop up.

2005/08/08:

Allow the ENTER key to be used for in-game actions (previously
the HU_Responder code always ate it).

2005/08/07:

glBSP: Finished final testing for version 2.20.  What remains
now is to update the glBSPX front-end, update the documentation
and web site, and then release the mungrel :).

2005/08/06:

Fixed problem with BERSERK powerup which was applied to _all_
melee type weapons (e.g. the Chainsaw).  For this I've added
a new Attacks.DDF command BERSERK_MULTIPLY, which can work
with most types of attacks (melee, shot, missiles).

Added new PICKUP_EFFECT called "KEEP_POWERUP(BERSERK)", which
makes the berserk be kept for the rest of the level, replacing
the previously hard-coded kludge.  It is automatically added
when #VERSION < 1.29 for compatibility.

2005/08/01:

Wad code: don't assume that the presence of C_START/C_END lumps
indicates that the wad was meant for BOOM.

2005/07/17:

OpenGL: added the missing glNormal assignments when rendering
the skybox planes.

2005/06/04:

Simplified the way monster reloading works, the RELOAD_CHECK
action now increases the shot_count itself.  Also added a new
RELOAD_RESET action.

Fix for Bug #1209521 (unable to use GWA files with levels in
a modified EDGE.WAD).

Screenshot work: Output format is now JPEG.  Added key mappings
for PrtScr key (not yet tested).  Added new 'screenshot' console
command, making sure the console itself is not saved -> getting
it to work correctly required the glReadBuffer(GL_FRONT) calls
to be removed (just use OpenGL's default: GL_BACK when double
buffering).

Linux: made the keypad numbers map to '0' upto '9' (similar to
Darren's patch #682561, but not as general because the engine
doesn't support mappings for the weapon keys yet, and that's
too big a job this close to the release).

2005/05/27:

Investigated why the railing texture (REDWALL) in Aliens TC
doesn't show up in EDGE.  It's because the patch is 200 pixels
high, but the texture is specified as 128 pixels high (in the
TEXTURE1 lump).  Seems DOOM/BOOM allow this because of column
based software rendering.  The fix is not trivial, so I'm not
going to worry about it for now.

2005/05/25:

Fixes for continuous (perpetual) floor types in LINES.DDF
(numbers 53, 87, 162, 181) which had height targets which
were wrong or inconsistent (they all should go down to the
lowest included floor and up to the highest included floor).
Noticed the problem at the start of MAP01 in ONEWEEK.WAD.

2005/05/22:

Tweaked the new lighting emulation, and tested it against the
software renderer in LsdlDoom.  The behaviour is not completely
the same, but close enough I think (the player's weapon is now
fixed too).

2005/05/21:

Level loading code: detect the TNT Evilution MAP31 bug (missing
yellow keycard) and fix it.

Implemented emulation of Doom's lighting (the way it fades the
further away things are).  Can be changed in the Video Options
menu.  Default (for now) is enabled -- we'll see what people
say about it with RC#2.  The equations are not quite right,
sprites are definitely too bright up close...

2005/05/18:

Added support into EDGE for V5 GL-Nodes.  Untested.

2005/05/15:

Fixed bug with EDGE's network code, which wasn't setting the
port on the destination address when the -server parameter
was used (hence couldn't connect).

Added "HOVER" special (as per RFE #1115207) for THINGS.DDF which
makes the sprite of an item hover up and down.

Added support for Ghosts, where bullets and missiles can pass
through an enemy.  The new things.ddf command is GHOST_CLASS
and it takes a set of letter flags (like IMMUNITY_CLASS).  Also
implemented a SIDEGHOST special which is similar to SIDEIMMUNE
but allows you to shoot through your buddies :).

2005/05/14:

Added support for loading DDF files specified directly on the
command-line.  The way it works is to check the <WXYZ> tag at
the top of the DDF file, and convert that into a lump name
(e.g. <ANIMATIONS> becomes DDFANIM).  It's a bit dirty, but
it's not a good idea to do major reworking this close to the
release (IOW, we can clean it up later :).

Added fix for Bug #882895, loading the correct language strings
for TNT Evilution and The Plutonia Experiment.  The base name
of the IWAD is stored in 'iwad_base' global, this is consulted
when loading DDF and causes "TNTLANG" or "PLUTLANG" lump to be
read in when needed (in addition to all the normal stuff).

Implemented NOZBUFFER special for things.ddf.  Mainly useful
for "particles" (e.g. smoke puffs, blood) to prevent Z-fighting
when there are many of them in a small area.

2005/05/13:

Been working on emulating Doom's original lighting (levels
fading away in the distance).  A real bug-bear has been
OpenGL (more specifically: drivers) which only compute
lighting & fog on the original vertices and interpolates
across that -- the effect is terrible, made worse because
the values are computed BEFORE the vertices are clipped to
the view frustum.

OpenGL FOG proved to be unsuitable because the equations
always diminish to zero, which doesn't match the Doom
formula (lighting values >= 128 diminish to a specific
value).  The Doom formula is this:

  level = lighting / 128.0 + 40 / dist - 1.0;

where the result ranges from 0.0 to 1.0.  Using a single
OpenGL light at the view position and invoking the LOD
polygon splitting code should give a good approximation
to the original game.

2005/05/11:

Created a new credit screen to go with the title screen.

2005/05/09:

Added support for using HQ2X in the image code, fixing many
many bugs with the epi/image_hq2x code in the process.
There are two console variables to control this (they have
command-line versions too): "hqscale" enables/disables the
whole effect, "hqall" makes the effect apply to everything
(sprites/flats/textures), it is normally disabled which
means the effect only applies to HUD elements (title pics,
status bar, etc).

2005/05/08:

Integrating the H2QX (High Quality 2x scaling algorithm, by
Maxim Stepin) into the EPI.  Updated the code to directly
handle palettised images (removes the unnecessarily loss of
precision that the intermediate RGB-16 table caused, not to
mention using less memory).  Made it handle transparent
pixels (based on Jaakko Keränen's Doomsday modification),
and improved the YUV calculation.

2005/05/05:

It seems the high value of Z_FAR (200000) causes serious
problems on some OpenGL drivers (Geforce4 MX).  I have
changed the near and far clip distances to be 4 and 32000,
and made them configurable ("nearclip" and "farclip" as
console variables and cmd-line options).

2005/04/27:

Added point classes to the EPI (ipos_c for integer, pos2_c
and pos3_c for float), as per request from Andrew Baker.

2005/04/24:

Attempted fix for Bug #1188291 : removed the EF_DLIGHT mobj
flag (it was just a cached check of info->dlight.type), since
it's possible in the monster resurrection code for this flag
to get the wrong value.

2005/04/18:

Camera class is shaping up, added some test code, fixed some
bugs, the sphere-cone interection test seems to work, but the
BBOX interection test is broken.

2005/04/15:

Began work on a new camera class (rgl_camera), which should
eventually replace the current mess.

2005/04/14:

Added bounding box class to the EPI.  Completed the EPI vector
classes (although they still need some testing code).

Added a fast, high-quality random number generator (the Mersenne
Twister) to the EPI.  Implemented test suite for it, and in case
you were wondering: she passed.

2005/04/08:

Fixed intermission code to display an error (instead of crashing)
when the game definition is not found.

Updated system network code, with 'nonet' variable (analogous to
nosound and nomusic), I_StartupNetwork, I_ShutdownNetwork and
I_NetworkReturnError functions.

Improved network code's way of determining local IP address, and
method used to find the server.  Also fixed a problem in MP_Server
where under Linux incoming broadcast packets were not received.

Reinstated 'language' field of EDGE.CFG.

2005/04/07:

Made #CLEARALL in Weapons.ddf do something useful (prevent you
getting the previous weapons via the cheats).

Added hack-ish fix for problem when weapon sprites and thing
sprites share the same 4-letter prefix (e.g. rifle pick-up sprite
in Immoral Conduct is SAWDL0, the other SAWDxx are weapon sprites).

2005/04/03:

Found synchronisation problem with net-games, the random_seed
was being set to different values.

Sorted out the single player/coop/deathmatch variables, adding
the following three macros:

  SP_MATCH()   : deathmatch == 0 && numplayers <= 1
  COOP_MATCH() : deathmatch == 0 && numplayers  > 1
  DEATHMATCH() : deathmatch > 0

Fixed the meaning of the 'netgame' global var to be "we are
connected to a server and exchanging packets with it".  Some
parts of the code associated 'netgame' with multiple players,
but you can play Deathmatch/Coop without a server (with Bots).

Improved network startup, setting game parameters and player
information from the packets received from the server.

2005/04/02:

Spent some time working on multiplayer support.  I have made
the user interface in MP_Server a lot simpler, and updated
the code to use TCP connections (NL_RELIABLE_PACKETS).  For
the first time two separate EDGEs are able to connect to the
server and play a game, but they are not synchronised.

2005/03/28:

Fixed image system to give title screens defined in IMAGES.DDF
the higher threshhold before degradation.  The title screen
doesn't blur now at the LOW detail setting.

2005/03/23:

Demo code: store player sync information (it may help 1.29
demos to work in later versions of EDGE).  Fixed a problem
causing large de-sync when using menus while recording.

2005/03/19:

Fixed custom sky boxes so the top image (of the cube) does
not need to be turned up-side-down.

2005/03/18:

Looked for problem with secondary attacks not reloading
properly.  Found culprit in ddf_weap.cpp and fixed it.

2005/03/11:

Added an additional four ammo types.  The total is now 16.
The eight new ones are called AMMO9 thru AMMO16, and the
eight olds ones have aliases AMMO1 thru AMMO8.

2005/03/05:

Implemented an additional sky stretch mode "ORIGINAL", which
renders the sky just like the original EXE.  It doesn't work
well with mlook, which doesn't matter since the purists who
prefer this sky mode will also disable mlook.

Added "Mouse Look" enable/disable to gameplay menu, and save
the setting in the config file.  (I was a little surprised
this option wasn't already there).

2005/03/01:

Console: made it slide down/up rather than instantly appearing
and disappearing.  Made the font smaller.  Created a new PNG
background image.

2005/02/28:

Implemented the "swap stereo" option by negating the listener
UP vector passed to the AL.

Added temp fix for console background (wrong size after the
resolution was changed).

2005/02/27:

Renderer: made world sprites and weapon sprites consistent WRT
GL_BLEND and GL_ALPHA_TEST modes.

Fixed certain teleporter linetypes (39, 97, 125-126, 207-208,
243-244 and 262-267) to teleport objects, for compatibility
with Boom maps.  Closes Bug #1144418.

Updated OpenAL code with 'NO_SOURCE' define (-1), removing the
use of zero, as zero may be a valid AL source identifier (as
per advice from the OpenAL mailing list).  Set PLAYINGSFXLIMIT
to 30 (attempted fix for Bug #1152196), noting that we should
improve our AL source management after 1.29.

Sky code: allow room for tall sprites (upto 256 units) so that
they don't get clipped.  Fixes the trees in BOOMEDIT.wad.

2005/02/26:

Reworked sound/music volumes for a large range (twenty steps
on the sliders), with a non-linear lookup-table which gives
finer control at the quiet end.  Added velocity vectors to the
sound system API, but have disabled doppler for now due to some
bad-sounding effects.  Pass relative and position info directly
to I_SoundPlayback, and volume directly to I_MusicPlayback.
Added I_CDTicker function to the CD code (Win32 and Linux).

2005/02/24:

Fix for Bug #1144429: sectors that change the ceiling texture
to F_SKY1 cause HOM.  Fix (courtesy Darren Salt) for Boom
generalised stairs (wrong movement height, 32 --> 24).  Fixed
Bug #1144422 where "MANUAL" linetypes (e.g. from generalised
types) did not work properly (they should ignore their tag).

Automap: use anti-aliasing (GL_LINE_SMOOTH), as requested in
RFE #1116615.  Can be turned off with SMOOTHMAP console var.

Demos: play them via drag-n-drop onto the EDGE binary.

2005/02/23:

Removed USE_DEH define from code and makefiles.

Fix for Bug #1144419: line-to-line teleporters did not match
Boom's behaviour (WRT reversing).

2005/02/21:

For images.ddf, support both JPG and JPEG keywords.

2005/02/19:

OpenAL: at startup, generate a single output source for the
software music systems (OGG/Vorbis and Humidity).

2005/02/18:

Made fading of powerup effects optional, new console variable
FADEPOWER controls it.  Closes Bug #1120467.

Removed some unused globals (e.g. effect_colourmap), noting
that non-player cameras have been broken for quite a while
(they use too much data from the displayplayer).  Something
to be tackled after 1.29.

Fixed demo filenames which would add ".edm" even if the given
filename already had an extension.

2005/02/17:

Input system: made gamekeys[] array store both pressed and
released state of a key, clearing the released keys after the
ticcmds have been built.  This allows keys pressed very
quickly (or some special cases, e.g. the mousewheel, where
the down & up events are simultaneous) to be used in-game.

Implemented next weapon / previous weapon keys.

Fixed Bug #1122229, where a sector lighting of zero still
allowed some stuff to be seen.

Added a hack-ish but working fix for Bug #1119744 (actually
Darren Salt's comment) where a rotated automap would not draw
some parts of the map (wrong clipping).

2005/02/16:

Discovered why mlook flip-over bug occurred: it is due to the
FLOAT_2_ANG() macro, trying to cast a negative float value to
an unsigned int -- I just assumed it would "wrap around", but
it is actually limiting the value to the unsigned int range,
hence FLOAT_2_ANG(-88) becomes zero!  Adding a temp fix for
the 1.29 release, afterwards switch to epi::angle_c class.

Found problem with external PNG/JPEG loading.  The Win32
functions ReadFile() and WriteFile() return zero _on error_,
but the win32_epifile.cpp code assumed the opposite.

2005/02/14:

Fixed bug not clearing the pain/death override state names
(Bug #1092525).

Added a fix for Bug #1121571, giving "Weird actor->movedir"
error after a monster stops following an RTS path.

Fixed fuck-up where using -playdemo with a non-existent file
would make EDGE, for all intents and purposes, "lock up" (it
kept trying to open the demo, ad infinitum -- I have a 250MB
edge.log to prove it!).

2005/02/10:

The TRACER and RANDOM_TRACER actions had almost identical
code, the difference had nothing to do with randomness as
their names suggest.  Hence merged into a single function.

2005/02/09:

Reverted smoke-trail Z-adjustment to be like the original
(fix for Revenant's missile -- also with fixes in DDF).

2005/02/08:

A bit more refactoring in p_action.cpp.  New attacks.ddf
command TRACE_ANGLE which removes hard-coded value.

2005/02/07:

Fixed smoking tracers (missiles) so that they generate
smoke even when not following their target.

Removed EF_NOTRACE flag: the same thing can be achieved by
simply setting the projectile's target to NULL.  Moved the
logic for "autoaim slightly to the left or right" into the
P_MapTargetAutoAim() routine itself.  Removed the global
variable 'linetarget' (a dirty way of passing a value back
from P_AimLineAttack function).

Renamed functions for consistent use of the 'P_Act' prefix,
namely that all DDF actions have this prefix, but no other
functions have it.

Reworked targetting method when autoaiming is off: instead
of using a dummy MOBJ as the target, we now treat a "NULL"
target to mean "fire straight ahead".  It was mainly the
LaunchProjectile() function that needed changing: the work
is now done by DoLaunchProjectile() which takes the exact
target coordinates, and a new function P_TargetTheory()
for easily computing them, whether target is NULL or not.

2005/02/06:

Weapons: allow clips to be reloaded without requiring them
to be filled (in particular, when available ammo is less
than a full clip size).  This behaviour is disabled by the
pre-existing NO_PARTIAL special.

2005/02/05:

Worked on makefiles.

2005/02/03:

Fixed problem causing the title screen to run too fast.

2005/02/02:

Investigated the "shots passing through extrafloors" bug.
It's a bit embarassing, it's not really a bug since there
is no code there to contain a bug -- I never got around to
writing the checks for a hitscan going sharply upwards. I
remember the plan now: integrate the shoot & aim algorithm
with the new sight code (which DOES check these kinds of
situations properly).  Since this change is far from
trivial, I'll postpone it until after 1.29.

2005/01/31:

Discovered why you don't slide along walls in certain places
(e.g. curved corridors in Plutonia MAP03) -- happens since
the code will never change the sign of a momentum component
(DX or DY).  For example, a slide that requires a low DY
value to go from negative to positive won't occur.  Fixing
this can wait until after 1.29.

2005/01/29:

Savegames: simplified format, removed silly XOR encryption
and removed the redundant end markers.  Should make savegame
files smaller (initial tests show 30% to 40% reduction).
Backwards compatibility has been maintained.

Added some fixes for mid-masked textures, now the railings
in Eternal MAP28 and the wireframe crate near the start of
P.A.R E1M1 are working properly.  A few things still don't
work (e.g. forcefield on linedef #943 of Eternal MAP28).

2005/01/27:

New demo system is tentatively working.

2005/01/26:

Began work re-implementing demos based on the new spec.  Some
things I'll leave until later: running demos from lumps, using
compression, support for more than 1 player, the player
synchronisation feature, and storing explicit game events.

2005/01/25:

Worked on new demo specs (docs/tech/demo_fmt.txt).

2005/01/21:

Still reworking the player handling.  Added a newgame_params_c
class that is passed to G_DeferredInitNew and G_InitNew, and
which includes information what players are in the game (local
or networked, human or robot).  Added I_Sleep() to the system
interface.  Reworked engine::Tick() to merge the singletic
and normal behaviour into one simple loop.

2005/01/20:

Began work on fixing demos.  First step: remove reliance on
having players outside of an in-progress game.

2005/01/19:

Worked on loading JPEG images.

2005/01/17:

Made partial clip reloading the default, use NO_PARTIAL
weapon special in DDF to disable it.  Fixed the NoAmmo+Clip
handling (in particular, the chainsaw in Immoral Conduct).

2005/01/16:

Finished work on PNGs as lumps, updating PNG reading code to
use the epi::file_c interface (rather than a FILE*).

2005/01/15:

DDF: made filenames in Images.DDF relative to gamedir.
Likewise for filenames in Playlist.DDF.  Missing OGG/Vorbis
files now cause a warning (instead of fatal error).

Worked on reading PNG images from lumps in the WAD, including
new epi::mem_file_c class.

2005/01/14:

Updated PNG loading code so that solid images are loaded
without an alpha channel, which not only saves memory but
also ensures that the "gap area" (when width or height is
not a power-of-two) is correct/consistent (solid black).

2005/01/13:

Reopened Bug #1026649 (misaligned textures), since my "fix"
seemed to introduced more problems, e.g. a door in Dmonfear
MAP10.  PrBoom (and others it seems) are using the modulus
of the y_offset with the texture_height, which can produce
different results than the original Doom.  Even BOOM 2.02
did not use the modulus.  I think that PrBoom has broken
compatibility.  Now the question is: which one to support ?
My preference is to be faithful to the original.

2005/01/11:

Images.ddf: implemented support for using NEW sprites
(the previous code only allowed replacement sprites).

2005/01/07:

Fix for some PNG images which had transparent parts but were
marked as solid (simple too: just check for tRNS chunk).

Decided that IMAGES.DDF can't work with a single namespace,
since the structure of WAD files means that name clashes are
not just possible, they happen quite often.  I'm fairly sure
four namespaces are enough: Textures, Flats, Sprites and
Graphics.  Entries in IMAGES.DDF need a prefix, like this:

   [tex:STARTAN3]
   [flat:FWATER1]
   [spr:TROOA3]
   [gfx:BOSSBACK]

OK.... been reworking image system to have multiple namespaces,
and it really has simplified the code (e.g. I noticed that
IMSRC_Font was redundant), and miscellaneous bits (dummy images
and sky-merge images) are now separated into their own tubs.

Needed to move R_InitSprites() earler in the startcode array
(before W_ImageCreateUser) to handle sprites in IMAGES.DDF.

2005/01/06:

Images.DDF: faster method for whitening RGB font patches.

2005/01/05:

Preliminary support for music in Linux (and MacOSX) via the
Humidity library.

2005/01/04:

Found out that SW1STONE texture of DOOM 1 is different
than the one in DOOM 2 (former is narrow on a grey bricky
texture, latter is wide on a browny texture).  I used to
think DOOM 2 textures were a pure superset of DOOM 1.

The new Window/Fullscreen toggle in the set-res screen was
finished, and works OK in Linux.

Images.DDF: support for weapon sprites, updating code so that
offset (0, 0) does the reasonable thing: puts the weapon dead
center horizontally and bottom of weapon == bottom of screen.
Should also fix Bug #1093590 (missing weapon frames).

Added "CROSSHAIR" special for images.ddf, centers the image
on the screen (before the offsets are applied).

Discovered that completely new sprites (not in any WAD) are
not working when defined in IMAGES.DDF.  Hmmm....

Implemented "DISKICON" console variable and option.

2005/01/03:

Worked on specifying colours directly (without lumps) in
colmap.ddf.  The command is GL_COLOUR=#AABBCC.

Slope thoughts: there are two ways to do them: (1) additive,
i.e. the sloped part is additional to the base geometry, or
(2) subtractive: the sloped part is "cut away" from the base
geometry of the level.  My preference is for (1), since it
makes more sense with extrafloors.  With (2), you have the
potential of the extrafloor vanishing to nothing (the slope
on top intersecting with the bottom).  Can't happen with (1).

2005/01/02:

Not being able to skip finale text screens was another
little thing driving me nuts.  Fixed.  Reworked the code,
got rid of the damn "fall throughs" in the switch statement
(which obscured what the code was really doing).

Moved HU crosshair code to rgl_thing (near psprite drawers),
and stopped it being drawn when weapon uses a custom one.

Reinstated the flashing on/off effect when a powerup is about
to run out (I found the fading wasn't a good indicator for
the player, and for invulnerability it didn't look good).

Preliminary code for changing Windowed/Fullscreen in the
Set Resolution screen.

2005/01/01:

Worked on colourmap conversion code.

Reinstated saving the autorun status into the config file
(it was driving me mad).  Seems I commented this out four
years ago (almost to the day).

2004/12/31:

Fixed Bug #1093599, sprite horizontal misalignments.
Fixed weapons using both PARTIAL and FRESH specials, and
removed the "reload" of non-clip weapons (just wasted ammo).

2004/12/30:

Fixed problem with Voodoo-doll levels where you spawned at
the location of the voodoo doll instead of the right spot
(the LAST player spot is the one to spawn at).

2004/12/26:

Worked on making MacOS X binaries.  Had a few headaches:
current directory (when launched from the Finder) was not
right (damn GUIs...).  Had to modify Zlib so the namespace
didn't clash with a system library, also had to modify Libpng
(one symbol clashed with AppKit: _png_get_uint IIRC).  Had to
modify LibSDL since the CAGuard class used in the CDROM code
clashed with the same class in OpenAL.  Finally, couldn't get
drag-and-drop to work for love nor money.

2004/12/23:

Discovered that drag-and-drop did NOT work under Windows 98
(others ?), for some reason when you drag a file onto the
gledge executable, it sets the current directory to be the
windows directory (C:\WINDOWS).  That's truly fucked !!!

Luckily it looks like the same workaround I used on Linux:
using the path from argv[0], should save the day here too.

2004/12/21:

Fixed savegames which stopped working due to my recent ticcmd
changes.  Disabled "multiplayer game" from the options menu
since it won't do anything useful for a while (after 1.29). 
Fully disabled new dlight code (ON and COMPAT are identical).

2004/12/20:

OGG Vorbis: removed the HOGGIE_OGG define from the code.
Fixed playback on big-endian cpus (like PPC).  Spent way too
much time trying to find out why playback sounded so bad, when
it was just the version of OpenAL I was using - getting the
latest from CVS fixed it.

2004/12/18:

The new image system allows full RGB sprites, but this doesn't
work natively with PALETTE_REMAP handling, so I've added some
code which can remap RGB images.

Fixed sprites so that the OFFSET_X and OFFSET_Y commands in
images.ddf can use "zero" (the default) with reasonable
behaviour: centered horizontally and sitting on the floor.

Fixed -warp to check compatibility: when test is definitive
we automatically change the mode (to EDGE or BOOM).

2004/12/16:

Worked on Boom level detection.  The new function will scan
through all the maps and check if they use EDGE and/or BOOM
line-types and sector-types.  I've also implemented a dialog
when the result doesn't match the current compatibility mode.

2004/12/15:

MP-Server: got it working again (albeit by a hair's breadth).
Fixed problems sending bot ticcmds to server and back.

2004/12/14:

Added X_OFFSET and Y_OFFSET commands to images.ddf.

Tidied up the swarm of warnings caused by changing the scale
fields in image_t to float.  Using floating point for screen
coords does make sense (especially since the coordinates are
in the 320x200 space, whereas the screen could be 1024x768).

Made the "Detail Level" option in the menu control the max
texture size sent to the GL (with some kludges for skies and
title backgounds).  Lower levels prevent texture thrashing
(big slowdowns) when using the Doom2 Retex Proj.  Added good
detection of narrow vs wide skies (use the aspect, Luke !).
Removed old hack-crap support for the Doom2 Retex Proj.

R_InitSprites is now a lot slower (due to the possibility of
sprites defined in IMAGES.DDF).  Hence updated the startup
progress bar with local sprite progress.  Also made the
glBSP progress fade out after a second, preventing the
problem where it just flashes on/off for a small wad.

2004/12/13:

Tackled bug #1066453 (scrolling sides of thick extrafloors).
Horizontal scrolling should be fixed now (it _adds_ the real
X offset to the dummy line X offset).  Added SIDE_MIDY special
which will add in the real Y offset too.  Thick extrafloors
using SIDE_UPPER/LOWER can only be scrolled by making the
linedef they're on scroll (dummy line has no effect).  Also
fixed the "LEFT" and "RIGHT" keywords (they weren't working).

Added SCALE, ASPECT commands to IMAGES.DDF.  Added function
to the epi::PNG code which reads the width/height/solidness
from a PNG file (it only has to read the header, therefore
should be much faster than doing a full load), and now the
w_image code can get the correct user image sizes.

IMAGES.DDF is now ONLINE !!

Created a ddfimage lump for the flats and textures in the
Doom II Retexturing Project.  Some images are alteratives,
so selected ones I liked (e.g. sky1_alternative).  There
were some flats which existed with/without the "flat-"
prefix, these also looked like alteratives.  I have also
adjusted the scaling factors, while *4 is the most common
factor some are *8, and a few are weird (PLANET1 is *7),
and a few also have different aspects (EXITDOOR).

2004/12/12:

Found the cause of facing the wrong angle when using -warp.
LibSDL is sending us a bogus mouse event at startup, as if
the mouse moved 512x384 (i.e. half the screen res).  While
this is really a bug in SDL, I'll add a workaround for it.

Fixed problem with single player "lag" (new network code). 

Updated rgl_unit code to handle additive lighting.  Also
added preliminary code to do multi-texturing, and I must say
that it looks very nice indeed, while still being close to
the old method.  Speed is a real concern though.

Updated the network code to recent protocol changes, and it
can connect to the server and start a game once more.  Made
the local UDP port number random (allows reconnecting to the
server).  We also ignore the loopback addr (127.0.0.1).

2004/12/11:

Tidied up pseudo-skybox code, doing the re-use optimisation
(i.e. top face same as bottom face in MIRROR mode) inside
w_image.cpp, and added support for getting the faces from
IMAGES.DDF (add "_N", "_E" etc to the base name).

Merged most of the W_ImageFromXXX methods into a single port
of call: W_ImageLookup(), which takes the type of image
required and some flags (e.g. one to allow a NULL return, and
another to require the exact type specified).  The method for
handling animations now ensures that only the same type of
images get animated (all flats vs all textures).

2004/12/10:

More work on dynamic lighting.  Fixed GL renderer to support
both lighting types (Linear and Quadratic) at the same time.
Got the image generation and size/intensity calculations to
be fairly correct.  Removed MAXDLIGHTRADIUS, now selecting
an appropriate value in R2_FindDLights().

For the Beta: made it show "Beta 1.29" in the top-right corner
(encourage people to use the full version when it's released).

Menus: made many vars/funcs static, and added prototype for
multiplayer setup menu (also doubles as "Leave Game" menu).

Tackled support for 24/32 bit rendering.

2004/12/08:

Worked on new dynamic lighting.

Created docs/tech/libraries.txt (keep track of dependencies).

2004/12/07:

Networking: quick description of tic handling (client-side).
There are three important variables:
    
	gametic : the tic (time unit) upto which the game simulation
	          has run (note that it increases during PAUSE and
			  menus).

	maketic : the tic upto which the local player has built
	          ticcmds (result of processing input events).

    lowtic  : the tic upto which we have got all the ticcmds
	          from all players (local and over the network).

This equation is invariant:  gametic <= lowtic <= maketic

The game simulation can run whenever gametic < lowtic.  When
gametic == lowtic, we must wait until lowtic increases (which
means we get at least one more set of ticcmds from everyone).

We cannot let maketic get too far ahead of gametic.  For one
reason: buffering requirements, the other reason is that the
simulation and on-screen view is getting too out-of-date for
the player to react properly.

Server-side is more complicated, since it must deal with all
players at the same time.  My mental image is like Tetris: we
require the bottom line to become full before we can send
those ticcmds to all the players and move on.  As in tetris,
when two lines are filled at the same time, we could process
them in one go.  (This analogy is a bit too simple, since we
must remember recent lines in case we need to retransmit them).

2004/12/05:

Fixed savegames for new player handling.  Removed spawnbot cheat.
Split demo code from g_game into new file e_demo.  Moved ticker
calls from e_net.cpp into e_main.cpp.  Handle PAUSE key in the
responder chain rather than as a special button in ticcmd (i.e.
disallow pausing in netgames).

2004/12/04:

Networking: removed unused 'ticdup' var.  Renamed the 'thinker'
field (player_t) to 'builder' (as it builds ticcmds, and the
term thinker implies playsim calculations).  Removed the drone
stuff.

Started reworking players: remove linked list in favour of having
"player_t *players[MAXPLAYERS]" (i.e. how it was before, which for
me is the most understandable way).  Made displayplayer and
consoleplayer integers.  Renamed playerstarts to coop_starts and
used the spawnpointarray_c.

Well, finished the rework but there are still some rough edges,
in particular I haven't tested savegames or demos yet.

2004/12/03:

Fix crash when playing in deathmatch mode (an earlier change of
mine caused the player object to become the [11] DM object).

2004/12/02:

Removed the last vestiges of fixed-point code, as well as the
table-driven sine/cosine/tan stuff.

2004/11/26:

Moved animation stuff from ddf_main.h to new file ddf_anim.h.
Moved switch stuff as well, into new file ddf_swth.h.  Moved
colourmap stuff into new file ddf_colm.h.

Added "USER" type for ANIMS.DDF, for animating the images
defined in IMAGES.DDF.

Split the input handling (G_BuildTicCmd) into a new file
e_input.cpp.  Removed the unused MOUSE_ACC stuff.  Reworked
mlook handling (mainly to get rid of the fixed point calcs),
made it work like horizontal turning.  I changed the ticcmd_t
format, hence old demos won't work anymore.  Made the mlooking
with keys be slow at first (like turning).  Removed the now
unneeded EBT_MLOOK constant.  An age-old problem with looking
up/down with the mouse in zoom mode (would only move in big
jumps) has been cured by these changes.

2004/11/25:

Support for a [SOUND_VOLUME] style.  Removed unused global
'inhelpscreens'.  Removed halo conversion stuff (w_image).
Added SMOOTH special to IMAGES.DDF.

Figured out why the current image system (w_image) is too
inflexible: it's the way caching is tied to having one big
image list.  So I think separating the caching logic from
the image loading and lookup logic is the way to go.

Tidied up some (awful) code in wi_stuff.cpp, and updated it
to use proper styles: [STATS] for single player and [NET_STATS]
for coop and deathmatch.

2004/11/24:

Updated background fillers (e.g. behind the menus) to use
styles.  Removed the "darken_screen" option, which was only
changeable via the config file.

RTS: allow lines to be extended by placing a '\' character at
the end.  It must be at the very end, any whitespace after it
won't work.  Also reworked RTS menus: (a) to tidy up and (b)
to support multi-line titles.  Split action definitions from
rad_trig.h into new file rad_act.h.

Implemented a new RTS command:

   MENU_STYLE  style_name

which sets the style for the SHOW_MENU command.  The default
style is [RTS_MENU].  The setting is local (specific to the
script which uses it).

2004/11/23:

Wrote font_c and style_c classes (and containers for them).

Investigated the variables "message_nottobefuckedwith" and
"message_dontfuckwithme".  The former is used to prevent the
current message from being overwritten by a new one (only used
for chat strings).  The latter seems to be there to force the
_next_ message to be safe from overwriting, but in reality
does very little in the current code.   ---->  Reworked.

Simplified some HU stuff (removed the 'on' pointers and the
laston, needsupdate fields).  Did same for status bar.

Started updating all text-writing code to use styles.  At first
I'm not worried about getting everything right, but to just get
everything compiling/working again, and make it correct later.

2004/11/22:

Removed the USE_GL define, once and for all.

Worked on using the fonts defined in FONTS.DDF.  Once issue that
popped up: the DDF parsing code should contain no engine-specific
code, yet having an API in fontdef_c for handling stuff like
StringWidth() seems very natural.  Hmmm...  I guess it needs to
be split (new font_c class contains the run-time API and cache).

2004/11/21:

Weapons: re-added crosshair support.  The following actions have
been implemented:

   SETCROSS(FRAME)    : crosshair jumps to the given frame
   TARGET_JUMP(FRAME) : crosshair jumps IF player has a target
   FRIEND_JUMP(FRAME) : crosshair jumps IF player target is a friend

Friendly monsters: made monsters on different sides attack each
other (revert to the logic used in EDGE 1.27).  UNTESTED.

Prototype png support for images.ddf.

2004/11/20:

Removed the "CONSTANT" dlight type, which was not very useful,
and I only want to deal with two different types in the code
(Linear and Quadratic).

Images.ddf: wrote parsing for IMAGE_DATA command.  Found out why
the dlights/shadows were producing some horizontal and vertical
bands: the edges of the image were not totally clear, and also
mipmapping needs to be disabled on them (otherwise the reduced
images will get edges which are not totally clear).

Styles.ddf: added "HELP" group (others are TEXT, TITLE and ALT).

Worked on new dynamic lighting.  Made dynamic lighting option have
three values: OFF, ON and COMPAT.  Got the new dynamic lighting
working on walls.

2004/11/18:

Added four new ammo types: DAGGERS, ARROWS, TORPEDOES, CRYSTALS
(names influenced by Heretic/Hexen/HacX).  That brings the total
to twelve, which as far as I'm concerned is enough.

Increased limit on holdable weapons from 32 to 64.
Tested that these changes didn't break savegames -- OK.

Images.ddf: added generators to w_image code for the BUILTIN
types (needed for the new dynamic lights and shadows).  I'm going
to make the new dlights optional (i.e. off/on/compat), and remove
the old ones in the release after 1.29.  That way mod makers get
a chance to try the new ones and update their mods if they want.

2004/11/17:

Added gameplay option to prevent automatic weapon switching
when getting a new weapon or fresh ammo -- unless the current
weapon you are holding is unable to fire/reload.

Worked a bit on images.ddf.

2004/11/16:

Fix for Bug #1065988, where damage greater than 1000 could hurt
even invulnerable/god-mode players.  I'm pretty sure the check
(which exists in the original Doom source) was there to allow
telefragging, hence I've added a new function P_TelefragMobj()
which by-passes the DamageMobj() step and uses KillMobj().

Began working on a _minimal_ IMAGES.DDF.  It will only support
solid colours and a few built-in types, in particular a lighting
image which will be required for the new dynamic lighting method.

2004/11/15:

Weapons: added DISCARD and SECDISCARD states.  They are similar to 
the PARTIAL special: if you press the reload key with a half-empty
clip (i.e. neither empty nor full), then the clip is discarded and
the DISCARD states are entered.  These states must end with the
CHECKRELOAD action to cause the weapon to be reloaded.

Implemented weapon IDLE states, with new commands IDLE_WAIT and
IDLE_CHANCE to control how long to wait.  After the full idle wait
time has elapsed, the chance is re-checked every (idle_wait / 10)
seconds.  For example, "IDLE_WAIT=20" means the random test is
tried at 20 seconds, 22 seconds, 24 seconds, and so forth, until
the test succeeds.  When IDLE_CHANCE is 100%, it happens first go.
The IDLE states are only entered from READY and EMPTY states.

Added RELOAD states to THINGS.DDF, where the RELOAD_SHOTS command
gives the number of shots, and the RELOAD_CHECK action must be
used to check if the monster needs to reload.  Also, if the player
thing has reload states, it is entered when his weapon reloads.

Disabled the "ddf property" rubbish (which I added ages ago) when
#version is < 1.28.  May it die for good one day.

2004/11/14:

Worked on parsing code for Styles.ddf.

Found a design issue with styles: on the one hand, being able to
redefine every screen to something different is necessary, on the
other hand, being able to share all the common features in a single
DDF entry would be good (save a lot of duplicated DDF).  Templates
would be ideal here, but it doesn't make sense to implement them
before Andrew Baker's DDF parsing rewrite.

After making a comprehensive list of required styles, a pretty good
solution to the above became apparent.  There are two areas where
sharing is most useful: the option screens, and menu screens (such
as load/save, episode choice, RTS menus).  There will be two generic
styles for these: [OPTIONS] and [MENU].  The specific styles (such
as LOAD_MENU) will be omitted from our standard DDF, and when the
code doesn't find it, the generic style is used instead.

2004/11/13:

There were some places where a weapon was referred to by an integer
instead of a pointer (upgraded_weap, benefit.subtype, cond.subtype).
Replaced these with a pointer to the weapondef_c, consistent with
how other stuff in DDF is referenced.  I think ONCONDITION<weapon>
is finally fixed now.

Added weapon special "ANIMATED" which allows the UP and DOWN states
to be animations (instead of moving the sprite up/down).  This
requires the last frame to use the RAISE/LOWER actions (no others).
Implemented weapon WARMUP and SECWARMUP states.

Improved the way upgrading / removing an in-use weapon works (made
it lower as normal).  Added proper check for upgrades of upgrades.

Worked on parsing code for Fonts.ddf.

2004/11/12:

Weapons: decided that CLIPSIZE=1 could make sense, hence the default
value specifying a non-clip weapon is now ZERO.  Made sure that when
you get both a clip weapon and some ammo in a pickup item, that the
ammo will fill the clip if possible.  Reworked the code for switching
to a new weapon when you pickup a new weapon or fresh ammo, and
decided that the NO_SWITCH special should prevent switches based on
new ammo, but not affect switches when getting a new weapon (I think
the latter would be better as a gameplay option).

2004/11/11:

Added reload key for weapons, with a NO_MANUAL weapon special which
disables it for a weapon, and a PARTIAL special which allows it to
partially fill a clip.

2004/11/10:

Weapons: decided that instead of having sa_XXX fields for second
attack information, combining them with the first attack into a
two-element array (e.g. ammo[2]) will simplify the code.  Worked on
merging the weapon actions, e.g. A_ReFire and A_ReFireSA are just
stubs which call DoReFire(mobj, atk_num).

Added SEC_SPECIAL command to weapons.ddf.  These specials apply to
the second attack.

Implemented the NO_TRIGGER and FRESH weapon specials, the former
prevents reloading clip weapons by pressing fire, the latter allows
weapons to reload automatically when fresh ammo is picked up.

Fixed a subtle bug with weapons and #CLEARALL.

2004/11/09:

More weapon stuff.  Noticed some mods using AMMOPERSHOT = 0, and made
the parser check for this and set the ammo type to NO_AMMO.  Also
noticed that NO_AMMO and CLIPSIZE should work together: it simply
means that the clip can _always_ be refilled.

2004/11/05:

Started reworking weapons and clips, with these ideas in mind:

(a) if clip_size == 0, weapon feeds directly out of the "ammo bucket",
    otherwise weapon holds some ammo in it (clip_size), even when not
	in use.  For ammo in the HUD: total ammo + ammo in current clip.

(b) the clip is filled when entering the reload states.  When there are
    no reload states, clip gets filled automatically.

(c)	Reload states are entered: by CHECKRELOAD action, when pickup up
	new ammo which can fill an empty clip, and by manual reload key.

(d) Picking up a new weapon (especially when it comes with ammo as
    a BENEFIT) should NOT enter reload states.  EDGE should not switch
	to the new weapon if there is no ammo for it.

Second attacks are causing some headaches...

2004/11/04:

W_Image code: added a semi-permanent "shrink buffer", use for the
intermediate shrunk-down images sent to the GL (mainly mipmaps).
This saves the overhead of a new/delete pair for every image.

Boom compat: bit 8 of the thing options (from the WAD) should be
zero, otherwise indicates that other (new) flags may contain junk.
Hence renabled support for the FRIEND flag.

2004/11/03:

Debugged the new line-to-line teleporting code.

2004/11/01:

Boom line/sector types: improved the way these are handled, moving
the actual containers into ddf_boom.cpp and adding an API for
checking if a number is a Boom type, and for clearing the cache.
The containers are now static in ddf_boom.cpp.

2004/10/31:

Created better algorithm for converting a colourmap into a single
RGB colour (V_GetColourRGB).  Made the invulnerability and night
vision effect use the correct colourmaps (ALLWHITE, ALLGREEN).
Noticed the sky wasn't affected by night vision -- fixed.

Made code mark the sectors defined externally or in EDGE.DDF as
Boom conflicting when the number is a Boom generalised type.

Found a problem with DROPITEM() action: it takes a thing name in
brackets, but since it can be used in attacks.ddf (which is parsed
before things.ddf) the thing may not be loaded yet.  Therefore it
needs to remember the name and look it up later, which I've done
using a new mobj_strref_c class.

Found a nasty gotcha with strent_c: I added a constructor taking a
C string, making it use Set().  Set() calls Clear(), which tries
to delete[] the data pointer if already set.  Problem is, the data
pointer has never initialised, could be random rubbish --> CRASH.
Sometimes C++ is a real joy.

2004/10/30:

Made a "SPOOKY" wipe method.

Removed FIRST_SILENT_TO_WEAPON and SECOND_XXX flags, instead allow
a SILENT_TO_MONSTERS flag in the attack -- a little more elegant
and easier to explain.  Note: won't work with attack names given
in brackets in the states, like ATTACK(FOO), since the noise alert
happens when the weapon is fired, not when the attack is launched.

2004/10/28:

Reworked the WHEN_APPEAR parsing to allow more readable values, in
particular: 
	(a) support a skill range, e.g. "3-5",
	(b) can have just skill values, "2:4" same as "2:4:sp:coop:dm",
	(c) can have just net modes, e.g. "dm" implies "1-5:dm",
	(d) prefix with '!' for negation: "!dm" means "1-5:sp:coop".

Using '{ }' comments in DDF and ';' comments in RTS deprecated,
since these characters could be useful in other contexts (curly
brackets especially useful for scoping).  We show a warning when
#version >= 1.29, maybe becoming an error later (#ver >= 1.30).

When reading DDF/RTS in external mode (-ddf option specified),
prevented the error message if the file doesn't exist, instead we
simply use the one in EDGE.WAD.  This allows us to create new ddf
files without worrying about breaking old external-based mods.

2004/10/27:

The EPI file_c Read/Write functions were returning different values
in Win32 and Linux (0 was success in Win32, but failure in Linux).
Standardised that by replacing return value with 'bool'.

Worked on EPI WAD class, and reading code is now in place.

Removed unused functions W_RawLumpInfo and W_AddDynamicGWA in wad
code, and made W_ReadLump internal.

Implemented anims.ddf SEQUENCE command.

Tried converting some of the elements in st_stuff.cpp into HUD.DDF
definitions.  The result was something a bit different to other ddf
files, with lines of the form "Variable_Spec = Display_Spec".  It
shows promise...

Another idea was STYLES.DDF, which works like CSS (Cascading Style
Sheets, for HTML).  For example the style [GAMEPLAY_MENU] would set
the text font & colour, background image (or colour), even the
sounds, but what it DOESN'T do is specify the menu itself.

2004/10/23:

Finished epi::angle_c class, with built-in test suite.

2004/10/21:

The reworking of teleport code (with support for line-to-line mode)
is finished.  That's the easy part.  Now the hard part: testing that
all the combinations of teleport specials work properly...

2004/10/20:

Began work on new EPI angle grinder, err... class.

Improved the "DOORS" wipe (split vertical quads into 5 pieces).

2004/10/19:

Replaced old m_swap endianness handling (SHORT and LONG macros) with
the new EPI versions EPI_LE_S16, EPI_LE_U32, and so forth.

Wrote EPI assertion code (epiassert.cpp/h).

Found out why Andrew Baker had problems throwing an error_c in the
linux filesystem module: for some God-knows reason, having a copy
constructor _without_ a "const" parameter causes GCC to complain.
Put a const in (or take the constructor out), and it works.  Weird.

BTW I also learned that throw() after a method actually means it
does _NOT_ throw any exceptions.  I assumed the opposite, tsck tsck.

Integrated two classes from my old ZCPPLIB code into the EPI: colour_c
is for normal RGBA colours, and hsv_col_c is for Hue/Saturation/Value
colours.  The filenames begin with "math_", and I'm planning on adding
more mathematical classes into the EPI (angles, vectors, etc).

2004/10/18:

Wrote epi::bytearray_c class which is a simple growable array of
bytes, needed in some places to read files or build them in-memory
for writing later.

2004/10/16:

Been thinking long and hard about the Boom compatilibity problem (in
that some of our sector types conflict with the Boom generalised ones).
For a deeper understanding, I created a table showing the conflicting
types side-by-side, which proved to me that getting it wrong can mean
maps becoming unplayable (e.g. swimmable water --> damaging air).

So now I'm sure that we need to support both.  The best we can do is
try to determine the "mode" of a level (also the WAD it comes from),
and when this differs from the current compatibility mode, pop up a
dialog box and ask the user (with an appropriate default choice).

Task #98107 on SourceForge has more details.

I've also been thinking about the new WAD II system, and just can't
get past the fact that creating our own pack/unpack utility is going
to be a lot of work, especially one that has a GUI interface, since a
command-line tool will put a lot of people off.  Last night I looked
for an open-source GUI archive utility we could base it on, but found
nothing that worked on Windows.  Hmmm...

Back to code monkeying: added a Cmp() method to epi::timestamp_c, and
simplified the comparison operators using it, and replaced use of the
old i_time_t typedef with the new EPI one.  Started making an EPI
class for handling WAD archives, (a) it would be very useful to use
in other programs (e.g. I'd like to convert GLBSP and DEH_EDGE to the
EPI), and (b) it'll be a good experiment for a WAD II API.

2004/10/15:

Made GLBSP and DEH_EDGE interface code print any failure error message
into the EDGE.LOG file.

2004/10/13:

Made WAD code recognise colourmap lists (C_START .. C_END).

2004/10/08:

Tidied up startcode[] array, removing the message field (do it in the
initialisation functions instead), and making their return type void
instead of bool (since nothing ever returned false).  Also fixed the
mucked-up newlines.

The GLBSP interface code (l_glbsp) now creates a good message line
for the progress screen (but it isn't shown yet).

Started work on Boom's line-to-line teleport types.  New keywords for
TELEPORT_SPECIAL: "LINE", "REVERSING" and "SILENT".

2004/10/07:

Worked on Boom linetypes 211 and 212: instant platform TOGGLE.

2004/10/05:

Made GWA building occur during W_InitMultipleFiles() for any wad that
has levels but lacks GL nodes (either internally or in a companion gwa
file).  It also uses the new progress display.  Much nicer I think.

Finished adding native DeHackEd/BEX support to EDGE.  It handles both
DEH patch files (with or without the -deh option) and DEHACKED lumps.
The HWA file is only created if it doesn't exist or the time stamps
indicate the source has been modified more recently.

Damn it !  Boom handling of DEH files is lax, and doesn't require the
proper header line ("Patch file for DeHackEd v#.##").  Will need to
modify DEH_EDGE to handle these non-standard files.

Disabled the Linux music server code, which has been obsolete for a
long time now.  It will be replaced soon by Humidity.

Optimised the W_CheckNumForTexPatch() function, by keeping track of
what kind of data each lump is (pretty rough, we only need to know
about patches, sprites and flats), and using that value when sorting
the lumpmap[] array.  Startup time is *much* faster now.

2004/10/04:

Added an extra startup progress display for GLBSP building nodes.

Added code to w_wad.cpp to detect level markers ("MAP03" etc), based
on the lumps that follow (e.g. "THINGS" is always first).  This will
be used to detect wads that have missing GL nodes.

2004/10/03:

Reworked w_wad code to replace some of the zone stuff (Z_Resize) with
EPI equivalent.  Did the same for sprite stuff in r_thing code.  Done
the w_texture code too.

Was going to replace the remaining Z_Resize stuff in w_wad.cpp, but
like Andy Baker has noted, there's not much point when the new WAD II
system means that big chunks are going to be rewritten.

2004/09/29:

Added temporary kludge to make Berserk powerup last a level.

2004/09/28:

Began work on allowing "loose" filenames, i.e. being able to specify
wads without requiring the -file parameter.  Allows drag-n-drop.

Added support for -deh option (no conversion yet) and integrated the
handling of -script to match -file, causing the scripts to be parsed
during W_ReadDDF (i.e. at same time as RSCRIPT lumps).

2004/09/27:

Made spawned monster (via an attack) keep ambush status of parent,
as requested in RFE #1033899.

Added FIRST_SILENT_TO_MONSTERS and SECOND_SILENT_TO_MONSTERS weapon
specials, i.e. splitting the SILENT_TO_MONSTERS flag (still there)
into two separate ones for finer control.  Closes RFE #1005856.

Added an EXPLODE_RADIUS command (Things and Attacks) which says that
an explosion will have the specified size.  [Normally an explosion
has the same size as the damage amount].  Closes RFE #915715.

2004/09/23:

DEH_EDGE: finished plug-in stuff, tidied up, and released V1.2.

2004/09/22:

DEH_EDGE: tested whether using the plug-in multiple times produced
the correct results (i.e. no interference from previous runs).  It
failed, and tracking down the problem took quite a while.  Started
work on fully supporting the plug-in error API.

2004/09/20:

Bug #1026649: Fix for texture mis-alignment when texture height is
not a power of two and sidedef's Y offset is negative.  Hopefully
doesn't adversely affect anybody's Edge-specific add-on.

Tidied up and checked in the specifications of the WAD-II system.

2004/09/19:

Allow "KEY_" prefix in DDF for green card and skull keys.

2004/09/12:

Removed the rgb_32k array (previously used for making translucency
tables for the S/W renderer).  This should speed up start times too,
since computing this table was an expensive operation.

DEH_EDGE: more work on the plugin, made it compute the percentage
completion for the progress bar.  Got a prototype working of EDGE
converting a DEH lump from a wad file, then loading the new DDF.

2004/09/11:

Implemented things.ddf "DIE" action (for Boom/MBF compatibility).

DEH_EDGE: Worked on making the code embeddable into another program
(in particular: EDGE).  Began work on EDGE side (l_deh.cpp), and got
a simple prototype working (with hardcoded filenames).

2004/09/04:

Made death watching smoother.

For the sky box generation, made the sampling use bi-linear filtering,
which further improves (if only slightly) the way the sky looks. Added
another sky stretch mode "MIRROR", which mirrors the sky (vertically)
at the horizon.  Fixed the horizontal sky alighment.

Backwards compatibility: when version < 1.29 and the BERSERK powerup
is used, automatically add the switch-weapon PICKUP_EFFECT.

2004/09/03:

Removed glEnable(GL_TEXTURE_2D) from w_image, which AFAICT from the
OpenGL specs is not necessary when uploading textures to the GL.

Modified epi::basicimage_c class to support palettised images (one
byte per pixel).  The palette is not stored in basicimage_c, since
this format will only be used internally by w_image code.

Made sky generation (and pre-caching) occur at level load, to prevent
the delay from happening in-game.

Began more reworking of the guts of w_image, this time to removing
IMG_Block in favour of using the epi::basicimage_c class.  Righteo,
most of that is done, and I also added support for converting the
Doom Retexturing Project skies, but they came out up-side-down.

2004/09/02:

Replaced CRC32_* functions (m_crc32) with the epi::crc32_c class.

Removed I_SetPalette and I_Colour2Pixel from the system interface
(not needed anymore).  Also removed I_GetTruecolInfo and the colour
shift calcs (SDL/i_video).

Merged PIT_RadiusAttack and PIT_SphereAttack (p_map) into a single
routine (the code only differed by the distance calc).

Implemented the SIDE_IMMUNE flag for DDF: when set, that creature will
be completely immune from "friendly fire" (bullets, missiles and
explosions from someone on the same side).  Also made the aiming code
ignore things on the same side (unless it uses FORCE_AIM, which fixes
a problem with the chain-saw).  Also added an ULTRA_LOYAL special,
which prevents monsters from retaliating if hurt by friendly fire.

2004/09/01:

Added "Sky Stretch" option to video menu for the new sky conversion.

Pulled out the "Post" image type (w_image) which was only required by
the now absent column drawing functions.  Also simplified the w_image
API, e.g. you don't need to specify the mode anymore to W_ImageCache
(all of the code uses only IMG_OGL now).  I'm planning to rework the
guts of w_image.cpp, use a class for "Block" images (palettised, one
byte per pixel) and the epibasicimage_c class for RGBA images.  This
will simplify things even further.

2004/08/31:

Improved the sky box conversion algorithm, generating six real sides.
Applying a power function to the vertical dimension seems to produce
better results for most skies (power value 0.7), though this should be
controllable with a option in the video menu.

2004/08/30:

Made filenames with embedded spaces usable in response files, they need
to be surrounded with double quotes, like "C:\doom stuff\foo.wad".

The DDF parser now disallows angles > 360. 

Started reworking GL sky box to (a) handle both pseudo- and real sky
boxes, (b) look better, (c) work with the Doom Retexturing Project.

2004/08/29:

Missing files (given with -file) will now produce an I_Error instead of
simply printing a warning, since IMO a missing file is too significant
to ignore (I've been bitten by this before, wondering why something was
not working, only to find out the filename was wrong).

Added sky-flooding emulation to the GL renderer.  Removed the old
(dead) bits of code implementing alternative sky drawing methods.

Implemented Linux CD handling (SDL/i_cd.cpp).  It probably works, my
laptop (an iBook) requires special handling for the CD drive (you need
to transfer the audio to the sound card yourself) which I haven't
implemented (and don't intend to), but the CD spins up properly and
there are no errors returned from SDL.  What is lacking though is
volume control.

2004/08/28:

Fixed NO_AUTO_SWITCH weapon from switching when you have no ammo and
pickup some new ammo.  Whether it should go into reload states (maybe
depending on some other flag) remains to be forumed.

Split thing handling code in rgl_bsp.cpp into new file rgl_thing.cpp,
and header file rgl_thing.h.  Moved weapon sprite handling there too.

Implemented basic RTS menu system, with the following new commands:

	SHOW_MENU      title option1 option2 ...
	SHOW_MENU_LDF  title option1 option2 ...

	JUMP_ON  MENU  label1 label2 ...

The RTS menu will pause the game until the user presses a valid number
key.  The RTS menu currently prevents savegames - maybe this makes sense,
otherwise the menu info will need to be added to the savegame system.  By
the way, the MENU keyword in JUMP_ON is a variable name (the only one
supported at the moment), in the future we'll have user variables too.

Reworked the screen-size code, pressing '+' and '-' now toggles the
HUD to use.  [In future: the huds will be found in HUD.DDF].  The
routine R_FillBackScreen() therefore was no longer needed.

Rewrote RAD_CollectParameters() to treat everything between matching
'(' and ')' as a single token (these will be expressions).

2004/08/26:

Split GL occlusion code into new files: rgl_occ.cpp/h.  Split parts
of rgl_defs.h into rgl_wipe.h and rgl_sky.h and rgl_unit.h.  Added
new files for powerup effects: rgl_fx.cpp/h.

More work on startup, moving a bunch of initialisation functions in
e_main.cpp into the startcode[] array.  Removed the assembler stuff
(I_RegisterAssembler and I_PrepareAssembler) which are not needed
anymore.

Linux: remove mouse grab when I_Error() is called and DEVELOPERS is
defined.  Linux makefile now links with the FLTK GUI library, and
the I_Error() routine uses it to produce a pop-up message dialog.

Discovered a problem: in both GNOME and KDE desktops, running Edge
by double-clicking it sets the current directory to the user's home
directory (NOT the directory containing the executable).  For the
time being, using the argv[0] directory will be sufficient, though
long term it probably should be configurable (e.g. find IWads during
installation).

2004/08/25:

Simplified startup logo.

Added 'hyperflags' field for mobjs, since the other two were almost
full.  Added new item special FORCE_PICKUP.  Fixed problem with the
cmdline options -width and -height (etc), as SetGlobalVars needs to
be called directly after M_LoadDefaults.

Began work on new system for powerup effects (and other stuff).
The DDF command is like this:

   PICKUP_EFFECT = XXX(1), YYY(blah);

The following keywords are planned:

   SWITCH_WEAPON(name)
   POWERUP_name(slot#)
   SCREEN_EFFECT(slot#, time)
 
The screen effects for powerups will be controllable.  There will
be a number of slots (e.g. 30).  Initially the effect in each slot
will be hard-coded, but later they will be specifiable with DDF.
Higher numbered slots override lower numbered slots (unless the
effects can co-exist).

Powerup effects and SCREEN_EFFECT both produce the same result,
the difference is that POWERUP_xxx() links the timing of the effect
(e.g. green tint for the suit) with the powerup countdown, whereas
SCREEN_EFFECT will run independently.  The latter is needed to make
BERSERK last the whole level (but not the red tint).  Also planned
is a SCREEN_EFFECT command for RTS.

Backwards compatibility will be retained by some code that checks
the #VERSION of the DDF, when < 1.29 it will add the equivalent
effects (e.g. SWITCH_WEAPON(FIST) for the berserk).

2004/08/22:

Improved the startup progress screen, added an EDGE logo, and
removed the code snippets that printed dots.

Added new DDF benefit: SWITCH_WEAPON(XXX).  Updated our DDF so
the BERSERK powerup uses this, and removed the hard-coding.

Added new weapon special: NO_AUTO_SWITCH, which prevents a new
weapon being selected when you run out of ammo.  It has a problem
though: picking up new ammo can cause a weapon switch...

2004/08/21:

Send RTS tips to the console.  It didn't work that well with
scripts that repeat a message (e.g. QDoom), as the console got
clogged, so repeated messages are not sent.

Startup reorganisation:

Moved M_LoadDefaults to run much earlier on (before DDF_MainInit).
The external DDF reading now happens in a separate routine, and
runs just after W_InitMultipleFiles (which loads the DDF lumps
internal in EDGE.WAD).  Other initialisation functions also got
moved (V_ColourInit, W_InitImages, RGL_Init, etc).  I've also
split the reading of internal DDF lumps out from AddFile (from
W_InitMultipleFiles), in order to have images available to draw
some text and a progress bar while loading the DDF (which is the
most time-consuming parts of EDGE's initialisation).

Made the RTS parsing routine work the same as the DDF ones (i.e.
if data pointer is NULL, load from external file).  Merged the
internal and external DDF/RTS loaders into one: W_ReadDDF().
Got an ultra basic progress bar working.

2004/07/29:

Been working on removing the S/W renderer and simplifying the
tangled web of code that surrounded it.

2004/07/22:

Found the Scythe MAP10 problem (Bug #983214) where the
BOSS_BRAIN was not being killed by barrels.  It required
that the DDF "BOSSMAN" special be split into two new
specials: "EXPLODE_IMMUNE" and "ALWAYS_LOUD".  (The
explosion immunity was the problem).

GL Renderer: changed FAR distance to be 200000 instead of
32000, in order to fix clipping problems (esp. the sky) on
really huge levels.  If any Z-buffer artifacts show up, then
I will need to make the FAR distance dependent on the level
size (so the artifacts won't show up on normal-size levels).
The required value is 4.0 * max_dist (due to the sky).

2004/07/20:

Started work on the Timidity back-end to Humidity (required
to get good quality music support under Linux). I'm still in
the process of refactoring the code, e.g. making it C++, and
have only taken baby steps to make it a proper back-end.

2004/07/17:

Got the Win32 support in the music library (Humidity) working.
It's based on the code from EDGE (win32/i_mus.cpp).

2004/07/14:

Added support for V3 GL-Nodes to EDGE.  Deus Vult now works.

2004/07/13:

Added preliminary JPEG load/save code into the EPI.

GLBSP: worked on producing better messages when levels fail to
build, and implemented the V3 GL-Nodes (writing the lumps).

2004/07/12:

Fix for inconsistent teleporting (Bug #958402).

Worked on Version 3 of GL-Nodes specification, allowing those
insanely complex levels to be built.

2004/07/10:

Added PNG loading code into the EPI.  It's not complete, in
particular it cannot save, but it's a start.  Made a prototype
of using the images from the Doom Retexturing Project.

2004/07/05:

DEH_EDGE: implemented BEX support: the [CODEPTR], [STRINGS],
[SOUNDS], [MUSIC] and [SPRITES] sections.  Made the frame code
able to handle A_RandomJump forks.  Added support for some of
the BOOM/MBF actions: A_Stop, A_Detonate, A_PlaySound, A_Turn,
A_Face, and A_LineEffect.

2004/07/04:

Made a prototype of new dynamic lighting using the multi-pass
rendering code.

2004/07/03:

Fixed crash loading a level with dynamic lights when the option
for dynamic lighting has been disabled (hence blocklights was a
NULL ptr).

Worked on adding multi-pass rendering to rgl_unit, and used it
to make a prototype for better shadows under things.

2004/06/24:

Fixed texture system to look for patches _first_ in the patch
directory, secondly sprites, _then_ any other lump. Bug #972899.

2004/06/23:

Made image system check for bogus columnofs[] values.
Updated w_wad code to remember the "patch list" (lumps in between
P_START and P_END and their lax equivalents).

2004/06/05:

Added 12 STEALTH monsters (types 4050 to 4061) into THINGS.DDF
(for Boom compatibility).

2004/06/03:

Fix for non-power-of-two-width textures in GL.

2004/05/31:

Fix for crouch bug (unable to stand back up).

2004/05/29:

DEH_EDGE: worked on supporting text strings from the
old binary format (patch format 4).  Implemented being
able to load multiple patch files.  Added option for
the EDGE version, defaulting to 1.28.

2004/05/28:

Made DecideMeleeAttack() not require an attack, for
compatibility with original Doom.  Also optimised the
use of P_CheckSight() in the melee and missile deciding
functions.

DEH_EDGE: Determined the positions of known text strings
within the text area of binary DEH patches for DOOM 1.666
and 1.7, and added some extra strings for BEX compat.

2004/05/24:

* EDGE 1.28 was released *

2004/05/19:

Fixed GL bug where sky was flashing white when changing
gamma (etc).  Happened because the W_ImageCache() can do a
glDisable(GL_TEXTURE_2D).

2004/05/16:

Oops, began changing the use of (int)floor(XXX) to be
(int)(XXX) -- removing the floor() -- but of course this
is wrong !!  Floor() is different from truncation.

Renamed FL_ROUND to I_ROUND (the result is integer) and
added a new macro I_FLOOR.

2004/05/14:

Changed the deltaviewheight handling in p_user.cpp back to
be like the original Doom code -- testing on E1M1 verifies
that it does indeed work better.  Bug #949650.

Shortened the jump delay in our DDF.

2004/05/13:

Looked for issues with floating point truncation (the C/C++
standards specify that this happens when casting to int,
something I never realised before).  Introduced FL_ROUND()
macro -- though better mechanisms will be coded after 1.28.

2004/05/06:

Updated the README.1ST file with v1.28 information.

2004/04/30:

Did some work on Linux EPI functions (directory handling).

2004/04/29:

DEH_EDGE: new code to determine if a thing is a monster (add the
"MONSTER" special which EDGE requires), based on statistical
analysis of several major DEH patches (Batman, Mordeth, etc),
as follows:

    SOLID:      yes 98/99, no 89/180 --> factor 25
    SHOOTABLE:  yes 99/99, no 27/180 --> factor 72
    FLOAT:      yes 17/99, no  3/180 --> factor 2

    painstate:  yes 96/99, no  3/180 --> factor 91
    deathstate: yes 99/99, no 27/180 --> factor 72
    raisestate: yes 56/99, no  1/180 --> factor 31
    misl/melee: yes 97/99, no  5/180 --> factor 91

    A_Chase:    yes 99/99, no 21/180 --> factor 78
    A_Fall:     yes 83/99, no 10/180 --> factor 61
    speed > 0:  yes 97/99, no  8/180 --> factor 87

    Score range for monsters:     425 to 608
    Score range for non-monsters:   0 to 315

(Score = the sum of factor values).
(Automatically excluded: Pickup items, Missiles).

2004/04/27:

Rewrote P_ActLookForTargets: fixing a bug (a friendly monster
could become it's own supportobj), ignoring anything that isn't
a monster or a player, and most significantly _never_ targeting
a thing on the same side.

2004/04/22:

Worked on flat-flooding emulation for GL mode.

2004/04/20:

Worked on emulating the deep-water trick (in GL mode).
glBSP required some changes too.

2004/04/14:

Player spawning: rely on the spawnpoint.info field rather than
use DDF_LookupPlayer().  Allows different levels to use different
player entries.  Later on, DDF_LookupPlayer could be removed.

Made text drawn in resolutions less than 640x400 look better
(1:1 scaling), and fixed the awful looking "Chunky Text" problem.

2004/04/12:

Fix for NightVision in GL, which didn't light everything up.
Fix for console which appeared behind the menus (but ate keys).

2004/04/01:

GL initialisation: detect card and enable specific workarounds,
for example: set the DUMBSKY mode for Voodoo3 cards.

2004/03/30:

Implemented SKIP_ALL argument to RTS GOTOMAP command.  It causes
the intermission states and any pre/post finales to be skipped.
(It's a bit hacked in due to time constraints).

Fixed up handling of obsolete commands (etc) in DDF and RTS, in
particular disallowing them when #VERSION 1.28 or higher is used.

Removed 8-bits modes from table in SDL video code when using GL.

2004/03/15:

Implemented DUMBSKY console variable (-dumbsky option) for GL.

2004/03/14:

Fixed (properly) the scrolling-gets-fucked-up bug.  Reworked S/W
sky handling again, because it moved out-of-sync with the level.

New warning system for DDF/RTS: when #VERSION is 1.28 or higher,
default is to always produce a fatal error [Later on: maybe pop up
a dialog box].  Mod makers can use the -lax option to ignore them
(get all warnings at once).

2004/03/13:

Flat-flooding in GL: the "Deep Water" effect finally makes sense
to me.  It doesn't require missing lowers (HOM) at all.  In a
nutshell: during rendering, the self-referencing linedefs are
completely ignored, hence it's as if the outermost sector covers
the whole area, and the floor is drawn accordingly.

2004/03/12:

Worked on improving pseudo skybox in GL mode.  Force smoothing on
sky textures.  Fix lines by using GL_CLAMP_TO_EDGE extension.

2004/03/11:

Fixed I_PathIsDirectory() under Linux, properly this time.

Worked on preventing sky repeating (vertically) in S/W mode.

2004/03/07:

Fixed issue of player sprite not walking, also updated player DDF
to use CHECKMOVING in all CHASE frames (as per original Doom), and
removed #CHASE redirection at end of PAIN frames (looks stupid).

Added #VERSION directive for DDF files, and updated the code for
RTS scripts.  Parsing only, it has no effect yet.

2004/03/06:

Small tidy-up of status bar code: removed the never used 'refresh'
parameters (st_lib), and global stbar_update variable (st_stuff).
Also added fix for colourmaps changing one frame too late.

Implemented CAST_TITLE command for things.ddf, used to select the
message in LDF during the cast screen.  Updated our THINGS.DDF.
Added support into DEH_EDGE.

2004/03/05:

Reorganised the docs/ directory.  Fixed changelog numbering scheme.

2004/03/04:

Implemented scaling for TIP_GRAPHIC: a fourth parameter can be given,
a numeric value: 1.0 is normal, 0.5 is half size, etc...  That is
consistent with the sprite scaling commands in DDF.

2004/03/01:

Fixed bug with X offsets for flipped sprites.

2004/02/20:

Made sprite name "NULL" be hard-coded to an empty image.  Reworked
things/weapon sprite checking code to allow NULL sprites.

Removed all MP3 code.

Indented all remaining two-space code.

2004/02/15:

RTS SPAWNTHING: when thing is unknown, show warning instead of error.

2004/02/14:

OpenGL: implemented pseudo-sky-boxes (converted from sky image).

2004/02/10:

Reworked armour pickups, so that good armour "upgrades" lower
class armours (as per discussion on Forum).

S/W Renderer: added fix for sprites and masked textures which
contain posts > 128 pixels high (limitation of the column drawers).

OpenGL Renderer: implemented the Pixelfade wipe.

2004/02/09:

Fix for bug #889374, where add-on textures were causing EDGE to
crash under windows.  Turned out to be an erroneous Z_Free() in
w_texture.cpp when detecting duplicate textures.

Reworked handling for transparent doors yet again.  Lots of places
in Whell-of-Time Doom where showing HOM instead of being see-thru.

2004/02/07:

Screenshots: only call M_ScreenShot() during E_Display, so we know
that the screen is in a savable state.  Also fixed RGL_ReadScreen()
which needed to turn the image up-side-down.  Closes bug #889474.

2004/02/04:

Fixed crash when idcleving from extrafloor level to non-EF level.

Added options -(no)lighting and -(no)colormaterial, and more
importantly console variables "vertexarray", "lighting" and
"colormaterial".  These help track down issues with GL drivers.

2004/02/03:

Added "AMBUSH" special for things.ddf.  Uses the pre-existing
MF_AMBUSH mobj flag, no new code added.

2004/02/01:

Weapon code: reset flash psprite when bringing up a new weapon.
Controls run-away flash states.

The DEH->EDGE converter is more-or-less finished.  Lots of bug
fixing still needed though.  To handle A_KeenDie actions, had to
create a potentially-huge RSCRIPT lump (with ONDEATH XXX commands)
for every monster using A_KeenDie -- horrible.

2004/01/29:

Fixed potential crash when non-player thing has the PICKUP special.

2004/01/26:

Fixed problem with GL's 1D occlusion buffer.  Turns out that making
the range a "little bit wider" in the test function is *not* a good
idea.  In other words: only test what you would set.

Investigated previous idea of flat-flooding in GL.  No good.  The
deep-water effect relies on self-referencing linedefs, which the
original DOOM renderer ignores, hence causing large areas of HOM which
then get flat-flooded.

Fixed transparent doors in the software renderer.

Changed (improved ?) the invulnerability fade-out in GL.

2004/01/25:

Worked on fixing transparent doors in GL, again (TNT MAP02).

Discovered major issue with GL's 1D occlusion buffer: it ain't
working !  Even stuff behind one-sided walls is being drawn.

2004/01/24:

DEH_EDGE: conversion to DDF for things, attacks, weapons, sounds,
music, and language strings are now all in place and finished.

Fixed sounds.ddf BUG when replacing old entries with new ones, they
would get the wrong sounds (due to rearranging the sfxinfo_t list).

2004/01/21:

Mlook: Tilt sprites in GL so they don't disappear when mlooking far
up or down.  Fixed it for sprites split by liquid extrafloors.

Fixed an assertion/crash when handling a level where a subsector only
contains 1 or 2 segs, which happens occasionally due to problems in
the level.  Typical example: near start on MAP22.

2004/01/19:

Things.ddf: added missing METAL sound to cyberdemon's chase states.
Fixed the pain sound for the BOSS_BRAIN (was missing MAKEPAINSOUND).

IDEA: Flat-flooding in GL: when detected (missing upper/lower),
create a rectangle plane which gets drawn (1) before everything and
(2) does NOT affect the depth buffer.  Hence the plane will only show
up in the bits that cause HOM.  Issues: (a) reusing the same plane
for multiple linedefs, (b) computing the size of the plane, (c) may
interact badly with sky code, (d) using an E.F may be better.

2004/01/18:

Mlook: fixed 1D occlusion buffer to handle 360 degree range, and fixed
GL rendering to draw stuff behind the viewplane when looking far up or
down (in this case, we don't clip to the viewport angles).

2004/01/17:

Mlook: working on full mlook range for GL.  Renamed 'vertangle' field
in ticcmd_t to 'vertslope' (never was an angle).  Made the mobj_t
vertangle field into angle_t (with fix for savegames), ditto for
viewvertangle variable.  Fixed object movement (especially missiles)
to have proper 3-dimensional speeds.

2004/01/16:

Been working on a DEH->EDGE conversion utility.

2004/01/13:

Colmap.ddf: new special "WHITEN", which will only be used for fonts.
Implied when colourmap begins with "TEXT_" (but can be overridden).

RTS Tips: the first 9 slots where unchangeable.  Revoked that.

Levels.ddf: Added PRE.COLOURMAP and END.COLOURMAP, which allows
changing the colour of the text in finale screens.

Fonts: modified colourmap handling for fonts so that text & status
bar numbers are not forced to be red, but remain their original
colours, while still allowing other colours to be used.

W_Image.cpp: fixed crash bug in GL mode when using palette-remapped
images and it tries to flush them (e.g. changing gamma setting).

Config: remember the current Save/Load page.

2004/01/11:

Merged RAD_DoParseWhenAppear into DDF_MainGetWhenAppear.

Tidied up some blockmap stuff (p_map etc), with new BLOCKMAP_GET_X()
and BLOCKMAP_GET_Y() macros.

2004/01/10:

Armour: changed status bar to show _total_ armour, and the font colour
represents the best type of armour held.  Added condition "ARMOUR(##)"
(for RTS ON_CONDITION etc) which tests against the total armour.

Discovered that FLT_MIN is actually the smallest _positive_ floating
point value.  The caused a bug when activating the lift in MAP06.

Fixed an assertion (crash) bug in hu_lib.cpp when using another
language and the message has accent (>= 128) characters.  Also
reworked and reformatted the code.

ConfigFile: made EDGE save/restore the current language.

2004/01/09:

Zooming: always use current weapon's zoom factor if set in DDF.

2003/12/19:

Been working on music library this week.

Fixed bug not saving sky image (changeable with RTS) in savegames,
by adding new variable SKY_IMAGE into the [GLOB] variable list.

2003/12/05:

Added a workaround for Radeon 7500 linux driver bug that fucks up
with 1x1 mip textures (shows black).

Fixed bug with new sky code not covering all of the screen.

2003/12/04:

Implemented new sky drawing method which eliminates a great deal of
the "sparkles" which the old draw-sky-behind-everything method had.

Works like this: during initial BSP walk, draw the sky walls/polys
such that they only affect the depth buffer.  Hence after the walk,
the depth buffer contains a map of where to draw the sky.  Then,
before anything else is drawn, draw the sky into that map (using the
GL_GREATER depth function).  Note that places that normally cause
HOM will _not_ have any sky drawn in them.

Removed the old, never fully implemented "TileSky" crud.

2003/12/02:

Fixed the "MAP06 ceiling fails to open" bug.

Added a basic overlay HUD.  Niceties like icons and well-placed values
can wait until later (HUD.DDF).

Changed default console background to "CONSOLE", and made a basic
blue-ish flat that will be put into EDGE.WAD.

2003/11/29:

Added a check for strings and letters to DDF_GetNumericValue.
Fixed some music entries in levels.ddf (they were strings, not nums).

Added new games.ddf command SPECIAL_MUSIC, which is used by the cast
screen and the bunny scroll.  Updated games.ddf and playlist.ddf with
the correct cast/bunny music.

Started getting to grips with the OpenAL library.

2003/11/28:

Made the check for unterminated strings non-fatal, since it occurs in
QDoomTst 1.1 and thus likely to occur in other add-ons too.  Added some
extra checks (unclosed <> and [] and unfinished command at end of file).

Fixed shot attacks to honor the attack's RANGE setting.

Implemented new RESISTANCE_CLASS command for DDF.  Used the same way as
IMMUNITY_CLASS, but the monster gets 60% less damage.

Found the source of those odd bug reports about "invincible enemies" and
"barrel explosions pull others toward them".  It only occurred when the
true-3d-gameplay option was off.  Fixed !

Looked for the "friendly monster gets angry from immune hit" bug, but
couldn't spot it.  (Need a friendly monster for testing).  Punted till next
release.

2003/11/22:

Hit a weird issue when fiddling with 16-bit sound output in Linux.  The type
'char' is UNSIGNED in GCC under Linux/PPC, but the code assumed it was signed,
causing heavy distortion.

Added 16 bit sound for Linux (and -sound16 option to force it).

2003/11/13:

Reverted sky code to old method (draw it behind everything), getting rid of
the wobbles, and can be a lot faster (no need to split polygons).

Adjusted GL light table (255 now the max, now 240).

2003/11/10:

Reimplemented vertex arrays in GL renderer.  Option -novertexarray
disables it.

2003/11/09:

EDGE will now automatically create an 'edge.log' file containing all
startup and other messages.

Reworked m_misc and m_option code to remove assumption that sizeof(bool)
equals sizeof(int).  Also tidied up m_misc (removing the bits that stored
char pointers in integers).  The defaults[] array is now static too.

Fixed crash bug when a door closed on a dead player.

Renamed Defered to Deferred (e.g. G_DeferedInitNew).

Fixed a bug: chat macros in the config file were always overwritten by the
defaults from DDF.

2003/11/02:

Worked on OPL emulation player in Humidity.  Got the timing/buffering issues
fixed.  Noticed too that timidity plays MIDI files too slowly (D_RUNNIN total
time was 4:43 but should be 3:48).

2003/11/01:

Added 'f' to some floating point constants.
Updated MacOS X support in the EPI code (macosx_epi.cpp).

2003/10/29:

Worked on tidying up the mus_2_midi code.

2003/10/25:

Worked on Native MacOS X support in Humidity.

2003/10/24:

Worked on MIDI reading code for music library (named 'Humidity').

2003/10/23:

Implemented new RTS on_condition WALKING.  Added on_condition support
for checking amount of powerups e.g. POWERUP_PARTINVIS(10).

2003/10/22:

Worked on new EPI code: epitype.h epimacro.h epiendian.h epicrc.cpp/h
and epimd5.cpp/h, ported from ZCPPLIB and SDL.

2003/10/21:

Added workaround for the "BPP 4 Invalid" error when running GLEDGE
(Linux and MacOS X) without specifying bpp (option or edge.cfg).

Worked on mus_2_midi code.

Got TIMIDITY to compile and run.

2003/10/17:

Added initial player capacities for pellets, nails, grenades & gas
into our DDF.

2003/10/11:

Fixed DOOM 1 warnings about missing textures and missing sprites.
Fixed RTS JUMP command (was seriously broken).
Fixed RTS problem when using WAIT before a LABEL.

Changed Windows argument parsing (win32/i_main.cpp) to handle double
quotes, to allow filenames with spaces in them.

Tidied up some stuff marked !!! and FIXME, unmarking them if they are
part of the software renderer and hence not important anymore.

Centered the PAUSE image.

Fixed PALETTE_REMAP for GL renderer.

2003/10/10:

Worked on MacOS X makefiles.  Tidied up other makefiles.
Restored software renderer wipe code in e_main.cpp.
Fixed 16-bit translucency in SW renderer on MacOS X.

2003/10/09:

Renamed ga_worlddone to ga_loadnext, which is more accurate (ga_worlddone
sounds like it finishes something, but it actually loads the next level).

Removed G_DoWorldDone (also a misnomer BTW) in g_game.cpp, as the logic
boiled down to "currentmap = nextmap; G_DoLoadLevel()".

Fixed the bug where PRE.TEXT didn't work on first level (MAP01, E1M1).

Fix for special effects (green tint for suit, red tint for berserk)
so that they fade out after dying.

Fix for bug where projectiles that hit you on the head coming down at a
sharp angle would not cause any damage.  Problem occurred because
ZMovement doesn't test the same things that XYMovement does.

2003/10/08:

Fix for MAX_FALL: doesn't apply when player is swimming or flying.
Fix for too much bobbing (now same as PrBoom).
Fix for berserk: if already showing fist, don't lower/raise it.
Fix for loss of precision when scrolling walls/floor.
Fix for floor textures in GL (wrong scale, no transparency).

When a path follower hits an RTS node, the trigger is enabled.

2003/10/06:

Worked on removing warnings about 'invalid conversions', such as
with skill_t or weapon_selection_e, plus some float --> int
warnings and 'signed with unsigned comparisons'.

2003/10/04:

Added FLO_UNUSED for some special uses of M_PI (unset DDF fields).

2003/10/03:

Changed DDF and savegame code to remove the FIELD_OFFSET computation
(which doesn't work properly with Winbloze C++ compilers).  New code
stores pointers into a dummy struct instead of field offsets.

2003/10/01:

Updated l_glbsp.c code to handle GLBSP 2.05.

Tried compiling EDGE with G++.  A few things didn't compile
(e.g. using ++ on finalstage_e and z_urgency_e), the biggest
problem in m_option.c (the forward decl of extkeyconfiginfo).
Plus a billion warnings :).  Otherwise it seems to run OK.

2003/09/27:

Fixed the FACE() action.

2003/05/20:  

Added support for MacOS X.

---- Been away for a little while ----

2001/11/23:

Found a bug, the default key for the secondary attack was set
incorrectly so that it didn't activate (should be 'e' not 'E').

2001/11/12:

* EDGE 1.27 was released *

2001/11/11:

Worked on fixing THIN sliding doors in GLEDGE.  OK, done.

Added code so that closed sliding doors (a) block player sound,
and (b) block monster sight.  Allowed sliding doors to close over
the top of corpses and pickup items.  Fixed a crash bug with "S1"
sliding doors (i.e. COUNT=1).

Starting making Windows, Linux and DOS packages for release.

2001/11/09:

Found Marc's problem playing some MP3 files.  Occurred because
those MP3s begin with some non-MP3 data (looks like ID3 tags)
which requires calling a special XingMP3 routine (head_info3).

2001/11/08:

Found a problem with weapons.ddf UPGRADES command.  It kept an
integer index into weaponinfo[], but the DDF pointer arrays are
now kept in FIRST-COME order (see my entry for 2001/04/27), hence
the pointers can move about thus making indices invalid.

One difficulty here is that numeric weapon indices are needed for
the benefit system, which has a integer `subtype' field.  Also the
condition system does the same thing.  For that reason, I'll disable
the normal practice of keeping the pointers in first-come order for
weapons -- a careful check of other usage of weaponinfo[] finds no
other potential problems, apart from possible issues with #CLEARALL
and Savegames (fixed BTW) that was already there.

A quick test (DOOM, QDOOM & GUNSPC) shows that weapons are now
working properly and nothing else seems to have broken.

2001/11/04:

Finished off the README.1ST file with a description of all the command
line options.

Changed default console background to FWATER1.

2001/11/03:

Reworked sfx_t handling (mainly DDF_SfxLookupSound) in order to
prevent memory fragmentation.  Will it help ?  No idea.

Starting looking into platform specific sound handling.  Seems Win32
had a massive bug where I_UnloadSfx() never freed any sounds since the
handle check was opposite to what it should be.  Hopefully this
explains Transon's sound problems.  This might have been found earlier
if the code used DEV_ASSERT instead of a unused message buffer.

Was pretty ruthless on win32/i_sound.c, converting many of the
errordesc stuff into DEV_ASSERTs or I_Errors instead, mainly
out-of-memory conditions or invalid parameter stuff.  It's not that
the errordesc thing is bad, just that IMHO programmer errors and
out-of-memory should _not_ be silently ignored.

Reworked the AddChannel/GetChannel stuff in win32/i_sound.c, putting a
limit on number of active channels (128) and general tidying.  This
also fixed a silly bug in there: the channel ptr array was being
allocated with size `numstoredsfx' instead of `numchannels'.

Fixed bug in l_mp3.c (L_MP3SetMusicLump) which didn't free bs_buffer
when something went wrong.  Hopefully this is the cause of the
`bs_buffer == NULL' assertions that Marc & Espi have gotten.  
Just to be sure, fiddled with win32/i_mp3.c, adding some missing
L_MP3ClearMusicFile() calls and making it a tad more robust.

Worked on the README.1ST file, and added more changelog files into the
doc/ directory (for EDGE 1.19 through to 1.24).

2001/10/29:

Reworked RTS timing code, to fix problem with tagged_use retriggerable
triggers.

Reworked P_AddWeapon() function, to (hopefully) fix problems with
upgradations.

2001/10/26:

Implemented new BOUNCE_UP command of bouncing objects.

2001/10/24:

Added code to check for wrong level data from a savegame, e.g. loading
a DOOM2 map when playing the TNT iwad.  Currently it bombs out with a
fatal error -- which is pretty poor, but anything else is really hard,
since the new level has already by partially loaded.

Fixed automap not displaying the level's name.

2001/10/23:

Worked on implementing crosshairs for GLEDGE.  Done.

Moved the `Boom line/sec' option in the gameplay menu to the top line
and renamed it `Compatibility'.  The options are now `EDGE' and
`BOOM', with the potential for other ones in the future.

Made the compatibility mode (BOOM/EDGE) part of gameflags_t.  This
means it will be properly stored in / loaded from savegames, where
before you could load a savegame into the wrong compat mode and thus
causing weird shit to occur -- that can't happen now.

2001/10/22:

Worked on pre-caching sprites on level load.  Youch, on a large map
like MAP29 this causes a really long delay before the level starts
(using GLEDGE anyway).  Oh well.  Default is now disabled, use the
"-fastsprites' cmdline option to enable.

Fixed GLEDGE handling of FOV's greater than 90 degrees (though HOM is
still possible in places since GLEDGE still doesn't render anything
behind the viewplane).

New option in gameplay menu: `Weapon Kick'.  Can be used to disable
the kick effect used in certain weapons (including weapons using the
KICK() code pointer).  Default is enabled.  There is an associated
levels.ddf special tag "WEAPON_KICK" (and "NO_WEAPON_KICK") which can
override the user's preference.

2001/10/21:

New feature: STATES(ZOOM) for weapons.ddf.  When used, that sprite
will be used as the zoom image, e.g. a viewfinder.

New feature: NO_TRIGGER_LINES attack special.  Shot and projectile
attacks with this flag never activate special linedefs.

New feature: UNBLOCK_LINES <tag> for radius triggers.  All lines on
the map with the same tag will be unblocked, allowing players and
monsters to pass.  Only affects two-sided lines.

Worked on supporting (in a very limited way) multiple palettes.
Limitations: (1) it only works in GLEDGE, (2) font characters in other
palettes won't work properly.

Tidied up some !!! / FIXME stuff.

2001/10/20:

Stopped EDGE drawing weapon sprites when view is ZOOMED.

Made angle turning and mlooking slower when view is ZOOMED.

2001/10/12:

Removed the JUST_A_WIP crap.

2001/10/11:

Fixed the sprite rotation selection code for 16-rot sprites.

2001/09/30:

Removed the USE_SAVESYS define from the code and makefiles, it is now
always enabled.  Fixed the DOS makefile which didn't include the new
savegame code (D'oh !).  Removed the USE_LAYERS define and the unused
prototypical code that went with it.

Fiddled with Win32 MP3 code to prevent the "bs_buffer == NULL"
assertion in L_mp3.c, but I still don't see how it can happen.

2001/09/26:

* Released GLBSP 1.95 *

2001/09/24:

Worked on fixing POLYOBJ handling in GLBSP.

Worked on glbspX (the GUI version).  OK, it's not 100% (mainly missing
a page in the manual), but quite releasable now.

2001/09/09:

Damn it, somehow I broke the MELT wipe in software mode, all the
others still work.  OK, fixed.

Centered the word "finished" on the intermission screen.

Implemented DLIGHT.HEIGHT command, taking a percentage value.

Fixed a problem with RTS scripts that have a condition (e.g. ONHEIGHT)
and use WAIT as the first command.

2001/09/08:

Worked on wipes for GLEDGE.  Well, it got a bit ugly, since it really
didn't fit in well with the existing wipe framework.

Okidoke, four different wipes are done: Melt (standard DOOM),
Crossfade, the sliders (top/bottom/left/right) and Doors.  Only the
`Corners' type was left out.  Also the texture mapping on the doors
type is a bit crook -- subdividing into 2x2 quads should help.

2001/09/04:

Fixed the sloppy tag linking in RAD_GroupTriggerTags(), which caused
the QD10 elevator button to crash.

Fixed the problem with continuous ceilings (crushers), which was most
notable on DOOM 2's MAP04 (The Focus) and DOOM's E3M5.  If there are
more cases of non-workitude, then we'll have to supply the proper
OTHER_REF and OTHER_OFFSET commands in our DDF to fix those.

Added a "-lax" option, mainly useful for debugging.

2001/08/31:

Fixed a crash bug with RTS tips, and an assertion crash with
light-transfer linetypes.

2001/08/25:

Fixed a typo in e_main.c.

2001/08/21:

Fixed shrunk-down-view glitches (the quick & dirty way: always draw
the outer stuff).

2001/08/19:

Added new DLIGHT_RANDOM(low,high) action -- flickering dlights.

2001/08/17:

* EDGE 1.26 was released *

2001/08/16:

Fiddled some more with Win32 fullscreen GL, using WS_POPUP in
CreateWindow in i_main.c *seems* to work, but it feels very much like
a fragile hack.

Made Windows, DOS and Linux binaries for the release.

2001/08/15:

Reworked detail-level option, the old "high" and "insane" settings
were useless in practice.

Fiddled with the win32/i_opengl.c code, trying to get fullscreen mode
operational.  Well, partially successful, the set-resolution menu
doesn't cause EDGE to bomb out anymore, but we've still got a window
(titlebar + border), plus weird effects after the change.

Added code to fix the weird effects (untested), but I can't find any
way to turn off the titlebar/border.

Worked on my LevelSkinner program for a while.

2001/08/09:

Fixed a new crash bug with RTS tips.

Simplified EF savegame code: the ef_info field is just a cached value
from the control line -- no need to find it & save it.

2001/08/07:

Savegame work: Extrafloors.  Doing sector_t now.  Done, on to the
testing & fixing phase.  Fixed a bug with texture offsets, and a bug
with sector heights (D'oh).

2001/08/06:

Savegame work: RTS tips.  Now doing moving sectors.  OK, tackling the
item respawn list.  Righteo, those three are done, leaving only
sector/extrafloor stuff to do (and debugging the whole big damn mess,
of course :->).

2001/08/05:

Reworked some code (notable exception: automap) not to be hardcoded to
the Doom palette.

Worked on fixing the MAP30 boss-brain for savegames, saving the shoot
spots.  Oops: was going to use DUMMYMOBJs for each target, but that
would break if the save occurred whilst a cube was in flight.  Thus
I'm going to assume that spit-spot objects never disappear (or new
ones appear) -- which means we don't need any savegame code for them
at all -- the spots will be found again at the next ShootToSpot.

Discovered why Heretic levels show up purple: the COLORMAP lump in
EDGE.WAD is overriding the one in the heretic iwad, and it just so
happens that the best green gets mapped to a dark colour by it.

2001/08/04:

Added support in w_image.c for raw 320x200 image blocks, as used in
Heretic and Hexen.  Added code to display a dummy sprite if the
patches are missing.  Added code p_setup.c to load Hexen levels, a
"for the fun of it" thing (full Hexen support is way out of the
question, besides other ports have got it well covered).

2001/08/03:

Re-fixed shoot code for extrafloor.  Doesn't work in all places yet,
that's slated for the conversion to BSP traversal (Post Releasum).

Re-fixed flooding liquids that sit above the real sector's ceiling:
the properties were not transferred properly.

Broke through the 300K barrier :).  Someone call Guiness...

Fixed move-wait-return floors to handle extrafloors better.  Fixed
(well, I think) the pseudo-shadows in GL.  Fixed the bunny thing at
the end of Doom 1 full version.

2001/08/02:

Bit of sector movement work.  GLEDGE feels really slow, prolly down to
the inefficient PolyQuad code.  Bah.

Fixed two really stupid bugs in the new touch node code.  Fixed a
recent bug with texture alignment on one-sided walls.

Glbsp: implemented support for arbitrary level names.  They are
automatically detected.

2001/08/01:

Change of pace: worked on glBSPX for a bit.

2001/07/31:

Working on the sector movement code...  Renamed `floorOrCeiling' to
just `is_ceiling' so I can understand the code.  Created new sector
movement and checking routines in p_map.c.  Fixed up crouching and
RTS's MOVE_SECTOR command for new code.  OK, AttemptMovePlane() has
been rewritten -- on to the test/debug cycle (pedal pedal :->).

Fixed a long standing bug with texture switching, most noticeable on
MAP01 where sometimes the end-switch was lit up, sometimes normal.

2001/07/30:

Reworked GL renderer to use "polyquads".  Checked out DLIGHT with the
new splitters: looking much better now, so I've renabled it for the
release, even though it doesn't work in software mode.  Added new
things.ddf command DLIGHT_FADE, for smooth dlight fading.  Added new
line in video menu "Detail Level" -- commented out the screen
composition line temporarily (we need an "Advanced" option menu).
Disabled the HALO test code for the release.

2001/07/29:

Worked on polygon splitting code.  OK, the vertical separating
splitter is working -- the code is very "Ugh !" though.  OK, the
vertical non-separating splitter is in and seems to work.  Okidoke,
now the horizontal polygon splitting code is done.

While the new polygon splitting code works, I'm not happy with it,
since it needs to make a new (small) polygon for every split piece,
which ends up a lot slower than using e.g. triangle strips convering
the same size.  Ah well, it'll do.

2001/07/28:

More LOD work: new "polyquad" routines in rgl_unit.c that can split
quads into arbitrarily small pieces.  Got the QUAD part is working,
haven't started the harder POLY part yet.

2001/07/27:

Re-fixed sprite scaling in GL that broke recently.

Tidied up the new LOD routines in r2_util.c.  Added support for it in
the new SKY code (walls only ATM) -- it's better, but on really long
walls a single LOD value is too simplistic.  Seems that 1024 or so is
the "magic" length -- anything bigger should be first split into
smaller chunks (< 1024 each), and then compute the LOD for each one.

2001/07/26:

Fixed silly bug in new sight code.  Extrafloors seem to be blocking
sight correctly now.  Fixed another silly bug not creating extrafloors
properly.  Removed the second "Reset To Original" line in the main
option menu -- one set of defaults seems enough IMHO.

Started writing some very basic LOD (Level of Detail) code.  The basic
idea is obvious: far away things get drawn with lower polygon counts
than closer stuff.  I need this for the sky in GL: splitting *ALL* sky
polygons to 64 units is a huge slowdown, even with quad-strips, and we
really need 32 units (or less) to prevent rippling.

Added a few missing images in f_finale.c, e.g. BunnyScroll.  Untested.
Removed big chunks of v_video1/2.c -- all the V_DrawPatch* routines
are no longer used.  Reworked the menu code.

2001/07/24:

Sight code work...  Slow going, but I need to nail it down since the
new sight code will serve as a basis for new shoot/aim code.

Implemented new LINE_EFFECT called "LIGHT_WALL".  It is analogous to
sector versions: it transfers the lighting from the tagging ilne's
front sector to all other lines with the same tag.

Added lines.ddf command LINE_PARTS.  Takes the same tags as
SCROLL_PARTS.  Used for fine-grain control of LINE_EFFECT tags.

2001/07/23:

glbspX work...

Noticed that our sight code is using P_ApproxSlope, and therefore is
probably not as accurate as it should be.  The original DOOM code
looks better: it's using the distance from src->dest as the common
(implied) denominator of the slopes, hence InterceptVector2 returning
a fraction (0->1) value.  Wow, now it all makes sense.

Noticed two nice optimisations in the PrBOOM sight code: bbox checking
for lines, and vertical bbox checking on the LOS itself.  Also,
figured out that minisegs _can_ be ignored after all.  Only one thing
bugging me now: when we reach the subsector containing the dest obj,
we need to check that obj's (x,y) point against the sector gaps.

I can see why mucho effort has gone into optimising the sight code in
DOOM and BOOM: it can slow things down a *LOT* when sub-optimal.

Aha !  Since we are doing multiple passes over the same LOS, we don't
need to check all possible lines again -- the first pass can generate
an intercept list, saving lots of time for the other passes.  Sweet.

2001/07/22:

Fixed SECTOR_EFFECT command for recent changes.  Untested.

Worked on fixing sight code.  Tail-recursivified the CheckSightBSP
routine.  Hmmm, the sight_gap stuff turned out to be useless, what we
really need is sight gaps in the *sector* not the linedef.  Makes me
wonder if the normal gaps in line_t are really needed.

Rewrote P_PlayerInSpecialSector() for new extrafloor code.

Reinstated RTS_DISABLE_TAGGED thing action, and added it as a weapon
action too.

2001/07/21:

Re-enabled dlight code, just to see what it was like.

Played with some halo code...

Improved the GL sky, it still ripples, but is a lot less noticeable
now.  Mlooking far upwards still looks bad.  We need a "quality"
slider in the video menu, since the ripples can be reduced more but at
the cost of lower FPS (since more polygons are needed).

2001/07/20:

Added JUMP_DELAY new DDF command for players.  Untested.  'Nuff said.

More issues with sector movement: handling things is not trivial.
Firstly we need to handle cases where things are sitting on or
floating above other things.  How this should work is obvious enough,
you'd expect things to get pushed together and push other things,
but how to code this in a nice reliable way (especially now we're
going with a check-first move-later approach) is far from obvious.

Secondly, there is the added complication of crushing sectors.  For
example, the player is standing on a demon in a crusher somewhere.
We'd want both objects to get crushed, and their "effective" heights
to be lower than the real heights by the appropriate amount.  Our
current code has nothing like an "effective" height though.

Perhaps the check-first move-later approach is not the best way.  It
bugs me that it'll prolly require a "dry run" of trying to push all
the things, which then gets repeated for the real move.  What bugs me
about the move-oops-undo approach is handling control sectors for
extrafloors -- we need to remember what extrafloors were moved in case
one of them fails, and then undo them all.  Hmmm....

I'll stick with the "move-oops-undo" approach, at least where Things
are concerned, as that'll mean the least change to the current code.

Did a little work on bots, got them working again.

2001/07/19:

Did some work on glbspX.

2001/07/18:

FUCK.  Still climbin' that BSP learning curve.  The new object
placement routine is not reliable, because when the bounding box
intersects a partition line, we don't actually split it, and therefore
a future partition line check can produce the wrong result, because
we're checking an area that is too big.  I didn't have to go far to
find this problem -- it happens right near the start of MAP01 !

2001/07/17:

Began rework of sector movement code.  Elevators are tricky...  OK, I
think they'll work like this:

   (a) check "non-safe" end (see notes below about "safe" ends).
       If move not possible, stop before moving anything.

   (b) move one end, then the other.  Pass a flag for "safeness",
       meaning we don't need to worry about objects for that end.
       For normal sector elevators, move safe end first.  For 3D
       platforms, safe end moved last.

This logic relies heavily on the "safe end" concept.  Hmmmm, yes the
logic is OK.  Added new `above_mo' and `below_mo' fields in mobj_t
replacing the ride_em stuff.

Added P_ChangeThingPosition() routine as the preferred method for
atomicly moving a thing in the world.  Started work on a "touch node"
system for remembering what things are in or touch what sectors
(blatant copy of the BOOM msecnode_t idea).

2001/07/16:

Worked on fully implementing line gaps.  There is now no limit to the
number of extrafloors per sector (apart from memory :).  Re-fixed keys
in the status bar -- they were dependent on the order in ddf_main.h.
Fixed crash bug with RTS CHANGE_TEX command and new code.

2001/07/15:

Fixed up pegging/offsets for extrafloor sides.  Fixed sky problems
in software renderer.  Fixed (I think) BOOM SKCK+ALL locked doors.
Fixed a bug with autoaiming not aiming at monsters lower than you.
Fixed a automap crash bug with new extrafloor code.  Fixed THICK
translucent extrafloors in new code.

Played with rippling water surfaces in GL.  Looks very cool.

Changed HOM-detection option to just "-hom".  Added `IDHOM' cheat.

Partial fix for transparent doors.  Also new code allows vertically
scrolling mid-masked textures.

2001/07/13:

More extrafloor work. I'm introducing "wall tiles", pre-computing the
sides of walls that need to be drawn.  This should speed up rendering,
since currently we compute the tiles every time we visit that
subsector.  OTOH it will slow down sector movement some more.

Well, after mucho work, got something going again (software mode).

Damn -- rendering didn't get any faster.  I think the BSP traversal
part is probably close to optimal.  I suspect what may be letting us
down is not having the hand-optimised assembler col/span drawers.

2001/07/12:

More work on extrafloors.  MUCH to fix !

Ahh, made a mistake ages ago where the LIQUID extrafloor tag implies
SEE_THROUGH.  Thinking on it now, it makes more sense to NOT imply it,
as the SEE_THROUGH tag is only really useful for liquids.  Marc Pullen
has done us a big favour though: all the liquid types in EDGE and
QDOOM's DDF have the SEE_THROUGH tag explicitly.  Therefore I'll fix
the mistake and make it not-implied, and B.C. breakage should be
minimal.  Besides, monster sight through extrafloors has been broken
anyway.  I'll also implement the NOSHADE tag which makes the
extrafloor keep the same lighting as above it.

I can see why thing movement gets slow: it computes the sector gaps
for a thing EVERY time it moves.  Whee.  We can fix that by storing
the gaps in the sector (of course, now we slow down sector movement
instead), also we'll need two sets of gaps to handle WATERWALKERs
properly (ouch).

Hmmm... that `hidden' flag in extrafloor_t has gotta go.  The main
reason for it was to handle flooders in a nice way.  Therefore a
better way is to keep the hidden liquids in a separate list.  Or,
perhaps put _ALL_ liquids in a separate list, they would both be
sorted by height so it's possible to do a staggered traversal.

Implemented a new console command:

   CRC  <lump name>

which computes the CRC value of the given lump.

2001/07/11:

Fixed some HOM problems with sky in GL.

IDEA: use BSP tree to work out what sectors a thing touches
(msecnodes).  Currently we already do a BSP traversal on every
P_SetThingPosition(), so with a little more work we can compute
what sectors the thing touches too.

Merged sidepart_t and plane_info_t in r_defs.h into a single
structure: surface_t.

Phew... I don't think our vert_region_t stuff is gonna cut it.  What
makes it unsatisfactory is that they are not independent, the ceiling
of one is the floor of another, and even that relationship is poorly
defined, which makes moving extrafloors HARD.  So I think it's time to
make the programming model correspond more closely to the editing
model, i.e. back to sector + set of extrafloors.  BIG changes afoot...

2001/07/10:

Decided we need a msecnode_t system like BOOM uses to handle moving
sectors/extrafloors in an efficient way.  Should it handle vert
regions too ?  Hmmm....

More extrafloor rejigging.

Replaced `soundtarget' in sector_t with a player number, mainly to get
rid of the `mobj_t *' in there (allowing generic mobjs has
implications for P_RemoveMobj).

Started on routine(s) to check if sector moves are valid.  For
elevators there is two cases:

    (1) normal sector.  It is always safe to move one end of the
        elevator without checking (upwards: ceiling, downwards:
        floor), so the normal check routine will do (for the other
        end).  Safe end moves first.

    (2) thick extrafloor dummy sector (3D platform).  Again one of the
        ends is always safe to move (upwards: bottom of EF, downwards:
        top of EF), so same as above: only need to check one end.
        Unlike the above: safe end moves _last_.

That's a relief, since trying to check both floor/ceiling at the same
time would've been a massive PITA.

Another rejig of vert_region_t: this time making f_h, c_h and top_h
the nominal height info, ignoring the floor->h and ceil->h values
altogether.  This is needed for 3D platform movement, so that EF
regions can be moved independently of their dummy sector (during a
move that is -- they will still match the dummy heights at all other
times).

2001/07/09:

Fixed problem with breathing support not showing air-bar sometimes.
The code now considers your mouth to be at eye-height :) instead of
on the top of your head.

Re-enabled the "PAUSE" icon when paused.

Started the "Big Extrafloor Rejig" that's been on the cards for so
long now.  First step: getting rid of extrafloor_record_t, and just
keeping the info in the regions.

Well, so far it mostly works (e.g. QD01-QD03), but needs fixing for
floors that move over/under other floors (e.g. QD04).

2001/07/08:

Allowed RTS path nodes to have multiple TAGGED_PATH destinations, the
monster will choose one at random.  Added new "PATH_EVENT" command
which takes one arg: a state label -- when the monster reaches that
node it will enter that state.  Fixed savegame code for paths.

Added parsing code for new RTS multiplayer commands "NET_MODE" and
"TAGGED_PLAYER_SPECIFIC".  Leave it 'til later to get them working.

Worked on fixing thin horizontally sliding doors for GL.  Changed the
texturing mode: the texture on the second sidedef should be the same
as the on the first, EDGE will automatically reverse it.

2001/07/07:

Spent another while working out the RTS multiplayer semantics, trying
to find the things that make the most sense.  I'm fairly happy with
the results.  See docs/rts_rules.txt.

Implemented the RTS_ENABLE_TAGGED action for weapons.ddf.  Only useful
for a few special effects, but it's also part of being able to create
more "tool-like" weapons.  Future plans: have some more keys usuable
by weapons for special purposes, say four, and pressing them makes the
weapon jump to specified states.  Maybe another 4 keys to make the
player thing jump to specified states too.

Implemented GIVE_BENEFIT and LOSE_BENEFIT commands for RTS, and also
LOSE_BENEFIT command for things.ddf (pickups).  'Nuff said I think.

2001/07/06:

Implemented new RTS command ONCONDITION (some code was already there,
it just needed the parser).  It is like ONDEATH and ONHEIGHT: the
trigger will not run unless the condition is satisfied.  Used like
this:

    ONCONDITION  <condition>

Where condition is something that the player is holding or is doing.
It is one of these:
  
    HEALTH(num)
    BULLETS(num)        // and the other ammo names
    GREEN_ARMOUR(num)   // and the other armours
    KEY_BLUECARD        // and the other keys
    CHAINGUN            // and the other weapons
    POWERUP_PARTINVIS   // and the other powerups

    JUMPING     ATTACKING
    CROUCHING   RAMPAGING
    SWIMMING    USING

The brackets on health, ammo and armour conditions are optional, when
present they are a minimum needed, e.g. HEALTH(50) requires health 50
or higher to run.  Without the brackets, they mean "any above zero".

Those words can be prefixed with "NOT_", which negates the condition,
e.g. NOT_KEY_REDSKULL means that the trigger will only run when the
player *doesn't* have the red skull key.

Multiple ONCONDITION lines can be used in each trigger script, and
they _all_ have to be satisfied before the trigger will run.

Probably the most useful of the conditions is the key ones, which can
be used to make using triggers that require keys to work, just like
what can be done with linedefs.

Future plans: allow these conditions to be used in states in
THINGS.DDF and WEAPONS.DDF, and the future HUD.DDF.

Spent a while working out the full RTS execution semantics.  There's a
much harder issue to solve: multiplayer semantics.  This is really
really tricky !  The current code runs all triggers for all players,
e.g. messing up timing aspects.  Some triggers should only be run
_once_, e.g. ones doing SPAWNTHINGs onto extrafloors.  Some actions
require players, e.g. TIP (presumably the player that satisfied the
conditions) and some don't, e.g. MOVE_SECTOR.  Arghhh.

IDEA: it may help to specify triggers as "player specific".  In such
cases there is one trigger spawned _for each player_ in the game.
Scripts that use TIP, DAMAGEPLAYER, GIVEARMOUR (etc) are candidates.

IDEA 2: may also help to specify triggers as "absolute".  These
scripts are detached from players.  Scripts that use SPAWNTHING,
MOVE_SECTOR, LIGHT_SECTOR, SECTORV/L are candidates.

OK, I'm thinking a new command like "NET_MODE" is prolly the way to
go, taking a keyword (or several) to describe how the script works
in multiplayer (net) games.  "ABSOLUTE" would be one tag.  "NORMAL"
would specify the default: separate triggers spawned for each
player.  Other possibilities: one to "lock out" the other player
triggers when the first is activated; one to be like absolute, but
allow _any_ player who satisfies all conditions activate -- maybe
another one for _all_ players must satisfy the conditions.

2001/07/05:

Fixed bug where certain lighting linetypes (esp. 138) wouldn't work
when used with the RTS ACTIVATE_LINETYPE command.

Fixed -ddf when used on an empty directory -- missing files now cause
an error instead of warnings.  Maybe change this on a file-by-file
basis later on to allow better backwards compat.

2001/07/04:

Been working on glbspX (GUI version of glbsp).  Looking good.

2001/07/02:

Hacked up console code to get it working again.  Made the text white
and made pressing enter on an empty line not say "bad command".

2001/07/01:

Worked on fixing the problem of EDGE not setting a good video mode
when first run and 320x200x8 doesn't work.  As the last resort it now
tries all modes in the available list.  I'm not sure yet how
windowed/fullscreen should fit in -- probably like this: when
fullscreen and all modes fail, then switch to windowing.

Windowed mode is problematic: most windowing systems allow arbitrary
sized windows (maybe a small restriction like multiple of 8).  Using
the same sizes as fullscreen-avail-list is not right.  I'd say have a
set of "standard" sizes (e.g. 640x480) and use those.

Worked on implementing fullscreen/windowing mode choice in the EPI.
Put screenmode_t into i_system.h and added a `windowed' flag.  Made
various bits of code handle the windowed flag (and global
`in_a_window' flag which is analogous to the SCREENWIDTH/HEIGHT
globals).  V_AddAvailableResolution and I_SetScreenSize now take
pointers to a screenmode_t.

OUCH: `bpp' is used in many places, but I keep getting confused on
whether it means "bits per pixel" or "bytes per pixel".  Naughty
acronym !  This should be changed to prevent confusion (== bugs), but
I'll need to rename DEPTH --> PITCH in places too.

Prolly went somewhat overboard renaming stuff.  Oh well.

Okidoke, everything seems to be working again.  What's better is that
the new Linux/SDL code handles the "Set Resolution" menu properly.
It's working in GL mode too -- sweet.

Fixed a bug with recent demo/title reworking, and a bug not setting
defaults for the "extended" keys in the config.

Implemented translucent solid boxes for software mode, fixing the
non-darkening-menu-background thing.

2001/06/30:

Disabled the DLIGHT stuff.  No use releasing EDGE with half-arsed
features -- they should work & work well.  (Same goes for TILESKY).

Added new keys for lines.ddf: GREENCARD, GREENSKULL, GOLDKEY,
SILVERKEY, BRASSKEY, MONKEY (not really !), COPPERKEY, STEELKEY,
WOODENKEY, FIREKEY and WATERKEY, bringing the total to 16.  The names
don't mean much (they could've been KEY1..KEY10, but how boring !).
Like the new ammo types, TC makers can make them into anything.

Implemented new I_Access() EPI function.  Hopefully this should fix
the read-only-IWAD problem under win32.

Created L_CompareTimeStamps() routine based on Andy Baker's code
that was in AddFile() in w_wad.c.

2001/06/28:

Worked on incorporating Janis Legzdinsh's Hexen fixes into glBSP.

The FLTK version is coming along...

2001/06/26:

Decided to switch to the FLTK toolkit for the GUI version of glBSP,
because (a) seems better supported under Win32, (b) C++ is just a much
more natural language for doing GUI work than plain C (GTK+ is rather
painful to code with).

2001/06/25:

More work on making a GTK+ version of glBSP.

2001/06/23:

Did some glBSP work.

2001/06/22:

Added blockmap check for lumps > 128k (i.e. same as in Boom).  Thought
about optimising GenerateBlockMap, but the code looks fairly optimal
already.

Removed old code in r_bsp.c, r_segs.c, r_plane.c, and a few others.

Created new file "ddf_boom.c", and began work on implementing
generalised line & sector types.  Okidoke, sector types are done (that
was the easy part :->).  Started work on the line types, crushers and
stairs are done -- need to do some testing.

Righteo finished the generalised line types.  Some stuff isn't
implemented, e.g. the "ALL keys" for locked doors, or reversable
stairs -- because our DDF doesn't support such things.  Plus some
parts of BOOMREF.TXT are ambiguous, e.g. whether the 32-unit floor
movers go _down_ 32 units when DIR==0.  So it may take a while to find
all the quirks (but hey, that's what releases are for :->).

There's also the issue of manual doors -- BOOM uses the tag to do a
light effect.  This confuses EDGE ATM.  OK added a "MANUAL" type that
is the same as "PUSH" but ignores the tag.  Also fixed: COUNT=0 in
lines.ddf should mean "no limit on retriggering", and scroll direction
for linetypes 250-253.

2001/06/21:

Fixed DDF and RTS error messages to put the context info into the
I_Error buffer, so it appears in the pop-up window under Win32.

Changed S_ChangeMusic to make playlist number #0 mean "no music".
Could be useful with the rts CHANGE_MUSIC command.

Fixed an infinite-loop bug in E_DoAdvanceDemo when there are no title
screens at all.

2001/06/19:

Fixed up semantics for finding texture/flat anim sequences.

Optimised the R_InitSprites() routine with a binary search.  What's
weird is that it is now SLOWER than before -- arghhh !

Optimised R_InitSprites even more, but it is still slower, which I
believe is down to the inefficient searching in W_ImageFromPatch, due
to recent changes having a lot more images to wade through.

Reworked the way sprites enter the image system.  Ah good,
R_InitSprites is now nice and fast.

Change `interscr' field of mapstuff_t into a string `episode_name',
thereby removing DDF references to wi_map_t (games.ddf).  This means
we can delete the game entries when #CLEARALL is used.

Implemented #CLEARALL for DDF.  Half the files actually delete the
entries, the other half use a `num_disabled_xxx' variable to pretend
they are not there.

2001/06/18:

Moved R_InitPicAnims from p_spec.c to r_data.c, and moved it and some
other routines into the startcode[] array.  Fixed texture loader to
ignore textures with missing patches ("dud" textures), as it's better
to use a dummy texture than to crash out with an error.

Reimplemented level pre-caching -- and yeah it's better with it.

Catalog of stuff in DDF that a #CLEARALL would affect:

  0. Obvious: all types of lookups (name/number) would fail.  I don't
     see any problem (yet) with false positives (e.g. the implications
     of not failing when the #CLEARALL is ignored).

  1. Anims.ddf: (a) those flats/textures would no longer animate.

     Here it would be safe to delete the list, as nothing else
     contains pointers/references to anim defs.

  2. Switch.ddf: same as for anims.ddf.

  3. Weapons.ddf: (a) all FREE=TRUE weapons are automatically given to
     the player.  (b) the "give all weapons" cheat gives the player
     all weapons known in DDF.

     Since the only references to weaponinfo_t (mainly the key
     choices) are made _after_ DDF cleanup time, it is also safe here
     to delete the weapon list.

     [UPDATE] Ouch, weapons look-ups return an integer (unlike every
     other DDF object) and it turns out they do have references: one
     in weapons and one in things (for benefits).
     
  4. Lines.ddf: no other implications (or references) --> delete.
  
  5. Sectors.ddf: no other implications --> delete.

  6. Colmap.ddf: this has references in other DDF structures, so the
     entries should not be deleted.  No other implications though, so
     the #CLEARALL could be safely ignored.

  7. Language.ldf: no other implications --> delete.

  8. Playlist.ddf: no other implications --> delete.

  9. Sounds.ddf: has many references in other DDF structs.  There are
     the "bastard sfxs", but they aren't looked-up until DDF cleanup
     time.  There are no other implications though (apart from
     lookups), thus the #CLEARALL can be safely ignored.

  10. Games.ddf: (a) wi_map_t used in other DDF structs.  (b) the game
      entries are scanned in m_menu.c to create the Episode menu.  
      (c) Entries are scanned to display title images when EDGE first
      starts up (play title music too).

      Here #CLEARALL would affect (b) and (c), and could be very
      useful for TCs.  (OTOH there may be better ways).
      
  11. Levels.ddf: (a) mapstuff_t reference only used within itself,
      hence the entries could be deleted.  Otherwise no other
      implications --> delete.

  12. Attacks.ddf: (a) references used in other DDF structs.  (b)
      attacks have a dual nature, also functioning as objects
      depending on the type of attack.  See the things.ddf bit, though
      it's prolly safe to just ignore #CLEARALL.

  13. Things.ddf: (a) references used elsewhere.  (b) things also have
      a number, which is looked up when loading the map (also by
      certain RTS commands).  (c) the CASTORDER command can put the
      thing into the end-game cast parade -- a missing CASTORDER value
      upsets the parade.  (d) the PLAYER command is used to find what
      thing type the player will become.  One such thing type must
      exist for each player, or EDGE won't run.

      Implications for (b), (c) and (d) are just failing to find a
      thing.  Since newer things override older ones, it is safe to
      have false positives.  No other implications --> ignore.

  14. States: (a) DDF files with states will add to the global list of
      what sprites are used.  These sprites won't be removed by a
      #CLEARALL.  Implication: R_InitSprites will look for sprite
      patches for unused weapons/things/attacks.  (b) The state array
      itself will contain states that probably won't be used.

To summarise: only weapons.ddf and games.ddf provide any benefit of a
#CLEARALL directive (apart from the memory savings).  Games.ddf is the
trickiest, there are references so we can't just delete the entries.
For the other DDF files, some can delete and the rest can ignore it. 

Hmmm... for games.ddf, I think put a boolean (like `disabled') in
wi_map_t.  Also the episode menu & title screen parts should be
scanned once and store the results in a "cache" field in wi_map_t
(or separately).

IDEA: for the undeleteables: keep a "num_disabled_xxx" variable,
initially zero.  When #CLEARALL is used, set it.  All scanning should
take it into account.
 
2001/06/17:

Started work fixing up texture animations.  Moved some WAD structures
(patch_t, mappatch_t and maptexture_t) into the dm_data.h header file
where the other structures are kept.  Worked on flats: creating a
image for every flat within F_START to F_END.  Similar work for
textures: add an image for each entry in TEXTURE1/2.  It's more
efficient than the previous approach: look them up on-the-fly.

Ouch: some stuff needs to be found case *insensitively*, as the BOOM
source indicates.  In particular: flat/texture names and lump names.
Okidoke, put in some strupr()s and stricmp()s.

Okidoke #2: New flat/texture loaders are working OK.

Okidoke #3: Texture animations are back.  Yeah baby.

2001/06/12:

Replaced gasp states with new GASP_SOUND command for the player DDF.

IDEA: fix the sight/aim/shoot code for extrafloors: use a bit-field
instead of a dynamic array of vertical angle ranges.

2001/06/12:

Worked on player physics when in multiple extrafloors (e.g half in a
liquid, half out).  The properties like gravity, viscosity (etc)
become a weighted average of all intersected areas (weighted by how
much of the player is in that area).

Added new sector SPECIAL "SWIM".  When you're in a sector or liquid
with such a special sector, then it activates "swimming mode".  In
swimming mode you can swim up/down, plus you also swim in the MLOOK
direction.  Also the jump key works differently.  For swimming mode to
work well, the sectortype should a low GRAVITY value (e.g. 0), and
have FRICTION and DRAG values the same and less than 0.9 or so.
Viscosity is an optional extra :->.  It's working quite nicely now.

2001/06/10:

* Released version 1.94 of glBSP *

Added new DRAG command for lines and sectors in DDF.  It is a
companion for the GRAVITY, FRICTION and VISCOSITY commands.  DRAG
means "air friction" -- it is how much objects get slowed down by the
air when they are airborne (i.e. not touching the ground).  The
default value (0.99) provides backwards compat.  Lower values (e.g.
0.91) makes liquids more "sticky".  This command goes part way to help
make water physics better, however more is needed make it really good.

2001/06/08:

Improved software mipmapping, by ensuring that the mip is always
increasing when drawing the columns (no icky "oscillation" on
neighbouring columns).

Fixed problem with TURN_RANDOM() thing action.

2001/06/07:

Worked on LevNamer some more.  Option parsing code is in place.
Righteo got something working -- needs tidying up now.

2001/06/06:

Added check for missing/empty REJECT lump.

Reworked LevNamer docs: the usage is more intuitive now.

2001/06/05:

Began work on a level renaming tool (called "LevNamer").  Did
something unusual: actually wrote some documentation before writing
any code.

2001/06/04:

Worked on making the mipmapping in software mode back to per-column
instead of per-surface.  OK done, and is somewhat optimised.

2001/06/03:

Added P_MobjSetRealSource(), for missiles that spawn missiles.

Worked on savegame code for radius triggers.  One complication is that
radius scripts have no good identifier -- I'll use a checksum of
important info I think.  OK radius trigger part is done.

2001/06/02:

Worked on savegame code -- region/sector stuff.  Actually I think I
jumped the gun a bit, it needs the big rejig (heh) to be complete
(i.e. the extrafloor cleanup).

Righteo, savegame code for (a) active buttons and (b) active lights is
now in place.

2001/06/01:

June already -- jeez.  Anyway new GL sky code is in place, and working
fine on various test levels, including the original E1M1.  But the
texturing part is way out of whack, that'll require quite some work,
especially to renable the tilesky stuff.  BTW also implemented the
-homdetect option, for both renderers.

OK, texturing on GL sky code is now fairly right -- (a) the plane
parts are very wobbly, so increased the wall parts by 256 as a hack to
compensate, (b) the code is really sub-optimal, needs optimising.
Plus tilesky stuff is still off-line -- and I'm not sure if it is
even worth keeping.

2001/05/31:

Added preliminary support for an on-screen air indicator.

IDEA: for GL skies: do a first pass over the level, and compute a "sky
height" s.t. on every line where both sectors have a sky ceiling, the
sky heights are the same.  When rendering, render the sky at the sky
height (as planes), and render sky "walls" where the sky height is
larger than the real height on certain lines (i.e. 1S and 2S that
don't have sky on their back).  Hmmm... should work OK.

Began work implementing this.  Looks like a goer :-)

2001/05/30:

Made armour value on status bar have same colour as the best armour
currently held, i.e. red if we have red armour, yellow, blue or green
if we only have green armour (or none).

Made health and ammo colour on status bar the same as in BOOM.
Experimental though -- will see what everyone else thinks before
keeping it.

Found a problem: ST_ReInit() gets called too early (during
V_InitResolution) when the player structure hasn't been properly
initialised yet.  Hacked up for now.

2001/05/29:

Reworked floor/ceiling height references (ref_XXX) and the
GetSecHeightReference() function.  Merged all the P_FindLowest/Highest
Floor/Ceiling and P_FindNextXXX functions in p_spec.c into one big
routine.  Started off with just a simple goal: to fix the continuous
floors on MAP12, but that required a version of FindHighestFloor which
includes the current sector, etc etc...

Some new DDF in that: (a) OTHER_REF and OTHER_OFFSET are used where
DEST_REF and DEST_OFFSET are used, and specify the opposite height
that continuously moving floors move to.  The default matches standard
DOOM/BOOM behaviour.  (b) DEST_REF and OTHER_REF accept some tags
placed (with a comma) after the normal reference (ABSOLUTE etc).  They
are "INCLUDE" and "EXCLUDE".  Examples:

    DEST_REF = LOSURROUNDINGFLOOR, EXCLUDE;
    DEST_REF = HISURROUNDINGFLOOR, INCLUDE;

where INCLUDE means to include the current sector with the surrounding
sectors, and EXCLUDE means to exclude it.  We need them both since, to
remain backwards compatible, LOSURROUNDINGFLOOR implies INCLUDE and
the other SURROUND types imply EXCLUDE.  Later on I'd like to support
an "EXTRA" tag too, which will take solid extrafloors into account
when computing the height to move to.

Well, at least MAP12 is working now.

Added a `boom_compat' flag, including a -boom option and entries in
the config file and gameplay option menu.  In preparation for support
for BOOM linetypes and sector types.  Also added the initial DDF
framework for them.

Added a `in_a_window' flag, including -windowed and -fullscreen
options and entry in the config file.  Not used yet, prolly need to
update I_SetScreenSize() function of EPI with windowing as a fourth
parameter.

Reworked AIR support -- removing CHOKE_START.  Now, you start choking
when your lung capacity completely runs out, and you only drown when
your health runs out (since choking causes pain).

Started reworking armour code: keeping all four armour values
independently in player_t.  This change seems quite natural, so far
the code changes have been minimal.  OK done, including a way to
prevent underwater choke damage from being mitigated by armour.

2001/05/28:

Fixed (for real this time) the slither on top of weapon in GL bug, and
also a gap underneath the weapon.

Reworked the CastTicker() code in f_finale.c.  Done.  There were many
places where it could crash if an action required closecombat or range
attacks were used without the monster having them.  Also fixed a
problem not mirroring certain sprites (e.g. the hell knight).

Reworked CalcHeight() in p_user.c, mainly to fix a problem with the
weapon sprite jumping when walking/running down stairs.

Noticed that some continuous plats on MAP12 aren't working -- a
problem in P_SetupSectorAction with mov_Continuous types.  Started
working on a fix...

2001/05/27:

Yadex: implemented a "transfer property" feature, first you select the
destination objects (sectors are the main ones I had in mind), then
highlight the source object, then press `T'.  The properties are
copied from source to dest.  For sectors, it is everything (heights,
flats, etc), for things it is the type, angle & when_appear, for
linedefs it is the flags, type and tag.  One issue is sidedefs:
currently they are left alone -- transferring the textures (etc) could
be useful though it is unclear the best way to handle 2s lines.

Yadex: implemented the `w' key in vertex mode doing the split-sector
function (analogous to the same key in linedef mode).

2001/05/26:

Temporarily hacked up P_ChangeSector so that extrafloors (esp.
liquids) still work properly.  I'm gonna overhaul it anyway.

2001/05/25:

Fixed a few crash bugs in new savegame code.

Fixed issues with hidden liquid floors in the software renderer.  Did
the same for the GL renderer.  Fixed a new problem with flooders.

2001/05/24:

Fixed the flat-lighting weapon-too-dark problem in the software
renderer.

Found the bug causing read-only IWADs to be ignored in Win32.  Seems
BCC32's idea of the "access" function is different to the normal UNIX
semantics (which our code currently uses), e.g. the R_OK, W_OK defines
are not defined anywhere in the BCC headers.  Looked at the "open"
function too -- here BCC32 is OK, hence I think we should remove the
access calls in favour of open/close pairs.

Fixed stupid crash bug in GLBSP, when used with a single filename.

2001/05/23:

Worked on the issue where inside ceilings that are higher than the
outside walls sometimes get drawn in GLEDGE.  Near the start of MAP12
of DOOM 2 is a good example.  The changes are an improvement, but may
cause other problems with really short linedefs or segs (especially
when a whole wall is made up of really short pieces).  I dunno, but I
tend to think a better way of handling the sky would help a lot.

Added support for dithering under GL (-dither option, plus a line in
the config file).  Does it help/hinder/is good/is bad ?  Well, close
up walls look a bit smoother, sky too, otherwise unnoticeable (though
other videocards may show more improvement).

Fixed the slither at the top of certain weapons in GLEDGE.

Fixed SPRITE_SCALE for sprites in GLEDGE, also sprites that intersect
with liquid surfaces.  CHTHON in qdoom now looks right.

Fixed SPRITE_SCALE + liquids in the software renderer, at least
vertically.  Something odd is happening horizontally...

OK, fixed horizontal SPRITE_SCALE in the software renderer.  Phew, I'm
glad this sprite scaling stuff is finally fixed, it's been pending for
a looooong time now.

Catalog of what actions can jump to what states:

1. things.ddf

   LOOKOUT    ->  CHASE
   CHASE      ->  IDLE, MELEE, MISSILE
   SUPPORT_LOOKOUT    ->  MEANDER
   REFIRE_CHECK  ->  CHASE
   PATH_CHECK    -> MEANDER
   RESCHASE      -> RESURRECT

2. weapons.ddf

   RAISE            -> READY
   READY            -> DOWN, ATTACK, SEC_ATTACK
   LOWER            -> UP
   CHECKRELOAD      -> RELOAD
   SEC_CHECKRELOAD  -> SECRELOAD    
   SHOOT            -> ATTACK
   SEC_SHOOT        -> SECATTACK

   REFIRE           -> ATTACK
   NOFIRE           -> ATTACK, READY
   NOFIRE_RETURN    -> ATTACK, READY
   SEC_REFIRE       -> SECATTACK
   SEC_NOFIRE       -> SECATTACK, READY
   SEC_NOFIRE_RETURN  -> SECATTACK, READY
   
   SHOOT            -> FLASH (flash)
   FLASH            -> FLASH (flash)
   SEC_SHOOT        -> SECFLASH (flash)
   SEC_FLASH        -> SECFLASH (flash)

   CHECK_MOVING     -> IDLE (player)
   FLASH            -> MISSILE (player)
   SEC_FLASH        -> MISSILE (player)
   SHOOT            -> MELEE, MISSILE (player)
   SEC_SHOOT        -> MELEE, MISSILE (player)

Hmmm, that sheds some light.  Some of these actions would benefit
from an ability to specify an alternative state in brackets, e.g.
LOOKOUT().  Others (like NOFIRE) might be better done in a more atomic
way -- or should I say "might have been better" as I think there's
little point or value in changing them now.

IDEA: a generic "PLAYER_JUMP" action for weapons.ddf, that can cause
the player to go into the specified state.  Useful ?  Dunno.

2001/05/18:

I think ACTIVATORS=MISSILE should be removed, in favour of just
allowing missiles to activate any TYPE=SHOOT special line (the
missile's shooter will have to match the existing ACTIVATORS line, of
course).  Having MISSILE as an activator was a stupid idea of mine.
The only real implication of this change is that certain lines will be
activateable by missiles, where before you'd have to use a bullet
weapon (e.g. the door at the start of MAP18 of DOOM 2).

OK removed now.  MISSILE tag is still accepted, but ignored.

2001/05/17:

Looked into SINGLESIDED=TRUE and missile-hitting-lines issues.  I'm
not happy with the current logic for missile hitting lines, it's messy
(with parts in p_mobj.c and p_map.c) and feels unreliable.  Updated
the P_ShootSpecialLine() function to take a side parameter, which
should fix the SINGLESIDED problems for both bullets and missiles.

2001/05/16:

Reworked the tricky P_ComputeSectorRegions() func, using the changes
to sector_t and vert_region_t.  What I've got now looks and feels a
lot cleaner -- let's hope it still works :).

Okidoke, tested it, and seems everything still works.  Good.

Implemented SEC_NOFIRE_RETURN weapon action.

2001/05/15:

Thoughts on breathing support:

  (a) Sectors tagged as "air-less" start decrementing the current
      amount of air within the player.  Monsters are unaffected.
      This amount could be called "lung capacity", given as a time
      value e.g. 60 seconds, and is DDF definable.
  
  (b) When the air runs out -- player drowns.  Enters the "DROWN"
      states if they exist, otherwise ordinary death states.

  (c) When the air reaches a certain limit, player starts choking.
      Enters "CHOKE" states if exist, otherwise pain states.  This
      limit and intervals between gasps are DDF definable.

  (d) New powerup "SCUBA" gives players immunity to air-less sectors
      while powerup is in effect.  Also just gaining the powerup fills
      lungs.

  (e) Leaving a air-less sector means regaining air.  Lungs are filled
      immediately -- simplest option.  If the player has "GASP"
      states, they are entered.

  (f) In the future: draw a nice diminishing bar when in an air-less
      sector.  Bar could turn red when in choke limit.

Started implementing the above.  For the player DDF, the commands are
LUNG_CAPACITY, GASP_START and CHOKE_START (all time values), and
CHOKE_DAMAGE.XXX which controls choke damage, interval and choke/drown
states.  They have reasonable defaults.  For sectors.ddf there's the
new AIRLESS special.  For things.ddf the new powerup name is
POWERUP_SCUBA, use it just like POWERUP_ACIDSUIT.

Finished it, and tested it all except for SCUBA powerup.

Began doing stage I rework of extrafloor code, involving some minimal
improvements including putting all vert_regions into one big array
that is created at level load time.

2001/05/09:

Made TAGGED_REPEATABLE allowable with no parameters.

Fully implemented the new MOVE_SECTOR and LIGHT_SECTOR rts commands,
including the ABSOLUTE keyword.

IDEA: for vert_region, keep min & max of all things touching the
region.  Allows lowers/raises without checks in some cases.  Whether
it really helps remains to be seen.

2001/05/08:

Found another problem with GLBSP: when subsectors become really wide
but narrow, we can hit the angle accuracy limit, causing segs to be
put in the wrong order (and the "subsector not closed" messages).
Making ANG_EPSILON a lot smaller has fixed the problem in my test wad.

BTW, I thought GLBSP had problems with MAP14 of DOOM 2, but it turns
out that the map is made with the triangle holes in the ceiling, plus
some missing upper/lower textures made it look like bad nodes.

Yadex: implemented a function that "fills" a closed area with either a
new sector reference, or if another sector is selected then with that
sector reference.  The key is `Z'.  Doesn't handle islands yet.

2001/05/07:

Worked on very minimal REJECT support for GLBSP.  Just fixed a bug
that meant the warning about 2s linedefs missing the left side was
never displayed.

2001/05/04:

Tidied up GLBSP error messages w.r.t. arguments.  Tidied up some more
GLBSP problems, e.g. it wasn't even showing the usual info when run
with no arguments.

2001/04/29:

Added USHORT() and ULONG() macros, and used them to tidy up p_setup.c
in order to increase some limitations, especially in GL_SEGS.

More GLBSP stuff: implemented debugging code in system.c.  Added
warning messages for lumps that overflow their usual limits (e.g.
GL_SEGS).  Found a serious bug when the blockmap gets truncated, the
root superblock is created too small !  Fixed now.

OK, with these fixes MAP26 of 10SECTOR.WAD now works in EDGE (albeit
slowly, as in other engines).

2001/04/28:

Some GLBSP work: added checks for VERY long linedefs and nodes,
reworked blockmap truncation code, with a new "-maxblock" option that
may help in some cases.

2001/04/27:

Found a subtle searching problem for DDF (while checking out QDOOM
cast-order problems).  Some commands (e.g. CASTORDER) want the
"newest" entry to override earlier ones.  But if a newer entry
replaces an earlier one (since it has the same name), then it will
appear to be "older" since it keeps the same position in the array.

Routines affected are:

   DDF_MobjLookupNum
   DDF_MobjLookupCast
   DDF_MobjLookupPlayer

Everything else looks OK, e.g. weapon key cycles are computed after
all DDF files have been read.

Solution ?  We're using arrays of pointers, so it seems adequate to
simply keep the pointer array in first-come order, even when a new
entry replaces an earlier one.  Note: the rule about not moving the
actual entry structures (mobjinfo_t etc) is still valid.

Yep, that fixes the cast order issue, etc.

Fixed sprite sizes in the cast finale.

Went through the action routines in p_action.c, adding checks for
fields that may be NULL (especially `currentattack').

Noticed that the QDOOM bouncing grenade was not bouncing off walls
facing exactly south.  Turned out to be two bugs in the bounce code,
both of them combining to cause that bug.

2001/04/14:

More work on ddf update guide.

2001/04/13:

Docco work -- 1.25 update guide is almost done.

2001/04/12:

Began reworking extrafloor code, making vert_region_t the main
structure in the code and relegating sector_t to be little more than a
container for vert_regions (or just "regions" for short).

Deprecated the current SECTORL and SECTORV rts commands, which take
the exact sector number and are thus prone to breakage.  The new
commands are:

    MOVE_SECTOR   <tag>  <amount>  <ceiling or floor>
    LIGHT_SECTOR  <tag>  <amount>

which are otherwise identical. but take a tag number (and can thus
affect multiple sectors at once).  The new commands can also accept
the word "ABSOLUTE" placed at the end, meaning to set the
height/lighting to the absolute value rather than increment/decrement.

Well, extrafloor rework is coming along, everything now compiles again
after the changes, _except_ p_plane.c (which is the worst of the
bunch), plus (often large) chunks of the code are currently commented
out with //ZZZ or #if 0 (like p_spec.c and p_maputl.c).  The highest
ceiling and lowest floor heights are used quite a bit (including some
places that aren't fully 3D aware yet, like p_sight.c), therefore I'm
caching these values in two new sector_t fields: min_h and max_h.

Description: adding an extrafloor works like this: the dummy sector
(which should have only one region) has a line tagging the destination
(like before).  In the new code, the tag refers to an existing region
(or several).  This region gets split in half (vertically).  The upper
half keeps the same tag, properties, and ceiling and the floor is
copied from the dummy region.  The lower half keeps the floor, and the
properties and ceiling are copied from the dummy region.  The next bit
is crucial: the dummy region's tag is _transferred_ to the lower half,
not copied -- meaning it gets cleared to zero in the dummy region.

That means all future tag-related operations (moving floors, property
transfers, and those new RTS commands above) will affect the new
region (lower half) and not the dummy sector.  IMPLICATIONS: non-tag
operations that move or alter the dummy sector will no longer work as
they do now.  So far I can only think of two cases: (a) using SECTORV
or SECTORL on the dummy sector won't work, breaking compatibility.
These RTS commands are now deprecated though.  (b) using the stair
building linetypes on a set of dummy sectors to get a rising 3D
staircase no longer works either, in fact it'll prolly behave quite
strangely due to that tag transfer.  For now I'm not going to worry
about these.  Plus it must be said that other sector movements need
updating to handle 3D floors better (e.g. Raise to Next Highest
Excluded Floor).

2001/04/08:

More documentation work.

2001/04/07:

Removed the DDF template stuff, which was never used ("dormant code").

Started tidying up the DDF command lists to be like the savegame code,
using the DDF_CMD() macro (with DF() abbreviation).  Later on we'll
remove the buffer_xxxx stuff and use offsets directly, so the current
changes are just aesthetic but will require minimal changes when we do
start using field offset values.

Done tidying ddf tables, also removing the never-used `private'
parameter in the parsing routines, and cleaning up sub-tables using
DDF_SUB_LIST() and DDF_CMD_SUB() macros.

Removed the '@' label stuff that no-one uses.  Keep it simple.

Fixed two bugs: (a) QDoom rain falling at the same time, (b) bouncing
objects not entering their bounce states.

Worked on changelog some more.

2001/04/04:

Fixed the linux I_PathIsDirectory() routine, which was using
access(filename, X_OK) which is not an adequate test.  Now using the
stat() function and S_ISDIR().  The BeOS port may need fixing too.

2001/03/17:

Savegame work, today it's sidedefs and linedefs.  Wrote routines in
w_image.c for stringifying & un-stringifying image pointers.

BTW the image system would be a cleaner without the differentation of
types (ImageFromFlat vs ImageFromTexture etc etc)...  It's to do with
the way that images are added on-the-fly.  Hmmmm, OK, we're kinda
restrained by the current WAD semantics, e.g. finding a flat outside
of F_START/F_END when it isn't found inside there.  At times like
these I start thinking about a new WAD format -- but it's no good,
EDGE is a _Doom_ port and much (if not most) of its value is being
able to play the existing corpus of Doom works.

Sidedef and Linedef save code is in place, and compiles OK.  Need to
investigate stuff like GroupLines() and animation lists...

2001/03/14:

Savegame stuff.  Improved the way states are saved/restored in the
savegame file -- the new system is much more robust than just saving
the index into states[] (which can oh so easily change, e.g. by adding
a new monster or item).

Found the strange "corpses disappear after load" bug, turns out I
forgot the important "tics" field in the mobj_t save table.

Noticed that lots of code in p_action.c assumes `currentattack' is
valid.  The savegame code doesn't save that field yet -- hence a
crash.   Hmmmm, if it's our policy that EDGE shouldn't crash, even
when DDF actions are used incorrectly (very reasonable IMO), then all
action routines should check for things like this.

2001/03/13:

Savegame work.  Updated main code for [GLOB] changes.  Updated
structure/array/data loaders for top-level changes.  Started writing
code to dump savegames -- should be very useful for debugging.

Righteo the savegame code is now fixed for the changes in the specs
(docs/save_sys.txt) and the debugging code which dumps savegame files
is done.  I'm fairly happy with the specs and the code now.  Still
quite a lot to do yet though...

2001/03/12:

Savegame work.  

OK, changes for globals (GLOB chunk) are in place, it's another
table-driven dealie like DDF and the savegame structure stuff.

2001/03/11:

Implemented ladders, pretty much a no brainer.  Can be used for
climbable vines and that sort of thing too.  Usage: it is linedef
based, when you are sitting on a ladder linedef (and the heights
match) then pressing MoveUp/Down lets you climb the ladder.  The
LINES.DDF command is just:

   LADDER.HEIGHT = 128;

that gives the height of the ladder, which should match the texture
used.  The ladder linetype should be a two sided line that has the
same sector on both sides, and about 24 units away from the actual
ladder texture.  Ladders normally start on the ground, but can be
raised by setting the Y_OFFSET in the first sidedef.

2001/03/10:

More work tidying up the savegame spec.

IDEA: ladder linetypes should be for _two_ sided lines.  This means
the check boils down to "is player sitting on this line" (plus a
height check) -- which can be done at PIT_Check{Rel,Abs}Line time,
much easier than doing a "is player touching (or near abouts) this one
sided line".  I'll try this out, if for nothing but the fun of it.

2001/03/09:

Phew, been doing other stuff for a while.  Not much you can do when
the tank is empty.  Anyway, started attacking the savegame system
again -- reworked the specs to try and make it simpler (I kept
thinking it was too complex) -- the [GLOB] chunk now does everything
(well, almost everything) with NAME=VALUE pairs (not unlike ddf) and
yeah, it feels like an improvement.  The concepts behind the rest
(SDEF, ADEF and STOR chunks) are pretty sound I think, not much can be
simplified there -- but I did remove the top-level STRU and ARRY
container chunks: the format now is basically Header + GLOB + a stream
of SDEF/ADEF/STOR chunks + Trailer.

I'm also rather keen to implement more BOOM support, namely the
generalised linetypes & sectortypes, and line-to-line teleporters.
That should allow BOOM stuff to be played without major issues like
doors that won't open, albeit with some minor things not working (like
accelerative scrollers, which are past the point of diminishing
returns for me to code up).  It'll need to be an option, since our DDF
files (and quite likely those of other projects) use conflicting
linetype and sectortype numbers.

2001/02/19:

* Made WIP binary packages for Win32 and Linux.

BTW, after using LibPNG (in another program), it's not too bad to use,
just that it lacks a nice high-level way to say "just read in this
whole image and give me the RGB data".

2001/02/12:

Been looking at the LibPNG API -- it's more painful than what I
remember, in particular the setjump stuff is downright... well, it's
an exception model for errors, but in C...

2001/02/10:

Started work redoing the texture animations, and general tidying up of
the w_image <-> w_textur interaction.

Replaced EDGEVERFIX with EDGEVERSTR.  Also added JUST_A_WIP define to
the makefiles, and made various stuff show "WIP" in (hopefully)
prominent places when it is defined.  We'll remove this define for the
full 1.25 release.

Brought the CHANGELOG up-to-date.

2001/02/09:

Fix for projectiles not triggerring 1S special lines.

Fix for berserk powerup not giving the fist.

Fix for chainsaw causing crazy mlook angles.

Fix for translucent tips in S/W renderer.

Wrote L_ConvertToDB(), used to create linear->DB lookup tables.  This
also in the "common lib" (quotes because it doesn't really exist yet,
it's a restructuring that has been planned for ages now, but Erik
Sandberg didn't get the time).  Attack it after the release...

Made M_LoadDefaults() handle a missing EDGE.CFG file better -- it
resets to recommended values.  Added analogue resetting too.

The problem with -warp seems to be that it was changed from
G_DeferedInitNew() to G_InitNew(), which shouldn't be called so early
on (in particular: before the renderer has initialised itself).  Fixed
it (I hope) by going back to G_DeferedInitNew, but passing an option
to do the right thing w.r.t. net games.  Also made it return false
when it fails.

2001/02/08:

Been looking at why -debugfile doesn't show enough info.  On linux,
I_Printf() calls I_WriteDebug(), but win32 doesn't do this.

Removed I_WriteDebug() from the EPI, since all ports used the same
code, and since `debugfile' itself is opened by the main code.  Also
renamed it to L_WriteDebug, because it is now in the common lib.
There's a hack #define so we can gradually change the very many
I_WriteDebug usages.  I've also updated all the ports to (a) make sure
I_Printf() stuff gets written to the debug file, (b) make all ports
consistently show the "WARNING:" prefix for warnings.

Wrote the I_SoundStopLooping() routine for Linux/SDL and BeOS/SDL,
fixing the lowering platforms on MAP01.

2001/02/04:

Fixed buglet with sprites in truebsp.

Worked on reimplementing weapon sprite drawing for truebsp.

Fixed a problem with the idbehold# cheats.  Fixed a problem looking up
a null string patch in f_finale.c.

Weapon sprites are working again, but only by a hair's breadth.  Needs
tidying up badly.

2001/02/02:

Fixed those GL sprite issues.

Merged Dave Leatherdale's mouse fixes into linux/iv_sdl.c, and my
additions into beos/bv_sdl.c.

2001/02/01:

Reworking the sprite code for image system.

OK, new sprite loading code is in place.  It can handle 16 rotations
(double the previous amount).  It can also handle replacing single
frames in PWADS.  That ugly hack using -1 in a boolean_t has also been
removed.

OK, sprite code is working in software renderer, EXCEPT weapon
sprites...

Fixed another percent_t problem, this time with the JUMP() action.

Updated GL code for the sprite changes.  It runs, but some issues to
sort out (like monsters' heads where their feet should be).

2001/01/31:

After mucho headache, got DRI working on my potato system.  I can now
run EDGE accelerated on my Voodoo3 without the previous screen
corruption, and hopefully without lock-up problems.  Yay :-).

Fixed floors/ceilings which scroll N/S.

Fixed RTS tips, which got buggered after the percent_t change.

2001/01/29:

Reworked SpawnMapThing() in p_setup.c to handle player starts that
have no skills properly -- i.e. ignore the skill bits.  Untested.
Also cleared player `mo' fields before level load, should allow the
missing player check to work.

2001/01/28:

Began reworking the sprite/flat marker stuff in w_wad.c, to get flat
animations going again.  The new code will handle the lumps during the
initial pass, storing a list of sprite/flat lumps in each datafile.

OK, flat animations seem to be working fine again.

2001/01/27:

Backwards compatibility: support the old TRANSLUCENCY and
EXTRAFLOOR_TRANSLUCENCY ddf commands.  Also converted percent_t type
to floating point value (as Erik intended).

Backwards compatibility: support DAMAGE_RANGE and DAMAGE_MULTI with
results very similar to how it was before the new damage system.
Everything that can be reasonably emulated, now is.

Made the ddf label syntax (@XYZ) include the `@' in the label name.
This means JUMP(@XYZ) instead of JUMP(XYZ).  This should be more
intuitive, if anyone ever uses this syntax that is.

Removed the mipmapping code for posts from the image system -- not
needed.

Fixed gamma correction in GL code.  We rely on the gamma function
g() having this property: g(X * Y) = g(X) * g(Y).

After updating X on my debian linux box to version 4.0.2, the old
Voodoo3 GL no longer works :-((, and there is no DRI drivers either
like I expected :-/.  Bah !

2001/01/26:

Backwards compatibility: Bad semicolons (`;') in DDF no longer crash 
out with a fatal error, unless the -strict option is used.

2001/01/25:

Added some temp hacks to fix status bar & view surround in GL.
Even in GL, redrawing the status bar every frame is a large hit
to the framerate (14 FPS down to 11 here).  It may be down to all
the texture changes, packing all the font chars & faces into single
images _might_ help -- it would complicate the image system too much
though.  Something to try later on...

2001/01/24:

More work on "tiled skies" for GL (do software mode later).
Looking pretty sweet now, *finally* got all the texturing 
strangeness sorted out (seems the order of vertices affects
the way textures are drawn -- odd).

New file: rgl_sky.c, which contains the sky code out of 
rgl_main.c (and is surprisingly big).

Bitten AGAIN by the startup sequence!!  It's very obvious now,
that level load should NOT occur before graphics are initialised.
Everything must be initialised before any real work (like level
load) is done, that's just common sense.  I intend to clean this
up soon.

New tile-sky system is more-or-less in-place (only for GL ATM).
It works by having dummy sectors with new line types (like how
extrafloors work).  The following LINES.DDF commands are available:

   TILESKY.TYPE=FLAT;      // can be FLAT or TEXTURE.  `FLAT'
                           // will get the sky image from the front
                           // sector's floor on the dummy line.
                           // `TEXTURE' gets the image from the
                           // dummy line itself, and textures with
                           // transparent parts are allowed.
   
   TILESKY.LAYER=1;        // there are 4 layers (1,2,3,4), starting
                           // at the outermost and coming inwards.
                           // For example, layer 2 is drawn over layer
                           // 1.
                           
   TILESKY.NUMBER=8;       // number of times the image tiles.  `1'
                           // would stretch the image over the whole
                           // top half of the sky.
   
   TILESKY.SQUISH=1.0;     // these two control how the sky sphere
   TILESKY.OFFSET=-0.8;    // is rendered.  No need to bother with
                           // these, the defaults are pretty good.

Also the TRANSLUCENCY and SCROLL_* commands will affect the rendered
skies as expected.  Quake 3 eat your heart out :-).  Note that these
skies cannot be changed with "CHANGE_TEX SKY" in RTS, you need to use
CHANGE_TEX on the sector floor or linedef.

2001/01/22:

Implemented a different FUZZY effect for GL.  It's quite nice.

Experimented with a sky effect for GL, needs work.

2001/01/21:

Got the GL renderer working with SDL (Linux).

2001/01/20:

Added a fix for the multiple R2_Init() problem.  It ain't very clean
though, to reiterate what I've thought many times: the whole startup
scheme needs an overhaul, making the startup dependencies much
clearer and debuggable.  My preference would be going into graphics
mode at the earliest possible moment, and drawing our startup
messages there rather than through I_Printf().

Fixed a "crazy chainsaw" problem.

2001/01/18:

Made sure the Linux SDL port of EDGE works OK.  This will be my
main development platform from now on.  Yep, it did.  Hit upon a
nasty bug though -- when EDGE crashes, the mouse cursor is frozen
and cannot be moved, making it impossible to use GNOME, e.g. to
shut it down.  The bug is not in EDGE, nor in SDL by the looks of 
it, but either in the window manager (IceWM) or in the X server
itself -- surely when XGrabPointer() is used and the grab window
is closed then the grab state is nullified ?  Arghhh.

2001/01/14:

Been busy installing Debian/Linux 2.2 (potato).  You forget just how
many pieces of software you have configured or tweaked to make 
everything work nicely.  Using various mesa & glide packages, I've
finally been able to run EDGE accelerated on my 3dfx Voodoo 3 card
under Linux :-).  The damn thing screws up the X server though when
it exits (not edge, the glide stuff), which is a real pain.  Getting
D.R.I. should fix this.  Comparing the TNT2-64 with the Voodoo3 with
QDOOM 0.90, I find the Voodoo3 looks nicer, but can't point my finger
on exactly why, something about the magnification mode.  It looks
"realer".  The TNT2 is also way darker, in the E2 levels I could
barely see anything, but here on Voodoo they are OK.  The DOOM 
lighting emulation currently does not take gamma properly into 
account, that's prolly part of it.  GLEDGE is really shaping up as
an engine worth something.

2001/01/08:

R2_Init (and RGL_Init) in R_ExecuteChangeResolution they are meant to
be once only initialisations, but they were being called multiple
times.  Fixed.

Fixed a problem with GenerateBlockMap for the borderline case.

2001/01/06:

Fixed problem with bright weapon sprites in GL.

Fixed the `dynamic lighting' item in the video option menu, but the
change only comes into effect at the next level load (like the
`extras' option in the gameplay menu).

Fixed the small sound/music volume bars not being synchronised.

2001/01/05:

Added `SMOOTHING' to the video options menu.  Only works for GL now,
later on we should re-implement our bilinear column/span drawers.

Implemented translucent mipmapping column/span drawers, fixing
translucent water in the software renderer.

Implemented R2_DrawImageBlock().

Made the FACE_TARGET action also set the monster's mlook angle (for
what its worth).  Added MO_MIDZ() convenience macro to the code.

Implemented the following new thing actions:

   FACE(angle)             // face the absolute <angle>
   TURN(angle)             // turn by <angle> degrees
   TURN_RANDOM(angle)      // turn between 0 and <angle> degrees

   MLOOK_FACE(angle)       // mlook to the absolute <angle>
   MLOOK_TURN(angle)       // mlook turn by <angle> degrees

   MOVE_FWD(amount)        // move forwards/backwards by <amount>
   MOVE_RIGHT(amount)      // move right/left by <amount>
   MOVE_UP(amount)         // move up/down by <amount>
   STOP                    // stop moving

The FACE and TURN actions were copied from MBF.  For all these
actions, if the <angle> or <amount> is omitted, then 0 is used (not
usually useful).  For the move actions, use a negative value to go the
opposite way.  NOTE: the amount in the move actions is a _momentum_
value, not a distance.  Objects that are not affected by friction or
gravity will keep moving in the direction until they hit something
solid or perform another movement action (e.g. STOP).

Reworked gib handling.  There is now special states: STATES(GIB),
which are entered when a thing is "gibbed", i.e. the dead corpse gets
crushed by a door.

Removed the `base_mip' stuff from W_IMAGE code.

2001/01/04:

Made infrared goggles fade out in GL renderer, and fixed lighting
equations in GL and software to be consistent.

2001/01/03:

Removed ugly_mipmap stuff from w_image code.

Worked on adding option menus for: Jumping, Crouching, Mipmapping,
Shadows and Dynamic lighting.  Some stuff in the video menu has been
displaced for the time being (reverse telefx, reverse wipe, red/cyan
3D, stretch sky).  Moved the "Set Resolution" menu up a level, from
video menu to main option menu.

Aha, in OpenGL, ReadPixels() can be used to read the depth buffer, and
this can be used as an "object obscured" test for rendering halos
(theoretically anyway).

2001/01/02:

Started debugging the problem in Win32.  If the debug file is accurate
(and hasn't lost any lines -- a real possibility when a program
crashes), then the I_SetScreenSize() routine succeeds but EDGE crashes
on its `return true' line, which is WEIRD.

Nope, can't find it, it still looks like the crash occurs when
I_SetScreenSize() returns -- I get a debug message directly before the
return, but no debug message directly after (in the calling function).
I checked for stack corruption (the return address might get clobbered
somehow), but that looked OK.  The debug file checked out OK too.  I'm
completely stumped :-(.

Added code to GL to approximate DOOM lighting.  Looks gewwwd.

Fixed the view window overlapping status bar thing.

Fixed flat alignment in software renderer -- the "bug" was just the
different memory layout of image_ts (column major).

2001/01/01:

Removed `alpha' parameter from vctx.SolidLine routine -- there's no
need for translucent line drawing right now (if ever).

Updated text writing code (HU_LIB etc) to use colourmaps.  Text in
software & GL renderers should be the correct colours now.  Time to
update the TEXT_ entries in colmaps.ddf.

Fixed all the (harmless) `Unknown font patch ...' messages.

Removed the M_CELL1/2 stuff from m_menu.c -- no longer used.

The font colours in GL looked bad (white turned out greenish !), so
updated the colourmap reader to handle fonts specially.

Hmmm, the Win32 software version isn't working :(, and I have no idea
why.  It starts up alright, loads everything, the screen turns black,
and then bamm -- back to the dos box, without any message whatsoever.

Created a test level & compared the range of lighting levels in the
software and GL versions side-by-side.  The difference is quite stark.
Determined the following mapping table:

  doom light      flat light
   
   [0,72]     -->  [0,8]
   [72,112]   -->  [8,48]
   [112,255]  -->  [48,255]

2000/12/31:

Fixed the colour problem writing TGA files from GL renderer.

Worked on dynamic lighting in the software renderer.

Dynamic lighting is now working in software rendering, however the way
floors and ceilings are drawn is not very good -- it needs a different
approach I think.  BTW, it's clear that long walls and large planes
need more light sampling points (this goes for GL too).

2000/12/30:

Tested the GL dynamic lighting.  Vertex lighting is rather primitive
(splitting large polys could help), but overall it's quite OK.  Better
than nothing :-).

Fixed translucent stuff in GL.

Found a problem in ReadPatchAsPost() in w_image.c: some patches are
compressed !  i.e.: they only store one copy of a repeated column, and
refer to it multiple times in the offset array.  Hmmm...

A worse possibility comes to mind: partial column sharing, i.e. column
XXX points at the 2nd or 3rd post within column YYY.  I strongly doubt
this occurs in practise though. 

Anyway, rewrote the ReadPatchAsPost() routine.  Working OK now.

Added a fix (untested yet) for problems mlooking quickly up/down.

2000/12/29:

Looked for flashing problem on the TNT2 card for quite a while, trying
various things.  I'm fairly sure it's down to a bug in the driver.

Tried enabling GL_LIGHTING and using glMaterial(GL_EMISSION), and it
works :-).  It's still mind-boggling how bad these OpenGL drivers are
though.

Fixed gamma changing in the GL renderer.

Worked on dynamic lighting in the GL renderer.

2000/12/28:

More image work.

Tried GLEDGE on a fast machine with a TNT2 card, there are main two
issues: (a) solid sprites are slightly see-through, (b) everything is
flashing, like lighting always changing.  I've looked hard at the
code, and can't see anything wrong.  It's almost like OpenGL drivers
for Win32 just don't work properly when GL_LIGHTING is disabled.

2000/12/27:

Began removing all the `#ifdef USE_IMAGE' checks...  Done.

Moved line clipping code from am_map.c to r2_draw.c (vctx.SolidLine),
and reworked the clipping code.  Needs checking.

Updating the column/span drawers, so that the coordinates are absolute
on the screen instead of relative to the view window.  This allows
them to be used for drawing non-render stuff (backgrounds, menus,
status bar, that kind of thing).  This will remove a long-standing
source of duplicated code (between r_draw1/2 and v_video1/2 files).

Unfortunately this image work means I'm dismantling a lot of Erik's
previous work (screen_t, viewbitmaps, etc).  That sucks, but can't
really be helped, as supporting GL means a whole new paradigm.

Got vctx.DrawImage() partially working in the software renderer.
Buggy as hell at the moment though.

2000/12/26:

Worked on image system...

Seems the old options menu code is still in m_menu.c, but is never
used unless you press backspace from the sound menu.  I've disabled it
for now.

Replaced all occurrances of V_DrawPatchName/InDirectName with the
proper image system setup and calls to vctx.DrawImage().  Testing with
GL... is working, more or less.

Migrated the status bar code to the image system.  It works now in GL,
though still some way to go yet.  Disk icon is done.  Page-background
in e_main.c is done.  Rad_act.c is done.  OK, wi_stuff.c is done.

2000/12/25:

Ate, drank, and was merry.

2000/12/24:

Started cleaning up font stuff (for image system), with a new H_font_t
type.

The number of text writing routines in the code is ridiculous, apart
from hu_lib.c there is: f_finale.c, gui_ctrls.c, m_menu.c AND
m_misc.c, all basically doing the same thing.  Needs cleaning up...

Moved some text routines (M_CharWidth thru to M_WriteTextTrans, six in
all) from m_menu.c to hu_lib.c.

2000/12/23:

Worked on converting GL code to image system.  Moved 1D occlusion
buffer stuff from rgl_tex.c (which will soon be removed) to
rgl_unit.c.

2000/12/22:

Updated mipmapping on ceilings/floors.  Not really as good as before,
but it's faster.  The wall/floor mipmap selection needs improving:
base it on the real wall/floor rather than the pixelised version.

Updated colours & positions of the fixed tip slots.

Added RTS command "CHANGE_MUSIC".  It takes a number, which refers to
an entry in playlist.ddf, and changes the current music.  It is a
companion to the already existing lines.ddf MUSIC command.

2000/12/21:

Did some image system work.  Mipmapping on walls is now done on a
whole-wall basis (rather than a per-column basis).  There is some "mip
flashing" though (jumping back and forth over a small distance), not
sure yet how to fix it.

2000/12/20:

Finished the spawnpoint_t work, including moving P_SpawnMapThing from
p_mobj.c into p_setup.c.

Made the "death look" code mlook at attacker.

2000/12/19:

Worked on replacing mapthing_t (used e.g. for item respawning) with a
new structure spawnpoint_t, since mapthing_t is the in-wad format and
is too limiting.

2000/12/18:

New player paradigm:

   (a) Bring back MAXPLAYERS define, and make the limit 32.  That's a
       pretty reasonable limit IMO, and having a limit simplifies the
       code a lot.  It can always be increased later if needed.

   (b) playerlookup[] is fixed to be MAXPLAYERS in size.  Pointers can
       be NULL in playerlookup[], that will be equivalent to having
       in_game == false.  For non-NULL entries, we require one-to-one
       with the player number, i.e: playerlookup[num]->pnum == num.

   (c) Keep the `players' linked list, but it now contains only the
       IN-GAME players.  Order is by increasing `pnum'.
 
OK, reworked player code to handle this paradigm, which is fairly
close to what was there before.

Made some preliminary code (read: mega-hack city) for the VIEW chunk
in savegame files.  It's gonna be cool.  Integrating it nicely into
the image system will be a challenge though.

2000/12/17:

Began updating the 1.25 CHANGELOG file.  There really has been a lot
of changes, even just in the last three months.

Wrote a test routine for the saving primitives, and thereby found and
fixed a serious problem with floating point values.

Savegame work...

2000/12/16:

Increase avail_weapons[] size to 10 in player_t.  The status bar can
only show 2..7 now, but perhaps more later on (with some DDF).

OK -- reworking of weapon code is almost done.  The player->weapons
array is no longer the same size as the number of DDF weapons, it is
fixed at MAXWEAPONS (32) and in-line in the player_t structure.  Had
to rework all the key_choices stuff too (bleh).

Added DEBUG_DDF, DEBUG_RTS and DEBUG_NET defines which control
debugging output for DDF, RTS and NET stuff.  Default is OFF.

Removed `p_saveg' and `r2_poly' from the makefiles.  The p_inter.h
file is now empty and can also be removed.

2000/12/15:

:(  Really not digging the player code at the moment, in particular
the playerlookup[] array and the `players' linked list.  My feeling is
that one of these is redundant, e.g. the linked list aspect.  There
are issues with the savegame code, so this needs to be sorted out.

Made the `ammo' field in player_t be in-line in the structure, rather
than a pointer to external memory.  Simplifies stuff without losing
anything.

Another big snag: the way player weapons are done is an issue for
savegames, as the size of "player->weapons" array depends on what
weapons are defined in DDF, and this can easily change.  I think I'll
limit the number of holdable weapons to some value, like 32, perhaps
in-line them into player_t (like with ammo) for simplicity.  

2000/12/14:

Savegame work.  Split loading/saving stuff into two new files:
sv_load.c and sv_save.c.

Hit a snag: the dummy target is not in the MOBJ list, but can be
referred to by mobjs (esp. the player).  Big potential for breakage
here...

2000/12/13:

Savegame work.  The load/save menus now show some info from the
highlighted savegame (the map, skill, and the timestamp), and are
shifted to the left to make room for an image.

2000/12/12:

Worked on finishing the GLBSP plugin for EDGE.

2000/12/11:

Discovered (the hard way) that attacks NEED the attackrange=XXX
command in the DDF for player autoaiming to work.  Jeez.  Actually
that's quite a trap for DDF authors, so I've added a workaround.

2000/12/10:

Another "UGH", HU_Start (and ST_Start) is called in p_mobj, yet
HU_Erase (which crashes unless HU_Start has been called) is called in
E_Display when gamestate == GS_LEVEL.  Fuck me, the code is such a
tangle of weird interdepencies like this :-(.

Worked on drawing some GLBSP progress bars in EDGE.  Looks nice :).

2000/12/09:

Removed the RTS "SAVE" primitive (very non-useful, even dangerous),
and implemented the "PLAYSOUND_BOSSMAN" primitive, which plays the
sound at full volume everywhere (like the BOSSMAN thing special).

Reworked the GenerateBlockMap code, due to a level (and a biggie at
that) which caused the old code to crash.  For the time being, I've
made EDGE always generate the block map -- to really test it out.

Oops -- the last fix for RTS crashes actually disabled radius triggers
altogether.  Took a while to find too, argh !

Reworked tip stuff (for THE last time :).  There is now TIP_SET_ALIGN
and TIP_SET_TRANS.  The latter takes translucency value, and
optionally a time value for fading, and replaces TIP_FADE.

Oops II -- invulnerability whiteness recently broke.  Fixed.

Fixed the bug not executing the first action in a DDF thing.

2000/12/08:

More savegame work.  It can now write the [GLOB] info, and read it
back in the menu code showing the right description.

BTW, the LZO compression is working alright.  Sweet.  Too early yet to
tell what the savings will be.

2000/12/07:

Savegame stuff...

2000/12/06:

Added a `ticker' function to the glBSP API (nodebuildfuncs_t).  Added
checks for the `cancelled' field of nodebuildcomms_t.

Savegame work.  Hmmm, player handling looks a bit strange, esp. the
mixture of linked list and playerlookup[] stuff throughout the code.

2000/12/05:

Reinstated the BOOMTEX extrafloor tag, to support BOOM-style water
(linetype 242).  The code swaps floor textures around to be compatible
with Boom's texturing model (which is different than EDGE's liquid
floors) -- won't work in all cases, but should work most of the time.

Fixed some crash-causing bugs in RTS parser.

Savegame work.

2000/12/04:

Bit more work on savegame code.

Well, one good thing has already come from the new image system: no
more Medusa !

2000/12/03:

Began work on new savegame system (you know, the one I've been saying
I'll implement since the start of this year :-).

2000/11/30:

Worked on getting the GLBSP plug-in working.  Spent way too much time
trying to get the linker tools to actually remove all the symbols
except ones I want to keep.  No !  It couldn't even do this simple
thing.

Fixed a problem with W_AddDynamicGWA(), the lumplookup[] array (for
lump caching) was not being enlarged like it should.

With that, the GLBSP plug-in is working :).  What it needs now is
something to show the user, so they don't think EDGE has crashed.
Drawing some progress bars like in Andy's glBSP GUI would be ideal.

2000/11/29:

Added mid-masked wall drawing code for image system.

2000/11/28:

Yes !  Got the win32/GUI version of glBSP (glbspX) working, and it
looks very sweet.

2000/11/27:

glBSP now compiles again (only the command-line version), but there
are still many issues to sort out.

OK -- command line glBSP is mostly working again.  Updated win32
filenames (removing the "i_" prefixes), and the copyrights on the
source headers to the rightful person (Andy Baker).

2000/11/26:

More GLBSP work.  The new architecture has been sorted out: the
"glbsp.h" file is the interface to the main code, used by the clients
(cmdline version, GUI versions & by EDGE).  The `wart' (a prefix to
identifiers to keep the namespace clean) here is "Glbsp".  The
system.h file is now mainly just a bridge to use the callback
functions passed to GlbspBuildNodes().

2000/11/25:

Did a bit of work on GLBSP reorganisation.

2000/11/24:

Added one last bit of tip stuff:

   TIP_FADE  <target translucency>  <time>

where the translucency is a percentage from 0% to 100%.

Added W_AddDynamicGWA() function to the wad.c/h code, which will be
needed to dynamically add a GWA file after the GLBSP plug-in has run.

Shit, that is going to fail: the user starts EDGE with a PWAD with say
6 levels (MAP01..MAP06).  Neither the IWAD or PWAD have GL Nodes.  The
user plays the first level --> nodes for the PWAD get build and added.
The user then plays through and hits MAP07 --> nodes for the IWAD get
build and added.  Duplicate GL_MAP01 entries !

Reluctantly started reworking the w_wad.c/h code, to handle the GLBSP
plug-in properly.  Removed direct usages of lumpinfo[] in code outside
of w_wad.c.  The types are now private.  Removed the `Reload' stuff
(Sorry Erik), it really was a "fragile hack" and wasn't worth the
extra complications IMHO.

Renabled the disk icon, doing it properly this time (no crashes !).

OK, wad code seems to have survived intact :-).

2000/11/23:

Split system.c/h in glBSP into two files, with the non-platform-
dependent stuff now in util.c/h.

Made load/save in glBSP code show proper progress (as a percentage)
rather than a twirling bar.  That'll be good for the GUI stuff too.
Removed the progress stuff from level.c -- practically unnoticeable.

Made TIP_SLOT start at 1 instead of 0, boosted maximum to 40, and made
the first 9 tips have unchangeable properties.  I've selected some
reasonable properties for these: a mixture of 5 colours at 5 different
on-screen heights; the odd numbers are centered, and the even numbers
are left-justified.  BTW, the rationale for unchangeable tips is so
that people can write scripts and not have to worry if the settings on
the default slot are screwy.

Un-implemented the `ddf property' stuff, where specials could be given
without any "=" and value (e.g. "COUNT_AS_KILL;").  It just looked
bad, and wasn't really worthwhile.

2000/11/22:

Made weapons bound to the same key cycle in priority order.  One hitch
was some weapons have PRIORITY=-1 in the ddf (meaning don't autoselect
when out of ammo).  I've changed that to a new ddf command:
DANGEROUS=TRUE.  Our DDF will need fixing, though some B.C. has been
maintained.

Fixed some more issues with weapon cycling/auto-selection.  The code
seems pretty tight now.

2000/11/18:

Put some more static variables in p_map.c into a structure.  One day
when time permits, it would be good to pass these structures around
instead of relying on them being static or global.

Changed the way the "all bright" powerup works, the old way would
override the colourmap on _everything_, which ruined coloured lighting
and shadows.  It's actually better now, the extra light fades away.

Fixed bounce code so that grenades (etc) bounce off 2S lines properly
(they used to just explode on 2S lines).  It's a hack though.

Did some W_IMAGE work:  Fixed up sky handling in the TrueBSP renderer.
Fixed mipmapping on scaled flats.  Fixed the CHANGE_TEX primitive.
Implemented native USE_IMAGE sky drawing code for TrueBSP.

Got some anti-mipmapping going in the W_IMAGE code.  Certainly memory
hungry, even one level applied to all images is only feasible on big
machines (e.g. >= 128MB and plenty of horsepower).  The main benefit
is for skies.

2000/11/17:

Fixed a bug with TRACKER attacks that could crash EDGE.

2000/11/16:

Found the problem causing a single pixel gap under mid-maskers.

Fixed shadows in GL (sometimes they were drawn *over* the enemies
feet).

Fixed a silly bug with crouching, the check for standing up into
something solid was buggered.

Implemented scaled wall textures in the TrueBSP renderer.

To digress a bit: I think it's important that the TrueBSP and GL
renderers support the same features (sometimes differently, but always
to some degree) -- it would be bad to see EDGE wads released with a
message like "only works properly with the GL renderer" or similar in
their descriptions.

2000/11/15:

Fixed the GL renderer to cope with recent changes (removing drawsub_t,
etc..).  Made GL renderer draw N/S/E/W walls with altered lighting.

Implemented scaled/rotated flats and scaled/skewed wall textures in
the GL renderer.

Implemented (properly) shadows in the GL renderer.

2000/11/14:

Added some code to Linux/GGI backend to support scaling, the command
line options -2, -3, -4 activate it (as in LxDoom).  Mucho room for
improvement.

Fixed a problem with sprites poking a few pixels into solid walls
(when the sprite is behind the wall).

Implemented "rectangle triggers" for RTS, like this:

   RECT_TRIGGER  <x1>  <y1>  <x2>  <y2>  [ <z1>  <z2> ]

which specify a rectangular area on the map.  Apart from that, they
are no different from Radius Triggers.

Changed TRANSLUCENCY values for things.ddf and lines.ddf to be
percentages instead of the floating point 0-1 range.  Our DDF files
(and EDGE.WAD) will need updating.  Been putting this one off for a
while now (it breaks backwards compatibility), but now seemed to be as
good a time as any.

Fixed (again) the "choppy" effect of wall texturing in TrueBSP.

2000/11/13:

Improved DDF state handling code, now allowing STATES(XXX)=... where
`XXX' is a custom label (not one of the standard labels like IDLE,
CHASE, etc).

Implemented an RTS feature for making certain things (that are in the
radius) go into certain states (but only if they exist).  Like this:

   THING_EVENT  <thing type>  <label>

where the thing type can be a name (e.g. OUR_HERO) or a number (e.g.
3001).  This idea behind it is to allow "events" where certain
scripted actions take place (e.g. to play out the story).

Fixed a silly (but serious) memory leak in the new rendering code.
Only noticed it since Linux started swapping.

2000/11/12:

Made a SHADEMAP lump for shadows (underneath monsters).

Reworked TrueBSP sprites yet again, the new way uses less memory.

Made the height of jumping lower when crouching.  While I'm tempted to
DDF-itise this, it's real borderline stuff (the line between
usefulness and sheer bloat).

Added a things.ddf field SHADOW_TRANSLUCENCY, which takes a percentage
(0% thru to 100%) for the translucency of the shadow.  Renamed the
MF_SHADOW identifier in the code to MF_FUZZY, to prevent confusion
between the two different effects.  Also, EDGE now looks for [FUZZY]
entry in colmap.ddf instead of [FUZZSHADOW].

Fixed a bug in new sprite code WRT clipping against water.

2000/11/11:

More TrueBSP work.  Removed the drawsub_t structure, moving the fields
into subsector_t.  Converted wall/plane/thing/floor allocation code in
r2_util.c to stack arrays, and implemented the Get/Commit paradigm.

2000/11/09:

Redoing sprites now...

Done, sprites are now working again.

Implemented an RTS feature for changing textures, like this:

   CHANGE_TEX  <where>  <texname>  <tag>  [ <subtag> ]

the `where' part is one of: RIGHT_UPPER, RIGHT_MIDDLE, RIGHT_LOWER,
LEFT_UPPER, LEFT_MIDDLE, LEFT_LOWER (these change line textures),
FLOOR or CEILING (for sector flats) or lastly SKY (for changing the
sky texture).  The `texname' is the name of the texture or flat.  The
`tag' specified what tag the lines or sectors have, all lines/sectors
with the same tag are affected.  The optional `subtag' part allows
more control over what is affected.

2000/11/08:

Houston, we have a problem :(.  Sprites may be horiz'ly split from the
current subsector into an _older_ one, which has already been (at
least partly) drawn and where the 1D/2D occl' buffers are no longer
valid.  Another thing is the sky: by drawing walls/planes as we go
down the BSP tree, we don't know ahead of time where we need to draw
the sky.  The so-called "TrueBSP" renderer is gravitating more and
more to being just like the original renderer... Ugh !

Tested the overdraw situation: (a) it's really good now, (b) fixed
again the cracks-on-water problem.

OK, sky drawing code is back in.  Looking at the performance: the new
code is definitely faster -- but hopefully it can be improved more.

Looking at r2_bsp.c & rgl_bsp.c, the bulk is taken up by wall code
(40% each) and thing code (40% and 30%), making good candidates to be
moved off into separate files.

2000/11/07:

Little bit more TrueBSP work, this time on the sky code.  Decided to
use the same method as before: the old Doom method was optimal (no
overdraw) but the new code is subtly different and it doesn't work.

2000/11/06:

TrueBSP rewrite is progressing...

Okidoke, plain-coloured walls and planes are now working, using the
new visplane-like system which (a) reduces overdraw (ZERO for plain
Doom levels) and (b) allows for the old flat-flooding trick.

OK -- textured walls and planes are back in.

2000/11/05:

Worked on new TrueBSP code a bit more.  Removed the `picnum' hacks
that have been in there for ages.

2000/11/04:

Began the large task of optimising the TrueBSP renderer.

2000/11/03:

Fixed the new damage system to allow override states of the form
XXX:3 or YYY:7 (i.e. LABEL + `:' + OFFSET).  Untested.

Stopped drawing shadows when they are above the view height, since
they look strange, e.g. when drawn against the sky.  Also not drawn on
sky floors.

Renamed new EXPLOD_DAMAGE command to EXPLODE_DAMAGE.

2000/10/31:

The TrueBSP renderer now does shadows.

2000/10/30:

Made the ddf checks for obsolete stuff switch-off-able, using the
-noobsolete command line option.  Of course -nowarn will also turn
these warnings off.

Updated the obsolete checks to include everything that has been
deprecated/removed for EDGE 1.25 (e.g. RANDOMJUMP).

Added `radius' parameter to P_RadiusAttack (D'oh !).

Tidied up some static vars in p_map.c, moving aim/shoot/radius_attack
stuff into structures.

OK -- new damage system is in place.  Seems to work fairly well, if
not a little bit differently.  Tried out the PAIN_STATE override
command, turning the plasma rifle into a freeze-zombie gun, and it
worked a treat.

2000/10/29:

Worked on the damage system some more.

Made the level load code recognise (a) missing blockmap and (b) a SEGS
lump that is all zeros, and produce an appropriate error message.

Fixed a silly bug of mine in the animation code, that could cause EDGE
to go into an infinite loop.

2000/10/28:

Tried some code to make you swim in the mlook direction, but it didn't
work out very well.  Needs deeper consideration.

Wanted to make DDF sub-fields recursible, e.g. FLOOR.DAMAGE.ERROR, but
the current hack (FIELD_OFF stuff) just doesn't cut it.  I think the
DDF code needs another overhaul, removing the "buffer_xxxx" stuff and
using field offsets for everything.  This would be a lot cleaner
(exempting the bit that determines the offset -- C is rather lacking
in expressiveness here), but it can wait until after the release.

Added warnings for "obsolete" ddf commands (i.e. ones that are only
provided for backwards compatibility).  Coders: they have the `!'
character at the front of their names in the command tables.

Righteo, DDF parsing and other bits of the new damage system are in
place.  The following shows what replaces DAMAGE, DAMAGE_RANGE and
DAMAGE_MULTI in attacks.ddf and sectors.ddf and the things.ddf
counterparts (which begin with EXPLOD_ (and still do)), namely:

   // simple damage, amount is constant (20)
   DAMAGE.VAL=20;

   // linear damage, amount is a random value in the range 10-40
   DAMAGE.VAL=10;
   DAMAGE.MAX=40;

   // weighted error damage, amount is a random value near the base
   // value (64), which can get as far away as the error value.  In
   // this example, the full range is 32-96, but values near 64 are
   // much more likely than values near 32 or 96.
   DAMAGE.VAL=64;
   DAMAGE.ERROR=32;

and the other fields:

   DAMAGE.DELAY=10T;
      // delay time between applying damaging.  Only used for sector
      // damage (slime), where it replaces the old DAMAGETIME command.

   DAMAGE.PAIN_STATE=FOO;
   DAMAGE.DEATH_STATE=DROWN;
   DAMAGE.OVERKILL_STATE=BURN2ACRISP;
      // if the applied damage causes pain/death/overkill, and the
      // damaged thing has the state/label specified by these
      // commands, then those states are used instead of the default
      // ones.  This allows attacks, explosions and sector damage to
      // make their victims enter special states -- this could be
      // used, for example, to make monsters that go all crispy when
      // shot with a flamethrower, or players make a gurgling noise
      // when dying at the bottom of a slime-filled pit.

2000/10/27:

Added a separate blockmap for dynamic lights.  Seeing how this (and
future other stuff) chews up a lot of memory, added a -dlights option
to enable them.  Added `bbox' into subsector_t -- plus code to compute
the bbox when there are no existing nodes to get it from.

Experimented with some dynamic light code in TrueBSP renderer.

Improved ddf error information, by making various Cleanup routines
show the entry name/number when an error occurs.

Added the DDF code for dynamic lights: (things.ddf)

    DLIGHT.TYPE=LINEAR;      // lighting type (required)
    DLIGHT.INTENSITY=64;     // intensity (higher is brighter)
    DLIGHT.COLOUR=#00FF00;   // colour (default is white)
    DLIGHT.GRAPHIC=DLITE1A;  // graphic image (not yet used)

the type is one of: NONE (disables the dlight), CONSTANT, LINEAR or
QUADRATIC.  Also added the following new thing action:

    DLIGHT_SET(32);    // set intensity to new value.

2000/10/26:

Added SLIDER.DISTANCE command to lines.ddf to control how far open the
horizontally sliding door goes.  It is a percentage, defaults to 100%,
but values less than 80% or so won't work very well.  Updated blocker
to be like in XDoom: door becomes passable at 50% when opening, and
becomes blocked at 75% when closing.

Fixed player's initial health to come from DDF (removing the
hard-coded NORMHEALTH value).  Also fixed god-cheat for this.  Fixed
the face on status bar for this too.

Made Archviles not raise corpses blocked by solid extrafloors.

Allowed archviles to be able to raise dead players, but only if they
are on the same side as the player (i.e. SIDE=ABCD in ddf).

2000/10/25:

Fixed flat scrollers that scrolled the wrong way.

Fixed a HOM bug with THICK + TRANSLUCENT floors.

Implemented arbitrary sounds for things.ddf, attacks.ddf and
weapons.ddf.  There are two new actions (whose names were chosen to be
consisten with RTS), namely:

   PLAYSOUND(sfxname)
      // Plays the sound `sfxname', which refers to an entry in
      // SOUNDS.DDF.  The name in brackets must be present.

   KILLSOUND
      // Kills any sound currently playing by this thing/weapon.
      // Not very useful, except perhaps for looping sounds.

2000/10/24:

Added ddf code to parse `BitSets', which are a set of bits named `A'
through `Z', where each letter is either present or absent (in other
words: on or off).  A numberic value is also allowed.  Some examples
will hopefully make it clearer:

     bitset   numeric
     ----------------
       A        1
       B        2
       C        4
       D        8
       AB       3       // 1 + 2
       AC       5       // 1 + 4
       BC       6       // 2 + 4
       CD       12      // 4 + 8
       ABCD     15
       A-D      15      // NOTE: use '-' for ranges
       EFGH     240     // 16 + 32 + 64 + 128
       A-H      255     // 1+2+4+8+16+32+64+128

Updated the things.ddf SIDE command to use bitsets.  Doesn't break
backwards compatibility since bitsets can be specified numerically.

Added percent_t type to ddf_main.h.  Currently the semantics are the
same as before: an integer ranging from 0 (for 0%) to 255 (for 100%).
Updated the DDF structures (etc) to use this type and the
PERCENT_MAKE() and PERCENT_2_FLOAT() macros.

Added P_RandomTest() and M_RandomTest() routines, which take a
percentage parameter, and updated the various pieces of code that did
"XX_Random() < YY_chance" to use them.

Removed colmap.ddf command "PRIORITY" which was never used.

Implemented new ATTACK_CLASS for attacks.ddf, and IMMUNITY_CLASS for
things.ddf.  The idea is that certain monsters can be made immune to
certain attacks (i.e. they never get hurt by them).  Both commands
require bitsets.  If a monster is hit by an attack (bullet or missile)
which has e.g. ATTACK_CLASS=G and the monster has IMMUNITY_CLASS which
contains "G" (e.g. IMMUNITY_CLASS=F-H) then that monster won't be hurt
by the attack.  The default attack class is "M" for missile attacks,
"B" for bullet attacks, and "C" for close-combat attacks.  The default
immunity is 0 (none).

Note: attack classes should usually be single letters, but if they use
multiple letters then the monster needs to be immune to _all_ of the
classes to escape damage from the attack.

2000/10/23:

Added a "TUNNEL" thing special, that allows missiles to pass through
enemies (still damaging them though, but only once).

Tried to make a railgun weapon using DDF.  Got something not too bad
working (someone mentioned on our forum using the SMOKING action, and
they were spot on).

2000/10/22:

Implemented translucent text drawing code (for RTS TIPS).  Makes for a
very sweet tip-fade-out effect :).  Also added translucency support
for TIP_GRAPHIC.

Looked for a bug causing a massive slowdown in QD2 when doing
idkillall.  No luck yet (killing all the monsters manually doesn't
trigger the problem).

Oooh, seems the problem is related to GIBs and SKULLFLY and the recent
fix for zombie lost souls -- most of the ARM_GIB/CHUNK_GIB won't have
a target, thus they enter their IDLE states straight away, and keep
spawning more gibs, ad infinitum nauseamque !

Okay, the problem seems fixed.  There's still a pretty big slowdown
(which is temporary), not really surprising when spawning 8500 (!)
GIB_BLEEDING objects from 186 CHUNK_GIB and ARM_GIB objects, all from
a mere 35 initial KNIGHT-type monsters.

2000/10/21:

Removed the "no IDLE states, checking for SPAWN" message.

Fixed a bug when standing up (from crouching) when underneath a low
ceiling.

Disabled code in CON_Printf() which writes to the debugfile, to
prevent repeated text.  Consider it temporary, the output message
handling in EDGE desperately needs a major re-think.

Began working on overhauling the RTS tip system...  OK, cleaned up the
code and added the following primitives:

   TIP_SLOT  <num> 
       // Sets the current "slot" that future tip functions will use.
       // Each slot can display a single tip, independently of other
       // slots.  Slots are numbered from 0 to 31 (should be plenty),
       // where 0 is the default slot.  The set of slots is shared by
       // all triggers, but each trigger has its own "current slot".

   TIP_SET_POS  <x>  <y>  [ <alignment> ]
       // Change the positioning for the current slot.  X and Y are
       // _percentages_ for the on-screen position.  Default position
       // is "50% 50%" which is the center of the screen.  The third
       // argument is optional, and must be either "CENTER" or "LEFT".
       // CENTER causes multi-line tips to be centered horizontally
       // (the default mode), and LEFT causes left alignment.  Text
       // tips are always centered vertically.   For graphical tips, X
       // and Y specify the top/left corner position of the image.
 
   TIP_SET_COLOUR  <colourmap>  [ <translucency> ]
       // Changes the colouring for the current slot.  The name must
       // refer to an entry in COLMAP.DDF, for example "TEXT_YELLOW".
       // The second parameter is optional and gives the translucency
       // as a percentage: 0% invisible thru to 100% for opaque.
 
2000/10/20:

Added weapons.ddf command "SHOW_CLIP=TRUE", which shows a weapon's
current clip size in the ammo box on the status bar (rather than the
total ammo).  Generally improved the clip handling code.

Added the following things.ddf action:

   DROPITEM(thingref);

which causes the monster to drop the specified item.  The dropped item
is non-solid (but may be pick-up-able), and is dropped a random
distance away from the monster (so multiple drops don't all land on
the exact same spot).

Fixed the HOM problem with thick extrafloors that sit directly on the
floor, and cleaned up the code (somewhat).

Made the main DDF parser handle "properties" (which are commands
without data).  Thus "ABCD;" is treated as if it was "ABCD=TRUE;".
Updated the other DDF code to handle them as specials when not found
as actual commands (man, too easy :->).  Admittedly this approach is
hack-ish, but should work fine.

2000/10/19:

Renamed #XDEATH state redirector to #OVERKILL, removing the one
anomaly with state names.  Checked the DDF of EDGE and various other
projects, and nothing uses the #XDEATH redirector, thus no B.C.

Fixed a bug that parsed JUMP(OVERKILL,50%) wrongly.

Fixed a bug allowing jumping really high out of water regions.

DDF-itised the player viewheight.  The new VIEW_HEIGHT command takes a
percentage from 0% (foot-cam) to 100% (scalp-cam).  Defaults to the
standard doom marine's viewheight (75%).  Also used for monster sight
checks (though you'd be hard pressed to notice the difference).

Implemented crouching.  Uses the same key as `Move Down': when you are
standing on something solid then pressing it makes you crouch, and
releasing it makes you stand back up.  Requires the new CROUCH_HEIGHT
things.ddf command to be used (in player entries) which gives the
height of the player when crouching.  The default is 0, which disables
crouching.  The level special `NOCROUCHING' also disables crouching.

NOTE: player images not yet affected (won't be noticeable until we
have working multiplayer).

Updated missile shoot code to handle crouching.  Added things.ddf
command SHOT_HEIGHT which controls how high up a thing bullets are
shot from.  Like VIEW_HEIGHT it is a percentage: 0% shoots from the
foot, 100% from the scalp.  Affects both players and monsters.  The
default is 64%, the standard doom marine's shot height.

2000/10/17:

Added fix for the "lowering plats suck you onto them" bug.  Not
perfect since it takes 2 seconds or so to completely lose all
momentum.

Reworked the finite state machine code yet again, removing the
"deferred_state" field from mobj_t and adding a "next_state" field.
Similar for PSprites.  The JUMP() actions should work properly now.

2000/10/14:

Removed the patch marker checks from w_wad.c.  The engine never used
them in any way.

Renamed MapSetup() in w_wad.c to SortLumps, and simplified it.

Added a touch of XDoom compatibility: the SHOOTBLOCK and SIGHTBLOCK
linedef flags.

Added a new LINE_EFFECT type: "BLOCK_SIGHT" which works like
BLOCK_SHOTS, giving linedefs the SIGHTBLOCK flag.

Implemented colourmaps in GL rendering code, and removed the shading
effect.

2000/10/13:

Disabled the Vertex Array code.  Damn the bloody broken 3D drivers.

Cleaned up the FF_FULLBRIGHT hack.

Added DDF support for halos (rendering in GL to come soon), in
things.ddf as follows:

    HALO.HEIGHT=40.0;         // height from thing's base (required)
    HALO.COLOR=#FFA000;       // halo's colour (default: white)
    HALO.SIZE=32;             // size (on map) of halo, nominal
    HALO.MINSIZE=24;          // minimal size of halo
    HALO.MAXSIZE=96;          // maximal size of halo
    HALO.GRAPHIC="HALO3B";    // graphic name

(size of halo depends on distance, the idea being that it stays the
same ON-SCREEN size most of the time).

Fixed a bug making certain switches/doors really loud (there are
prolly some too quiet now -- tough).

Stretched skies horizontally in TrueBSP renderer, consistent with GL
renderer now and looks more natural (albeit rather blocky).

Noticed a neat idea in Udo Monk's XDoom port: for horizontally sliding
doors, use a texture animation.  Allows arbitrary styles of opening,
though it would need *many* frames to make it smooth.

2000/10/12:

Added NOSHADOW things.ddf special.  Such things never cast shadows
(e.g. bullet puffs and blood splats).

2000/10/11:

It occurs that with the new GL rendering method, supporting model
files for sprites might be fairly straightforward.  The sticky part is
clipping them horizontally and vertically -- hmmm... yeah, not simple,
but doing it on the granularity of whole polygons may give acceptable
results.

Fixed up the sky in the GL renderer.  I'm using the same method for
the vertical as for the horizontal: compute the angles and use 'em to
determine the texture row.  Also I'm skewing the sky by computing
separate horizontal angles for top and bottom.  With these changes,
plus horizontally stretching skies by a factor of 2 (when width is
less than 1024), the results are pretty good.

2000/10/10:

New "unit" code for GL is in place, it sorts the quads/polys based
primarily on texture (and secondarily on masking/blending) so that all
units with the same texture can be drawn at once, minimising state
changes.

Testing new unit code now...  Well, it surprises me just how buggy the
Voodoo 3 GL driver must be, enabling/disabling ALPHA_TEST or BLEND in
between different calls to glDrawArrays() results in stuff not being
drawn -- Argh !  

Anyway, the new GL code works, and the average speed increase is about
twice the framerate :-) :-).  Plus sprites now don't need to be split
horizontally, hmmm... Ok strictly speaking they still do, but glitches
will be *much* rarer now, so it can wait.

2000/10/09:

Fixed up the new text colourmap lumps, twelve of them in all.

Added new code to w_image.c/h for handling halos for GL.

Made several halo images, will be needed later.

Added two new LEVELS.DDF specials: "(NO)SHADOWS" and "(NO)HALOS" for
better control over the GL renderer.  Also done is "-(no)shadows" and
"-(no)halos" options.  By default shadows and halos are enabled (this
could change though).  Shadows and halos not implemented in software
renderer, shadows are a definite maybe, but halos prolly not (since
they would need new column drawers).

Tried once more rendering all walls/floors in GL with the same
texture, just to get some idea of how expensive texture changing is,
and man, what a difference it makes.  MAP01 is down from 95 ms/f to
less than 50, and MAP29 is down from 300 ms/f to less than 80.  I'm
now rather confident of getting *good* framerates in GL by (a) drawing
all walls/planes with the same texture at the same time and (b) using
the depth buffer (needed for (a)).  Overdraw seems less important now
-- getting EDGE or glBSP to split up large subsectors / long walls is
prolly the way to go.

Tried out OpenGL's client state stuff (glColorPointer etc).  Looks
ideal for what I intend to do next (batch rendering of polys).

2000/10/08:

Experimented with shadows in GL.  Quite nice :-).

Worked on doing Doom-like shading in GL.  Stuffed it up at first, it
was way too dark, but after fixing that it looks very homely :).

2000/10/07:

Looked for stuff in things.ddf with the wrong heights (I've noticed
that certain pillars and lamps can be walked over).

Ah good, the alpha test in OpenGL occurs before the depth test, which
means pure front-to-back rendering of everything non-translucent is a
real possibility.  Will it be faster though ??

Couldn't resist trying it, and... front-to-back + depth buffer is NO
faster, not at all.  :-(.  Somewhat surprising but not totally
unexpected.  It's clear now that the depth buffer is not there to
_speed up_ stuff, just there to make stuff WORK.

Conclusion: need to eliminate much more overdraw then now, e.g. only a
small portion of a subsector may be visible but currently we draw the
whole floor and ceiling planes.

BTW, now that lighting is disabled the "x86 stack overflow" error
message is back, and strangely enough the DOS box never crashed this
time.  Coincidence ?  I don't think so...

Experimental with halos.  So simple, yet look so good :-).

2000/10/06:

Looked for odd bug in new 1D buffer code...

Spent quite a while figuring out the `tspan' stuff occurring in the
polar clipping code, it looks deceptively simple, but it ain't.  The
"tspan - clipscope > span" was the hard bit -- now I know that it
checks whether the angle range (angle1..angle2) crosses e.g. the left
clip angle and discards the line/node if it doesn't.  Replaced it with
something (I hope) is more readily understandable.

For some reason translucent planes stopped being translucent when
LIGHTING and COLOR_MATERIAL were enabled, and fucked if I know why.
Not too concerned, they are disabled now.

OK, enough GL work for now.  Complex scenes are still very slow,
overdraw is prolly more of an issue than previously thought.

2000/10/05:

Made screenline_t inline in the truebsp structures (rather than a
pointer), all the code assumes one-to-one correspondence.

Converted GL code for things/patches/mid-maskers to use the ALPHA_TEST
rather than BLEND where possible (I assume it's faster).

Fixed the clipping in GL to handle mlooking far up/down.  No more
missing bits :-).

2000/10/04:

Wrote new GL 1D occlusion buffer code, using angles rather than screen
pixels like in the software renderer.  The code supports 4096 angles
between 0 and 180 degrees -- should be good for resolutions upto 1600
wide (maybe upto 2048).

Worked on improving the GL renderer, using the new 1D buffer.  Didn't
count on the polar clipping in there :), ouch...

Added better control over GL mipmapping in w_image code.

2000/10/03:

Played some more with GL dynamic lights with Voodoo 3 on Win98 (god
damn windows is shite, had to manually reset about 5 times after the
DOS box went into "zombie" mode after running GLEDGE).  Looks like the
Voodoo 3 doesn't do light attenuation (GL_LINEAR_ATTENUATION and
GL_QUADRATIC_ATTENUATION).  (Could be I programmed it wrong, though
it worked with Mesa).  Prolly better to compute it overselves.

Experimented with various GL stuff (in Linux/Mesa), such as using the
depth buffer.  It's possible that drawing non-extrafloor solid stuff
on the way down the BSP could give a speed boost (e.g. the big upper
at the start of MAP29 would get into the depth buffer straight away,
theoretically making stuff drawn behind it faster).  Not sure yet if
stuff like sprites and extrafloors would work properly this way.  Will
need to test how big (if any) the real (i.e hardware) speed up is.

2000/10/02:

Cleaned up various straggler colmap lookups (e.g. "DIMSCREEN",
"FUZZSHADOW", etc), doing the lookup now in V_ColourInit().

Removed I_MakeColourmapRange from the EPI interface (moving the
functionality into v_colour.c), and added "grey_mask" to the
I_GetTruecolInfo structure.

Argh, bitten again by the startup sequence, this time the fact that
V_InitColour() doesn't get called until _after_ a map has loaded when
using -warp (the graphics only get initialised at the last minute).

Changed the EPI interface: added a `grey_mask' field to the structure
returned from I_GetTruecolInfo().  This allows the main code to
improve greyscale colours when in RGB 5:6:5 (since normally the extra
bit of green gets out of sync, causing pink/green tints).

Updated video code of each port in CVS, removing I_MakeColourmapRange
and fixing I_GetTruecolInfo.

Added a "-nointerp" option to disable interpolating colourmaps.
[Decided to keep interpolation enabled by default, since it looks a
lot better].  BTW, The new "greyscale friendly" colour code really is
an improvement (both with & without interpolation).

Removed the colmap.ddf NOSKY special -- pretty non-useful.

Fixed the DDF parser to allow commas within () brackets.

Removed the sounds.ddf BITS and STEREO commands.  For BITS, a better
alternative would be to support WAV files directly as lumps.  For
STEREO, well it doesn't make much sense (apart from sounds heard only
by the player, and that case can be handled using WAV lumps too).

Restored mlooking in GL to its former glory, and will soon code up the
new algorithm which will prevent the disappearing bits.

Played around with vertex lighting and dynamic lights in GL.  Former
looks promising, latter looks complex to achieve.

2000/10/01:

Began working on extrafloor-friendly sight/aim/shoot code.  Already
noticed a silly bug in DivlineSide() that appears to have been there
since the original source release !

Woah, I've counted *5* functions that more or less do the same thing:
DivlineSide (p_sight), P_PointOnLineSide & P_PointOnDivlineSide
(p_maputl), R_PointOnSide & R_PointOnSegSide (r_main).  (The comment
on R_PointOnSide had me going... it does NOT traverse the BSP tree).

OK, merged those 5 functions into just two in p_maputl.c, namely
P_PointOnDivlineSide and P_PointOnDivlineThick.  They are different,
the former only checks for left/right, the latter checks also for "on"
conditions and requires two extra parameters: line's length and line's
thickness.  Thick checking will be used by the sight/shoot code to
prevent missing a thing poking out of a subsector when the sight/shot
is going parallel to (and close to) the subsector's edge.

2000/09/30:

Made P_ActRangeAttack and P_ActMeleeAttack in p_action.c allow a NULL
target -- we'll let the specific attack routine decide if it needs a
target.  With that in place, fixed the idkillall "Zombie Lost Soul"
bug, due to the fact that the lost soul MISSILE states require the
range attack to have a target, otherwise MF_SKULLFLY doesn't get set
and thus the lost soul could never leave the MISSILE:3/4 states (which
loop doing nothing -- it depends on the p_mobj.c MF_SKULLFLY code).

2000/09/29:

Added a new "BLOCK_SHOTS" special for things.ddf.  Things with this
flag will block bullets and missiles (unlike standard Doom behaviour
where bullets/missiles can pass through all scenery items).

The BOOM translucency linetype (#260) is now supported, using
LINE_EFFECT=TRANSLUCENT in lines.ddf.  The LINE_EFFECTs work like
this: if tag is 0, then just that line is affected, otherwise all
lines with the same tag are affected (possibly ignoring the tagging
line, depending on the effect).

Added fixup for linedefs lacking a right sidedef (as in MBF).

Righteo, more BOOM linetypes have been coded (as many as I intend to
do right now).  Firstly, BOOM linetypes 250-253 are now supported
using these SECTOR_EFFECT tags: "SCROLL_FLOOR", "SCROLL_CEILING" and
"PUSH_THINGS".  Linetypes 254 and 255 are supported using these
LINE_EFFECT tags: "VECTOR_SCROLL" (exclusive) and "OFFSET_SCROLL".
Will prepare the new DDF entries soon.

New stuff:

   The ability for 2S lines to block bullets & missiles is given by
   the LINE_EFFECT tag "BLOCK_SHOTS".  It works like #260, i.e. all
   lines with same tag are made blocking to shots.  It should only be
   used with AUTO=TRUE (i.e. enabled at level start).
   
   The ability for 2S lines to become non-blocking to players and
   monsters is given by the LINE_EFFECT tag "UNBLOCK_THINGS"
   (exclusive).  Meant to be used dynamically, e.g. to unblock a set
   of non-deaf monsters as the player enters a new region.
 
   The SECTOR_EFFECT tags "RESET_FLOOR" and "RESET_CEILING" turn off
   any link-lighting/scrolling/push that was previously transferred to
   the tagged floor/ceiling.  E.g. turn off that conveyor belt.
   
   The SECTOR_EFFECT tags "ALIGN_FLOOR" and "ALIGN_CEILING" are used
   to change the offset and/or orientation of a tagged floor/ceiling.
   Useful to make that teleporter texture line up (even when the
   teleporter pad is at a 45 degree angle !).  This is a feature I've
   wanted to implement for a long time, and the BOOM-style property
   transfer was an elegant way to support it.

   The SECTOR_EFFECT tags "SCALE_FLOOR" and "SCALE_CEILING" are used
   to change the scale of the texture on the tagged floor/ceiling.
   The linedef's length sets the scale: 64 units is normal (that value
   should sound familiar, as flats normally tile on 64x64 boundaries).
   128 units would be twice the size (i.e. the flats would tile on
   128x128 boundaries), and 32 units makes them half the size.

   (As it stands, this feature is only moderately useful, but when
   larger flat _images_ are supported (e.g. 128x128 and 256x256) then
   this will allow _both_ high detail flats and large-area-coverage).
   
   The LINE_EFFECT tags "SKEW_TEX" and "SCALE_TEX" are used to control
   texture skewing and scaling on walls.  SKEW_TEX uses the *X* offset
   from the first sidedef as a skew factor: which is the number of
   pixels that the end of a 128-long wall is shifted up or down
   (positive for up, negative for down) relative to the start.  It's
   the same angle regardless of how long the wall is.  E.g. +128 is 45
   degrees up, -128 is 45 degrees down, 0 is horizontal.
   
   The SCALE_TEX tag is not implemented yet, but works like the
   floor/ceiling scalers.  The linedef's length sets the scale: 128
   units is normal (remember, most wall textures are 128 units high).
   Using 256 makes the texture stretched out to twice the size,
   whereass 64 makes the texture squished to half the size.  This
   scheme was chosen since in practice one of the walls to scale can
   often hold the linetype (not requiring a dummy linedef somewhere).

Note 1: x/y offsets for scaled walls/floors/ceilings behave as if the
walls/floors/ceilings were not scaled.  In other words, x/y offsets
should be considered as *map* offsets (along the wall or floor) rather
than offsets with the texture.  This has some consequences:

  -  Scrolling walls/floors/ceilings will scroll at the same
     observable speed regardless of the scaling of the textures
     involved.

  -  The control over higher-resolution (scaled-down) textures is
     poorer than normal, e.g. on a wall with 4X texture detail, each
     unit of X offset moves 4 pixels of texture.

Note 2: some LINE_EFFECTs (namely: VECTOR_SCROLL, OFFSET_SCROLL,
SKEW_TEX and SCALE_TEX) can be controlled using the SCROLL_PARTS
lines.ddf command, limiting the change to certain side parts.  The
defaults are: for scrolling, top/middle/bottom on the RIGHT side only,
and for textures: top/middle/bottom on both sides.

Note 3: TEXTURES.DDF, when implemented, will make these scaling
linetypes less useful (as the scale will be specifiable as a property
of the texture/flat).  Nevertheless they will work together exactly as
expected (the scaling is accumulative).

Note 4: For me, support for high detail (and non-paletted i.e. RGB)
textures and sprites is quite important.  One of the things that makes
Doom engines pale in comparison to e.g. the Quake trinity is the
obvious low resolution of the graphics (less so with GL's bi- and
tri-linear filtering, but still).  (It's not the only thing, of course
lighting plays a big role).

2000/09/28:

Began paving the way for other BOOM property transfer linetypes.  This
involves two new lines.ddf commands: SECTOR_EFFECT (mentioned earlier)
and LINE_EFFECT.  These take flag names to enable a certain property
transfer (e.g. CEILING_LIGHTING).  LINE_EFFECT is for line -> line
effects, and SECTOR_EFFECT is for line -> sector effects.

Simplified the line and sector special lists in p_spec.c, and added
checks for already being linked in.

Made `scroll_parts' in linedeftype_t default to 0 instead of RIGHT,
thereby removing the special check that used to be there, and allowing
SCROLL_PARTS to be used by other stuff...

Investigated using standard image formats for graphics within WADs.
Some issues are:

  1. Specifying X/Y offsets for sprites.  Targa and PNG have provision
     in the format for these values (as screen offsets, but not sure
     if negative is allowed).  JPEG and BMP don't have this.  For
     Targa (TGA) and PNG, it may be hard for users to set these X/Y
     values (e.g. the GIMP here has no facility for setting the values
     when saving).  JPEG is mainly useful for wall/floor textures
     rather than sprites/mid-maskers.

  2. Handling translucency.  PNG has explicit support, Targa looks
     possible too, but seems JPEG doesn't.  Again the issue of users
     being able to create and save images that contain the proper
     translucency/alpha parts.  Deutex uses a magic colour value
     (palette index #247 and RGB colour #002F2F).

  3. Being able to specify the scale of an image would be useful
     (rather than use methods separate from the image).  PNG has some
     "resolution" fields that could be (ab)used.  Not sure about other
     formats.
 
If we cannot rely on such info being present in the image format (and
it seems we can't), then we need another place to put it.  One
possibility is allowing a special header before the standard image
format, like this:  

   +  4 byte magic identifier: "Edge".
   +  4 byte image type (the usual extension e.g. "PNG").
   +  4 byte transparent colour, or -1 if none.
   +  2 byte X offset.
   +  2 byte Y offset.
   +  2 byte scale value (256 is normal).
   +  2 bytes of zero, reserved for future use.

It would be optional, reasonable defaults being used when absent,
namely:

   +  Autodetect file type (PNG and JPEG are OK, Targa NOT OK).
   +  X offset = 1/2 image width.
   +  Y offset = image height.
   +  Scale = 1.0.
   +  Transparent colour is -1 for ceilings/floors, 247 when image is
      palette, or #002F2F when image is RGB.

Hmmm......  The downside of any new format is the requirement for new
tools to convert them and/or insert them into a PWAD.  That means we
need to get it right, e.g. it might make sense to allow a whole lump
to be a mini wad containing a whole set of sprites and textures (with
a text file to describe all the INFO) rather than replace each
sprite/patch/flat lump individually.

2000/09/27:

New polygonisation code turned out to be pretty crash hot.  NOT !
Bugger.  The idea might still have some merit for just producing the
minisegs though.  For now I'll reinstate the old version.

Restored mid-masked pegging code in the classic renderer, which
accidental got removed with the old extrafloor code.

Added support for extrafloor pegging.  The `LOWER UNPEG' bit on the
linedef _tagging_ the extrafloor (i.e. the one in the dummy sector)
makes the side texture aligned to the bottom of the thick extrafloor.

Added support for "Link Lighting", where the lighting on the floor
and/or ceiling is controlled by other sector.  The idea comes from
BOOM, and mainly used with the following DDF linetypes:

    // Transfer lighting to tagged floor (Boom)
    [213]
    TYPE=PUSH; ACTIVATORS=PLAYER;
    AUTO=TRUE; SECTOR_EFFECT=LIGHT_FLOOR;

    // Transfer lighting to tagged ceiling (Boom)
    [261]
    TYPE=PUSH; ACTIVATORS=PLAYER;
    AUTO=TRUE; SECTOR_EFFECT=LIGHT_CEILING;

Note: the SECTOR_EFFECT command can have both at once.

2000/09/26:

Added four new ammo types: PELLETS, NAILS, GRENADES, GAS.  (Not the
greatest names, but using DDF they can be whatever the TC author wants
them to be).  Now there are eight ammo types, should be plenty.

Began reworking the polygonisation code (r2_poly.c), to use a faster
and more robust algorithm.

2000/09/25:

Implemented proper support for MP3 under Linux/OSS.

Did the same for Linux/SDL.

Added `-sounddev' option for Linux/OSS which can be used to set a
different output device than the normal one (/dev/dsp).

Created i_fmpat.c (under Linux) which contains OPL2 patch files, to be
used when GENMIDI is unavailable (e.g. when using our EPI elsewhere).
SOURCE was Allegro.  The new option `-allegfm' forces EDGE to use
these patches.  I'm not 100% sure the conversion is correct, but most
music plays reasonably well (a notable exception is our title music).

2000/09/24:

The DDF file reader now handles missing files as if they existed but
contained no entries (showing a warning message).  This is an attempt
at better B.C. by allowing new DDF files to be introduced but not
_requiring_ their presence.  Whether it works in practice remains to
be seen, in future DDF files (like the proposed HUD.DDF or MENU.DDF)
their entries are likely to be required by the engine just to run.

Fixed the bug where monsters could get stuck on the edge of a lift
when it goes back up.  Solution: allow edge walking whenever the
monster was already on an edge.

Fixed the bug where monsters could get stuck in mid air after climbing
onto the player or another monster (quite noticeable in MAP01).

Been a long time, but finally fixed the `Ride Em' code, allowing
players to ride monsters/players/etc..  The new RIDE_FRICTION command
in things.ddf controls how ridable an object is, 0.0 would make things
slip off right away, up to 1.0 which is perfect ridability.  Default
is 0.8, which makes you slip off after going a small distance.

2000/09/22:

Implemented a "-version" option that just shows what the version of
EDGE is.  Other similar options may come later (e.g. "-help").

Added some support for the "FRIEND" thing flag that map editors can
set (it originated from MBF of course, it's the "F" in "MBF").
For EDGE, this means the spawned monster is on everybody's SIDE.
Unfortunately it doesn't work `out of the box', monsters need the
SUPPORT_XXX code pointers.  Hmmm...

Made monsters resurrected by an Archvile become on the same side as
the Archvile (as in MBF).

Restored the SCROLL_ANGLE and SCROLL_SPEED code for sectors.ddf (I had
accidentally removed them when adding the ddf sub-field support).

Implemented BOBBING command for things.ddf, takes a percentage for how
much the player's head should bob up and down while walking.  Also
implemented BOBBING and SWAYING commands for weapons.ddf for how much
the weapon will (a) bob up and down (b) sway left and right.  Removed
the now-unneeded ``NOBOB'' thing special.

2000/09/21:

Worked on coding up (in DDF) as many BOOM linetype as will work in the
current code base (about 75% I estimate, most of the excluded ones are
property transfer (Wind/Friction), line teleports, and scrollers).

Ouch, the LIGHT_LEVEL=0 thing is a real hack.  Should fix it to accept
"HISURROUNDING" and "LOSURROUNDING" values (the latter needed for Boom
and to fix linetype 104).

Removed some old unused guff from w_wad.c.

Added a new lighting type for levels.ddf: "DOOMISH".  It's the same as
normal doom, with one exception: walls that lie N/S are not made a bit
brighter and walls lying E/W are not made a bit darker.  Also fixed
that N/S/E/W thing for the TrueBSP renderer.

IDEA: for vertex lighting, recompute levels on-the-fly (i.e. when the
renderer notices the level is VTX_UNSET).

Implemented "FLAT" lighting in the old renderer.

Removed EXTRAFLOOR_TRANSLUCENCY command from DDF.  The code now just
used the TRANSLUCENCY value.

Removed extrafloor code from classic renderer.  TrueBSP renderer does
them much better now.

2000/09/20:

Did some tidying up of the lighting code, and added a new FADE type
which is like SET, but fades the light to the desired level.  Added a
LIGHT_STEP command which controls how big a step the GLOW and FADE
types change the light level at each interval (default is 8).  Also
renamed LIGHT_PROBABILITY to LIGHT_CHANCE and made it a percentage.

For exit line/sector types, the recommended values are now
EXIT=NORMAL; and EXIT=SECRET;  Backwards compat. has been maintained
though.

2000/09/16:

Been busy building my own entry into the DoomWorld 10 Sectors contest
recently...  Hard work, but fun :-)

2000/09/09:

The package/release part on SourceForge sucks too much, so I've
decided to put the downloads on a separate webpage and stay sane.

2000/09/08:

Well fuck me, I'm uploading the glBSP packages to SourceForge and
someone there must be a real sadist, since it is *painful* !  Jeez,
not sure I wanna go through this shit again, next time I'll be sorely
tempted to just put the files on a webpage and save the hair...

2000/09/06:

Downloaded and installed DJGPP V2.03 today.  Unfortunately it didn't
fix the problem in glbsp (except that it no longer crashes, an out of
memory error is produced instead).  Looked hard for a memory leak, and
tested (under Linux) the memory usage: (a) no more than 9MB is ever
used (not taking overheads into account) -- there's no way that should
be a problem on a 64MB machine.  (b) there are *no* memory leaks,
clearly showed by the last few lines of the debug log:

    Total Mem: 176  (free)
    Total Mem: 128  (free)
    Total Mem: 120  (free)
    Total Mem: 72  (free)
    Total Mem: 66  (free)
    Total Mem: 18  (free)

(the remaining 18 bytes was for the output filename).  I'm at a loss
to explain what the problem can be.  Bummer.

2000/09/05:

Fixed a bug in W_CheckTextureNumForName() that could cause EDGE to
crash when looking for a lump name greater than any existing lump
name.

2000/09/04:

Something is making the DOS version of glbsp crash at certain
reproduceable places.  The crash always occurs inside realloc(), so I
suspect some bug or issue with DJGPP, seeing how glbsp is running fine
under Linux and Win32.  Of course tracking this down will delay the
V1.91 release, bloody.

2000/09/03:

Added a fix to r2_bsp.c for the "cracks on translucent water" bug.
Tested to make sure it doesn't introduce thin gaps of HOM: seems OK.

Rewrote DDF_MainSplitIntoState(), to allow `:' characters inside
brackets, e.g. "JUMP(FLASH:2)".  Needs testing.

Changed label format again, now it is "@NAME:SPRT:5:.....".  Added
support in ddf_stat.c code for "LABEL:offset" within JUMP().

Fixed a slimetrail producing bug !  Problem was trying to draw the
ceiling plane in r2_bsp.c when floor height == ceiling height.

2000/08/29:

Added duplicate sidedef detection (-packsides) to glbsp, and sped up
the duplicate vertex detection.

OK, completed the last coding "must do" from the glbsp TODO list.
Just some documentation work now, and I'll be ready to release !
(Oh, do some testing too !).

2000/08/28:

Added full SECTOR and SIDEDEF reading/writing code to glbsp.  The
unused sector/sidedef pruning code should actually work now.

Added code in glbsp to keep superblocks on a quick-alloc list.

Changed superblock leaf size in glbsp to 256x256 which was just a fast
as 128x128, but will save more memory.

2000/08/27:

Righteo finished reworking the glbsp code, from a normal seg_list to a
"super block" seg_list.  This is a binary tree of blocks, from largest
at root to smaller and smaller blocks (down to 128x128), and each seg
is kept in the smallest block that it fits in.  This should hopefully
speed up node picking quite a bit (as a whole block, including
sub-blocks, can be handled at once if it doesn't intersect with the
partition line in question).

2000/08/26:

Improved the AppendLevelLump() routine in glbsp, potentially speeding
it up slightly in certain cases (e.g. blockmap).

Totally reworked the blockmap code in glbsp, not only is it massively
faster but now it packs the blockmap too.

2000/08/25:

Added a W_LumpRawInfo() routine to w_wad, to be used by the music code
for retrieving the lump info that the L_MP3 code needs.

Fixed a bug that selected the null weapon when picking up shells +
holding the rocket launcher + lacking any shotgun.

Tidied up glbsp EvalPartition() code.

Got a huge speed boost in glbsp's SortSegs() routine by using qsort
instead of the good ol' Double Bubble.

2000/08/24:

Renamed "SOUND" command in switch.ddf to "ON_SOUND", making it
consistent with the new "OFF_SOUND" command.

Added support to the l_mp3.c code for reading lumps.  One gotcha: the
w_wad.c will move the file position when lumps are being loaded, thus
an lseek() was needed.

2000/08/23:

Discovered that (in glBSP) choosing the first partition line takes
roughly *half* the total node-building time for large levels.  Woah.

Added support to glBSP for removing unused sidedefs and unused
sectors.  Also, the -noprune option prevents all pruning.

Began work on seg grouping for glBSP, which hopefully will give a
significant speed-up.

Removed the FLAT_LIGHTING level special, and replaced it with the
following levels.ddf command:

   LIGHTING=FLAT;

the default value is "DOOM" (normal Doom lighting).  Other lighting
types may be possible in the future (e.g. "VERTEX").

Added a STATS command to levels.ddf, used to determine the type of
stats shown in the intermission.  Possible values are "DOOM" (normal
Doom stats) and "NONE" (have no stats at all).  Other types may be
implemented in the future (e.g. quake-like, wolf-like, etc).

2000/08/22:

Found a fix for the bug with ``Voodoo Dolls'' (e.g. Eternal MAP26),
namely adding DISLOYAL and ATTACK_HURTS to the player DDF entries.

IDEA: r2_poly.c: build nodes like glBSP, but the hard/slow part
(choosing partition lines) has already been done (use the plain nodes
from the PWAD) so it should be reasonably fast, and saves all that
"fixupseg" crap that it does now.

2000/08/21:

Added a "-nowarn" parameter to EDGE.  Turns off warnings from DDF and
RTS (which can get very large when using old stuff).  Doesn't affect
all warnings yet (stuff calling I_Warning() directly) -- this can wait
until the discussed warning code overhaul.

Downloaded numerous node/reject utilities, not only do they include
source code :-), but most of them are under the GPL !  This is good
news for glBSP, I'll be able to "borrow" any ideas or even source
(giving credit of course) to make glBSP better, in particular I intend
to add REJECT building code (someday...).  One good idea that has
already caught my eye is "blockmap packing"...

Worked on improving the TrueBSP sprite woes.  In "sprite nice" mode,
missile explosions will be truncated on floors/ceilings and everything
else will be moved up/down to fit.  Not ideal, but there's simply no
good way of properly handling YOFFSET < HEIGHT that's gonna work 100%
reliably and still be fast.

Fixed -strict and -nowarn so they work when in external DDF mode.
Problem was the checks were done in SetGlobalVars(), which gets called
*after* external DDF files are read.  Ick.

Fixed a bug in TrueBSP that clipped sprites (esp. explosions)
horizontally against a closed door.

Added check for sidedefs (prolly unused) which have sector #-1.

Added "-spritekludge" option.  The default is "nice" mode as described
above.  Using this option invokes the earlier behaviour (producing
overdraw glitches in certain places).  Using "-spritekludge 2" turns
off horizontally sprite clipping too.

2000/08/20:

Added code to glBSP to increase the cost of a partition line when
there are "near misses", i.e. segs that don't intersect but where one
end is very close to the partition line.  The idea is to prevent small
segs being created in _future_ processing.

2000/08/19:

Been working on glBSP, managed to get it working again after the
floatification (numerous things needed fixing).  Main things left to
do now are testing, optimising, & tidying up.  Oh yeah, also need some
fudging code in the case where V1 segs become zero length due to
rounding !

2000/08/17:

Created an "edge.ygd" for yadex, based on the doom2.ygd file.

2000/08/16:

Fixed the "coalesce" (sector tag >= 900) handling in glBSP.

2000/08/15:

Started work floatifying glBSP, and adding support for "v2.0"
vertices.

Seems some pwads have bad sidedefs with sector numbers of -1, causing
glBSP to stop with an error message.  The original BSP 2.3 would just
show a warning and continue, so I'll fix glBSP to do the same.

2000/08/14:

Did some work on the monster sight code.  The bug where monsters could
see you over a large (but 2S) wall has been fixed.

2000/08/13:

Fixed a bug in reduction_code calculation in l_mp3.c.

Removed two more bastard sound effects, from wi_stuff.c, now sfx_slop
and sfx_pldeth are not used anywhere.  In their stead are the
following new commands in GAMES.DDF :

   ACCEL_SOUND="SLOP";
   FRAG_SOUND="PLDETH";

Thus the number of bastard sound effects remaining is 15...

OK, sfx_itmbk is now gone (the DDF respawn object makes the sound, we
don't need any extra code to make it).

Righteo, sfx_noway is now gone, and sfx_oof usage is halved.  The
players in THINGS.DDF require the following:

   NOWAY_SOUND="NOWAY";
   OOF_SOUND="OOF";

Removed another hard-coded sound usage, our SWITCH.DDF file now
requires the following for each entry:

   OFF_SOUND="SWTCHN";

Okidoke, that's about all of the bastard sound effects that can be
easily removed.  Most of the remaining usages are in the menu code
(ideally we need some kind of MENU.DDF to specify the sounds), and the
jetpack sounds (there are 5 of them, too many to bung into THINGS.DDF
for such a rarely used feature I think).

2000/08/12:

Tidied up the L_MP3 code, it's much neater now.  The current code can
handle channel number and bit-size differences between MP3 file and
sound device (all done via XingMP3's convert_code par -- sweet), and
will choose a reduction_code that best suits the sound device's sample
rate.  Improved the EOF handling, with a new L_MP3RestartMusicFile()
routine to restart the music.

Made a new TEXTMAPS lump, to be used with the image system.  Contains
14 colours each with 6 different shades, so the lump is large (21K),
but compresses well.

2000/08/11:

Got some preliminary MP3 playing code going.  Nice.  Needs more work
though, e.g. handling samplerates and/or channels different from the
audio output device (not to mention 16 bit sound).

2000/08/10:

Allowed the `rejectmatrix' to be NULL.

Removed the old CF_NOMOMENTUM crud, and cleaned up CalcHeight() in
p_user.c.

Did a fix for the "slide really fast along walls" bug, by passing the
desired position to P_SlideMove.

2000/08/09:

Damn it, another hard-to-track-down bug caused by accidentally putting
a semicolon at the end of an "if" or "for" line.  C sucks (and prolly
C++/Java too if they allow this), been bitten way too many times by
this.

Implemented new routines in p_maputl.c for checking if any things lie
in a certain area or touch a certain line.

Modified PIT_CheckRelThing so that *anything* (not just missiles) will
pass through the monster or player that shot/ejected it.

Changed `isaline' field of intercept_t to an enum.

2000/08/08:

Added the code for sliding doors to check if any objects would block
the door (causing the door to try closing later, maybe indefinitely).

Fixed the sliding door code to handle COUNT values, i.e. the door will
stay open on the last (perhaps the only) activation.

Had an idea for blockmap generation: do it recursively.  At each
stage, divide the lines into three lists (e.g. left|center|right) and
call each side recursively.  When we reach a single block, we then
know which lines are in it.  The simplicity is very appealing, the fly
in the ointment though might be managing the lists in a nice way.

2000/08/06:

Fixed a bug in some BSP code, which was skipping segs for potential
partition lines which it shouldn't have.

Implemented *thin* horizontally sliding doors.  The following is used
in lines.ddf:

   SLIDER.TYPE = LEFT;    // also RIGHT and CENTER
   SLIDER.SPEED = 2;      // open/closing speed (distance per tic)
   SLIDER.PAUSE_TIME = 150T;  // time to pause after opening
   SLIDER.SEE_THROUGH = FALSE;  // the texture is see-through or not
   SLIDER.SFX_START = XXX;  // sound made when door starts moving
   SLIDER.SFX_OPEN = XXX;   // sound made while door opens
   SLIDER.SFX_CLOSE = XXX;  // sound made while door closes
   SLIDER.SFX_STOP = XXX;   // sound made when door stops moving

the type gives the opening mode, LEFT and RIGHT make the _front_ side
of the door open in that direction.  CENTER makes it open from the
center.  The linedef must contain a middle texture on both sides, and
when SEE_THROUGH is TRUE then this texture must be completely solid.

There are some limitations though: (a) a sliding door cannot be used
with extrafloors (i.e. above or below it).  (b) bullets and objects
cannot pass through a partially open/closed door yet.

2000/08/05:

Implemented an MTF_MEANDER flag, which makes monsters start off in
their MEANDER state instead of the SPAWN state.  Bit of a hack, might
clean up the meander/path-following stuff one day.

Finally implemented DDF sub-fields (e.g. FLOOR.TYPE and PRE.TEXT)
properly.

2000/08/03:

Added a "NOBOB" thing special, which makes the player not do the
characteristicly DOOM bobbin' thang when they walk.  For TC dudes.

2000/08/02:

Began writing an XingMP3 wrapper for EDGE.  One issue has come up:
reads or writes that would be split at the ring buffer's end.
Probable solution: limit them (& ring buffer) to power-of-two sizes.

Hmmm, XingMP3 virtually undocumented, makes it hard to use...
Okidoke, from the source it seems I can assume: (a) input bytes
required by decoder is never more than 2 * framebytes, and (b) output
bytes never more than 8K at a time.

Sometimes the best solution for a problem isn't the most obvious one.
That goes for that GL "black fog" stuff mentioned below, a much more
robust method is to just compute the vertex distance and lookup white
in the appropriate colourmap and let GL's natural colour interpolation
do the work.  Will implement this soon.

2000/08/01:

Done with the blockmap reworkings.  The only part I didn't rework was
the diagonal line handling stuff, after looking at that code plus the
P_CreateBlockmap() code in both Boom and MBF, still don't "get it".

2000/07/31:

After pulling hair out over some BSP code, discovered a stupid bug in
the M_AddToBox() function in m_bbox.c.  That bites !  Anyway, fixed
the other bugs in that BSP code.

Started work fixing the GenerateBlockMap() function.  There will be
command line option to use it instead of the BLOCKMAP lump, namely
"-blockmap" (the same option as in MBF).  Converted the actual line
data *back* into unsigned shorts (65000 linedefs is a helluva lot,
besides the node info doesn't allow more), and made the array of
offsets into an array of pointers.

2000/07/29:

Added "root_node" global variable, which is just NF_SUBSECTOR when
there are no nodes, cleaning up some little bugbears.

2000/07/27:

Cleaned up some stuff in p_switch.c, and added support for switches
with the new w_image system.  Added a "TIME" field for SWITCH.DDF
which is how long the button stays with the ON texture until it
changes back to the OFF texture.  (Previously it was hardcoded to one
second).

Renamed "SOUND" field in LINES.DDF and SECTORS.DDF to "AMBIENT_SOUND"
to be more accurate and to allow other types of sounds.  The code for
ambient sounds (DoSectorSFX etc in p_spec.c) should be moved/reworked
to generally support all kinds of looping sounds better.

Added "ACTIVATE_SOUND" field for LINES.DDF.  This sound will be played
when the line is activated.  It will override any sound defined in
SWITCH.DDF.  Removed the hardcoded check in p_switch.c to make exit
switches use the SWTCHX sound, our ddf should use ACTIVATE_SOUND
instead.  (One less bastard sound effect :->).

2000/07/23:

Added new structure "condition_check_t" to ddf_main.h.  This will be
used by RTS to allow checks for keys, powerups (like invisibility, so
that you can have triggers that must "see" you), and so forth...  It
will also be used for the sprite override system.

Wrote G_CheckConditions() to do those checks.  Just need some parsing
code in RTS now.

2000/07/22:

Added a DDF_MainGetRGB function, which parses an rgb colour of the
form "#RRGGBB" (i.e. same as in HTML).

Added a "GL_COLOUR" field to colourmaps in colmap.ddf.  The value is
an rgb colour as above.  Will be used to colourise font images in the
GL renderer.  Example:

   [TEXT_GREEN]
   LUMP="TEXTMAPS";
   START=2;
   LENGTH=1;
   GL_COLOUR=#00FF00;   // green

Updated the VCTX interface (and everything using it) so that the
DrawImage() function takes a pointer to a colourmap_t instead of a
colour index value.  Much cleaner now.

Tested GL renderer with this VCTX change, works nicely: the pause
image is properly greenified.

Experimented with GL's FOG, to simulate the normal Doom lighting.
Looks promising, and prolly a good way to implement underwater-type
effects too (which are done with colourmaps in the software renderer).

Added the following fields for colmap.ddf:

   GL_FOG_COLOUR=#808080;   // grey
   GL_FOG_FACTOR=3000;
   GL_FOG_BASE=1000;

this allows TC authors to create GL fog effects that resemble the
software colourmap effect.  The amount of fogging depends on the light
level of the sector: the light level (from 0.0 to 1.0) is multiplied
by GL_FOG_FACTOR and added to GL_FOG_BASE to determine the GL fogging
density.  The default is to provide the "black fog" to simulate normal
Doom lighting.  Also, GL_COLOUR will affect to everything drawn in the
colourmap (it defaults to WHITE, meaning effect).

2000/07/21:

Implemented a new level special "FLAT_LIGHTING".  When used, removes
the so-called "black fog" effect that is very characteristic of Doom.
Another one for TC authors.  Tried it out... definitely different,
pretty dull really, levels would need to be designed specially with
this in mind.

2000/07/20:

Tidied up the JUMP() action so that it doesn't do a label search every
time it is used.  Implemented JUMP() for weapons too.

Renamed "delta_vis" in mobj_t to "vis_target" which is a more accurate
description.

Added visibility and vis_target fields to psprite structure.  Once
there are some weapon actions for it, this will allow translucent
flashes and other effects.

OK, two new weapon actions for this are there:

   TRANS_SET(50%)
   TRANS_FADE(20%)

they take a percentage value in brackets, 0% is invisible, 100% is
totally visible.  TRANS_SET is instantaneous, but TRANS_FADE makes the
translucency fade toward the given value over a second or two.

Removed the following thing actions: ALTERTRANSLUC, ALTERVISIBILITY,
LESSVISIBLE and MOREVISIBLE (i.e. ones still using the misc1/misc2
state fields).  Their replacements are these:

   TRANS_SET(30%)        // instantaneous 
   TRANS_FADE(95%)       // fades to new value over a second or two
   TRANS_LESS(10%)       // decrease translucency 
   TRANS_MORE(10%)       // increase translucency
   TRANS_ALTERNATE(10%)  // alternate between visible and invisible

the parameters are optional: for TRANS_SET, the default is 100% (i.e.
totally visible).  For TRANS_FADE, the default is 0% (i.e. totally
invisible).  For the last three, the default is 5%.

OK, finally removed the Misc1/Misc2 fields from DDF states.  There
were two things left that still used them: the weapon actions
SETCROSSHAIR and GOTTARGET.  They are both crosshair related, and I
think the crosshair stuff needs an overhaul to make it simpler, so for
now it's no big loss.

2000/07/19:

Made an "AUTOMAPS" lump that contains two colourmaps: one for the
automap in normal use, and one for the automap overlay, and
implemented the code to use 'em.  Gives TC authors another thing they
can customise.

2000/07/18:

Tried out the XINGMP3 source in the FreeAmp package, a GPL'd MP3
decoder.  It works !  It wasn't too hard to build either.  This looks
like the one to use for EDGE.

2000/07/17:

Fixed my stupid bug in p_action.c where monster's attacks where never
inaccurate (ACCURACY_ANGLE and ACCURACY_SLOPE were ignored).

Fixed a bug in R_DrawTranslucentTranslatedColumn16 (gee, even the fix
was smaller than that identifier ! :->).

Fixed translucent + remapped sprites in TrueBSP code.

Began work replacing "dc_texturemid" with "dc_yfrac", and will also
rename "dc_iscale" to "dc_ystep" to be consistent with the span
drawing variables.

OK updated everything using dc_texturemid except R_DrawMaskedColumn,
which has a whole bunch of other shit going on (sprtopofscreen,
spryscale, mfloorclip & mceilingclip -- UGH).  I'll be happy when we
can finally dump the old renderer (the sooner the better IMO, but the
polygoniser will need to be improved first).  I even updated the ASM
files, but I'm not confident that it is 100% correct, especially the
"db 2eh" in the final routine in r_column.asm, that threw me, not even
a comment to show what the instruction is supposed to be !

2000/07/16:

Removed the unimplemented and unused ConvertPostToBlock routine from
w_image.c.  Won't be needed, and I can't be bothered implementing it.

Wrote the ConvertBlockToPost() routine in w_image.c.

The image code now uses a "FONTWHITEN" entry in colmaps.ddf to whiten
font images.  It uses a hand-crafted FNWHTMAP colourmap lump.  Our DDF
and EDGE.WAD files will need updating when the new image code goes
on-line full-time.

2000/07/15:

Preliminary writing code is now in sv_chunk.c.

OK, sv_chunk code is more or less complete.  Not yet tested tho.

2000/07/14:

The savegame chunk handling code in sv_chunk.c/h is underway, the
preliminary reading and verifying code is in there (including
decompression using Markus FXJ Oberhumer's miniLZO library).

Removed the no longer useful "NOAMMO" attack special from DDF.

Added M_WarnError() to m_misc.  When the -strict option is used, this
will produce a fatal error, otherwise it merely displays a warning
message.

Added DDF_Warning() and DDF_WarnError() functions to ddf_main.

Updated all ddf_*.c files to use DDF_WarnError() where possible, in
particular when looking up command names and special flag names.  
This will make DDF more backwards and forwards compatible, since the
default is to ignore (with a warning) unknown commands and specials.
TC authors will need to use the -strict option now to get the previous
behaviour (crashing out on every error).  Note that certain errors
will still crash out (like a bad percentage value) -- these are
serious mistakes and there's no advantage to ignore them.

Added RAD_Warning() and RAD_WarnError() functions to rad_pars.

Updated rad_pars.c to use RAD_WarnError() where possible, mainly for
unknown RTS primitives and when too many parameters are given to a
primitive.  Cleaned up all the wrong-param-num checks.

Merged the DrawImage and DrawFont routines of the VCTX interface into
a single routine.

Added palette index colour definitions (BLACK, WHITE, etc) into
v_colour.h, and tidied up everything that uses them (especially
am_map.c).

2000/07/13:

Removed the never used specialdata[2] element in sector_t.  Seems
originally it was used for LIGHTS, but now nothing sets it.

OK, the new savegame design is more or less complete.  Time to start
implementation.

2000/07/12:

Removed the never used `wait' field from sec_move_t.

Removed the unused `specialdata' field from line_t.

Found that giving puffs the MISSILE special fixes the "bug" where
puffs don't disappear when hitting a ceiling (esp. sky).

Yep, more savegame stuff.

2000/07/11:

Removed the unused `fasttics' field from mobj_t.

More savegame work.

2000/07/10:

Worked on the new savegame design some more.  Much more of the nitty
gritty has been worked out, but still a way to go.

2000/07/09:

Fixed the mipmapping based on the formula in the OpenGL specs (where
the mipmap point occurs at the step value of root 2), seems better.
Certain textures/flats (e.g. TLITE*) still don't look very good --
just a limitation of mipmapping I think (e.g. you could mipmap on both
X and Y axes, but it's too expensive, nearly 300% extra memory on the
base texture, in contrast with 33% extra for normal mipmapping).

2000/07/08:

OK, SDL sound is now working here.  Man what a pain sdl can be, its
framebuffer target is buggy and after shutdown I have to press the
Secure Attention Key (SAK, ALT+SysRq+K) just to switch consoles.

Spent a while tidying up the linux OSS and SDL sound code.  They both
now do proper thread locking and can handle frequencies other than
11025 Hz, and both support two options: -freq to specify the sample
frequency, and -mono to disable the normal stereo support.  Main thing
left now to do is support for 16 bit sound devices.

Righteo, OSS and SDL sound code now does panning.  Much better.

Noticed a bug: the archvile can resurrect two monsters which become
stuck together, or one monster that gets stuck into the archvile.
Don't know the fix, it's a general problem of the code not being able
to deal properly with objects that get bigger.

Woah, accidentally enabled the "fast_mipmapping" option, and boy it's
even uglier than I expected.  Surely no-one's gonna want this.

Woah 2, fixed the column drawing mipmap code to take the inter-column
stepping into account, and the results are quite nice.  There are some
not-so-nice effects due to the limited colours in the Doom palette,
also the walls can look a bit fuzzy but I guess that's to be expected
with mipmapping.

2000/07/07:

Made the linux code properly handle sounds at a different frequency
that the audio device.  It was pretty easy: just use a 22.10 fixed
point value for the offset, and compute a delta value for the sound.
With a slight modification, it will also handle pitch-bending (even
while the sound is playing), but our EPI doesn't allow it yet.

Started on Linux/SDL sound support...  The sound mixing code could
prolly be shared between SDL and OSS -- I'll worry about that when
both codes are more mature.

2000/07/06:

Got some rough layer stuff going under GL: background, player view and
pause icon.  Seems the current video context is too simplistic, it
needs a clear cut way to (a) make sure a 2D GL view matrix is active
when needed, and (b) set/unset the GL scissor test (for clipping).

Added some support to w_image for font patches: these images are
converted to greyscale (so that GL can colorise them).  To get the
best conversion, we'll need a hand-crafted colourmap lump.

OK, made such a lump ("WHITTEXT") -- but not used yet.

Improved the VCTX stuff.  Pretty happy with it now, only one issue
left: maybe combine DrawImage and DrawFont as a single routine.

2000/07/05:

The w_image code is almost there.  The only things missing now are the
block <-> post conversions (block->post needed for mid-masked
textures), smarter mipmapping (use existing higher mips if they exist,
rather than load from wad), lots of cleaning up, and eventually
optimisation.

Now got some mipmapping going for walls.  Same deal, overall it seems
to be an improvement, but not as good as expected.  Perhaps the
mip-choosing formula needs to take into account the on-screen texture
difference _between_ columns/spans (currently only the stepping within
a column/span is considered).  This might also help walls that face
you at a sharp angle.

2000/07/04:

Worked on the w_image code some more, the code for loading textures is
now in place (but VERY hacked together right now).

2000/07/03:

Made the automap thing drawer: (a) use radius for scaling, and (b)
more colourful.

Worked on making the automap use the BSP for rendering.  Should give a
good speed boost on complex maps (especially with a high zoom) since
the bounding boxes can be checked against the screen and whole
sub-trees skipped when off-screen.  Also tidied up some stuff in
there.

Got some mipmapping going for flats, seems to work but I expected it
to look better (perhaps something is wrong with the logic).  Also the
r2_draw.c code is not "pixel perfect", improving this may improve the
mipmapping too.  I suspect doing walls will be a much starker
contrast.

2000/07/02:

Wrote DrawColumnIntoBlock() routine for w_image.c, for old-style
patches, and also DrawWPostIntoBlock() for new-style w_post_t's.

2000/07/01:

Change the TWOSIDED check to not crash out with an error, just produce
a warning instead (and clear the flag).  This follows the practice of
Boom and MBF which allow this situation.

Added '?' as a character which the DDF parser won't ignore.

Added support for V2.0 of the "GL Nodes" specification to EDGE in
LoadGLVertices() in p_setup.  Namely: vertices are stored as 16.16
fixed point in the GL_VERT lump, with a magic value to distinguish it
from the normal format.  BTW, since only segs get split by the nodes
builder, nothing else but GL vertices needs the extra precision.

Changed seg_t back to using `v1' and `v2' vertex pointers rather than
storing the coordinates directly, in order to...

Implemented a RemoveSlimeTrails() routine in p_setup.c, based strongly
on Lee Killough's code in MBF.  It didn't fix the one slimetrail I
know about however :(, which I suspect is down to "IFFY segs" (where
the seg start, for example, lies just inside or just outside the
partition line).  The up-n-coming rework of glBSP to support V2.0 of
"GL Nodes" should fix it though.

Hmmm, EDGE crashed today with the Archvile's EFFECT_TRACKER action,
since currentattack was NULL.  Added a check in P_EffectTracker, but
it's prolly just a band-aid.

Reworked label code in ddf_stat.c, the new format looks like this:

    LABEL.FOOBAR:TROO:A:10:NORMAL:LOOKOUT
    ^^^^^^^^^^^^^

i.e. "LABEL." followed by the name followed by ":".  Implemented the
new JUMP action for DDF that looks like this:

    JUMP(labelname)           // always jumps
or
    JUMP(labelname,chance)    // jump randomly

where `chance' is a percentage value from 0% to 100% (the trailing `%'
is mandatory).  This new LABEL/JUMP system will replace the current
RANDOMJUMP action.  Our DDF files will need fixing.  BTW, the current
code for this is pretty inefficient, and should be optimised before
the next release.

2000/06/30:

Found the bug causing some sprites to be half-drawn: I had a check
against the 1D occlusion buffer, but a sprite may poke outside of its
own subsector (horizontally) and thus be wrongly clipped.  Ouch !
That check was meant to _quickly_ rule out sprites know to be unseen.

2000/06/29:

Fixed a bug in the Linux/X version causing bogus events when using
mouse & keyboard at the same time.  Spent a while tidying up the
iv_x.c code.

More w_image.c stuff.  Another step closer to an initial prototype:
working flats and patches.  Still a long way to go :-(.

OK, initial prototype of w_image is there and compiling, now need to
hook it in to test...

2000/06/28:

Just noticed that textures in Doom (any port) only tile horizontally
properly if their width is a power of two -- I had always thought any
width texture would tile, obviously not.  It is a reasonable
restriction anyway, the GL code to do it would've got real ugly.

More work on w_image.c, image_t creation is in place, and lookup
functions are in place too.  Mipmapper is now there (the ShrinkBlock
routine).  Hmmm, the file is getting big (with plenty more to come),
which is not unexpected.  Will shove everything in there for now, and
split it up later when "the wood can be seen for the trees".

Added in ShrinkBlockRGBA routine, which converts a block image into an
RGBA texture for GL, optionally shrinking it if needed (e.g. texture
too big for 3D hardware).  Could also be used for mipmapping under GL
(I had thought GL would compute the mipmaps automatically, but I now
see it requires you to send them and set an appropriate MIN_FILTER).

2000/06/27:

OK, the internal structures in w_image.c fell nicely into place today,
with just _one_ cache structure for all three modes, and will work
just like the stuff in w_textur.c now.  Good.

Made totally invisible planes & walls not drawn by the TrueBSP
renderer, fixing an ugly effect in 8-bit mode.

Worked on Linux/GGI code, made sure it works when DirectBuffer is not
available (e.g. palemu target).  Also added fallback using PackColors
for really weird modes, but seeing how very slow it is, it will only
be activated when using the "-ggisnail" option.

It occurs that the new layer system could give a big benefit when
using a shrunk-down view on large modes, since only the dirty areas
would need to be blitted by the platform code.  Requires some largish
level changes to the EPI, and having m_bbox code in the common lib, so
this idea can wait a while (at least until layer system is in place).

Fixed GL weapon sprite when the light amp goggles are in effect.

Fleshed out w_image.c some more, the main parts left to do are the
lookup functions (not too involved) and texture loading & mipmapping
(Egads !), oh yeah initialisation too (Yech).  Re: loading, the
LoadImagePost routine will use the lumps of patches & single-patch
textures directly, everything else will be done after conversion to
Block format (be it flat, patch, texture or dummy).

2000/06/26:

More on mipmapping: I think the cached image size should implicitly be
given by the `mip' value, like this:

   #define MIP_SIZE(size,mip)  MAX(1, (size) >> (mip))

Worked on w_image.c some more, the cache/mipmap concepts are coming
together but still some ways to go...

2000/06/25:

Investigated support for modifier keys under GLUT, e.g. using CTRL key
as a fire button, but the API (V3.7 anyway) doesn't provide any way to
do it (e.g. glutGetModifiers can only be called during a key callback
function, which *doesn't* get called when a plain modifier is pressed).

Worked on w_image.h, extending the current concepts in w_textur.c/h to
make it more general (covering flats and patches too).  (Sprites are
just patches BTW).  Doesn't handle mipmapping well yet, or flat/tex
animations come to think of it...

Re: animations, have two fields: anim_next and anim_cur.  anim_next
points to the next image in the animation (making overlapping
animations impossible, but no big loss).  anim_cur points to the
current image.  When the animation delay is up, all that needs to be
done is "anim_cur = anim_cur->anim_next" for each image in the anim.

Re: mipmapping, I don't think a mip should be an image_t, image_t is
used in sidedefs and for sector planes etc...

2000/06/23:

Integrated code from Bruce Lewis for checking GL extensions into
rgl_main.c.

Wrote RGL_DummyColor() to compute the average colour of a texture.
Makes DEBUG_NO_TEX mode look a lot more like the real thing.

Changed RGL_SetupMatrix2D() to make the coordinates congruous with the
screen dimensions, i.e. right/bottom at SCREENWIDTH/SCREENHEIGHT
(instead of at 1.0/1.0).  Simplifies some of the 2D calcs.

Implemented the AutoMap in GL mode.  Rather hackish right now, needs
the layer system to be done nicely.

Added "-polygonise" option, forces polygonisation (allowing that code
to be debugged).

2000/06/22:

Split GL parts of r2_defs.h off into rgl_defs.h.  Changed wart from
R2GL_ to just RGL_.

Renamed linux/i_sound.c to linux/is_oss.c.  The SDL sound code will be
stored in linux/is_sdl.c.  If we ever implement ALSA support, that can
be put in linux/is_alsa.c.

2000/06/21:

Began splitting the GL renderer into three new files:

   rgl_main.c  -  contains the main (general purpose) stuff.
   rgl_bsp.c   -  contains the BSP renderer.
   rgl_tex.c   -  contains texture management.

Reworked Linux makefile, making it easier to select video, sound and
assembly options.

2000/06/20:

* EDGE 1.24 was released *

2000/06/18:

Added SDL_ShowCursor(0) to the SDL port, giving a significant
performance improvement (why ? dunno).

Added SDL_HWPALETTE to the flags for SDL_SetVideoMode() and
SDL_VideoModeOK() calls, now 8 bit modes look OK under X windows.

Decided to update the "GL Nodes" specification with an enhanced
version of the GL_VERT lump containing vertex coordinates in 16.16
fixed point format.  The new format will be distinguished from the old
format (which will still be supported) by a 4 byte magic value at
offset 0.  This new format allows GL segs to start/end with sub-pixel
accuracy, allowing glBSP to be "floatified" (rounding the coords would
have been a serious headache otherwise, e.g. certain subsectors could
become slightly non-convex).

2000/06/17:

Reworked r_layers code some more, switching from x/y/w/h coords (with
width and height) to x1/y1/x2/y2 (inclusive range).  Simplifies many
calculations.  Added code to clip sub-layers to their parent
(including top-level layers to the whole screen).

2000/06/16:

Layer management code (r_layers.c & r_layers.h) is now done (but not
yet tested).  It is pretty simple really.  The harder stuff comes
next...

More documentation work.  Netscape just seems to go loopy when using
FACE=... in a <FONT> tag, so I've removed them and at least now the
behaviour is sane (no more itty bitty teeny weeny monospace text).

2000/06/15:

Been investigating various possibilities for getting MP3 and MIDI
support into the Linux EDGE (or for MP3, perhaps a cross-platform
library).  Current contenders for MP3: freeamp, maplay 1.2+, mpg123.
Current contenders for MIDI: playmidi, jazz++, timidity, allegro.

There are two options: (a) "direct support" : integrate the code into
EDGE source tree, (b) "indirect support" : execute the program to play
the music.  Indirect support has the distinct disadvantage that the
music volume cannot be set via the EDGE volume slider, but otherwise
is the most flexible option (the exact program to run, including
options, can be specified in the config file).

Hmmm, another big disadvantage of indirect support is that the program
would likely use the DSP, so you could either have sound OR music but
not both.  Well, so much for that idea...

2000/06/13:

Worked on documentation.

Fiddled some more with the "sprite tutti frutti" bug that come back
when compiler optimisation was enabled.

2000/06/12:

Fixed the "sprite tutti frutti" bug, though not completely happy with
the solution (for one thing, dc_texturemid is a pain).

Fixed a bug in the X code with the keyboard, there was an erroneous
E_PostEvent() in there just sending old crud all the time.

2000/06/11:

Fixed Linux/GGI and Linux/X code that uses `myargv' and `myargc' to
handle Andy's M_ARGV changes.

Added `kick_offset' field to player_t, to fix a problem with weapon
kicks no longer working properly.

Updated R_PointInVertRegion() to handle thick liquid floors.

2000/06/09:

Made object collision code follow MBF semantics: non-solid (or
non-clipping) moving objects (which are not missiles) can now pass
through solid objects.  Hopefully fixes problems with ejecting shells.

Ahh good, new sprite clipping code is in place and seems to work well,
the code is much neater too.

Made extrafloor sides only drawn if the tag on the front & back
sectors of the line is different.  (Same tag implies same extrafloors,
and therefore the sides don't need to be drawn).

2000/06/08:

'Twas wondering why the GL renderer wasn't drawing the 1024 width
skies found in TNT and PLUTONIA, but *was* drawing the 256 width ones
from DOOM II.  Then I remembered that most 3D cards have a 256x256
texture size limit.  The height limit is not really a problem, the
DOOM graphic format itself is limited to about 256 pixels (it is
possible to go higher, upto about 510 pixels, but only when the
texture is completely solid).  But textures wider than 256 are fairly
common.  The texture conversion functions will need to be rewritten
to shrink stuff so they fit in MAX_TEXTURE_SIZE...

Woah, found BIG memory leak in the W_ConvertTextureRGBA() function.
I'd thought there was a memory leak somewhere, seeing how GLEDGE would
tend to start paging on Win32.  This must have been it.

OK, reworked GL texture conversion code to (a) apply gamma, and (b)
shrink textures that are larger than MAX_TEXTURE_SIZE.

Noticed a nice idea in Jaakko Keränen's JHexen code: use translucent
quads covering the screen to simulate palette and/or colourmap
effects.  Will copy that technique in EDGE :).  Including for
invulnerability, seeing that TexEnv(GL_BLEND) is not generally
supported on 3D cards (AFAIK).

Fixed startup messages by hardcoding the LDF messages in ddf_lang.c
that are needed before the DDFLANG lump has been read from EDGE.WAD.

Found another option for invulnerability in GL renderer:
BlendFunc(ONE_MINUS_DST_COLOR, ZERO).  Same result as TexEnv(GL_BLEND)
but hopefully usuable on most 3D cards.

Cleaned up the GL drawing routines (walls, planes, things, psprites,
sky).  Psprite clipping is now down with the SCISSOR test -- when the
layer system is in place, this will prolly happen automatically.

Tried the new glBSP (1.8) out on TNT.WAD, and blow me down it crashed
with in internal error.  The problem is related to splitting very
short segs (e.g. 4 pixels), and the computed intersection point ends
up on the start or end vertex.  Ouch !

2000/06/07:

Discovered a major shortcoming within glBSP: seg partner pairs are
separated when a partition line passes along the same line, as it
should, *BUT* future splits of these segs do not split their partners,
causing (a) partner information to be screwed up, and (b) ugly thin
gaps between subsectors since the split-point is rounded to integer
coordinates (a limitation of the WAD format) and thus no longer sits
on the same line.

Phew... it took a while, but the fix has been implemented and QD1
certainly looks better (couldn't find any triangular holes).  Now just
gotta clean up the source... :-)

Started on making the TrueBSP code handle sprites with y-offset less
than their height (e.g. health potion) better.  Requires a complete
rewrite of the R2_ClipSpritesVertically() function...

2000/06/06:

Did some documentation work.

2000/06/05:

The new layer system design is coming along, nearly finished and once
some small details are worked out, time to start coding !

Changed Linux's config filename from ".edgerc" to "edge.cfg" to match
the other ports.

2000/06/04:

Worked on the design for the new layer system.

Added a simulation to the GL code for the invulnerability powerup,
setting TEXTURE_ENV_MODE to GL_BLEND -- since the env color is
normally black, this inverts the normal colours.  Simple but
reasonably effective.

2000/06/02:

More work on the savegame design.  Getting there, but still some hairy
issues to sort out...

2000/06/01:

Worked on the design for the new savegame system.  Almost there.

2000/05/29:

Made the menu pointer ('*') light blue -- stands out more.

Converted changelogs since EDGE 1.05 into HTML.

2000/05/28:

Tested the "DDF as lumps in EDGE.WAD" with the EDGE.WAD v1.3.0 that
Marc Pullen sent me -- yay it works, but the startup messages
desperately need to be made better looking.  Rearranged the
startcode[] order in e_main.c, such that I_SystemStartup() comes after
ShowNotice() which comes after DDF_MainCleanup().

Made psprites in the GL code clipped to the viewwindow (to the bottom
edge anyway).

Made the GL code only draw sky where necessary (horizontally at
least), at the expense of slowing down the `just_clip' version of
WalkSeg() somewhat.  The idea of storing computing rendering info in
the corresponding data structures (e.g. cur_x1/x2 in seg_t) is looking
quite attractive right now.

Added a "nomusic" global variable which should work in a similar
spirit to "nosound".

Reworked DDF_LanguageLookup() so that it can be used before any
languages have been read in.  Needed for the "DDF lumps in EDGE.WAD"
code, but a proper fix should be investigated after 1.24 is released.

2000/05/27:

Applied the thick+translucent patch to the GL code, and tested that it
works.

Allowed the GL code to render in a smaller window, including the
player's weapon and the sky.  Now the '+' and '-' keys work in the GL
renderer -- though it doesn't clear the garbage around the window yet.

Okidoke, fixed the GL "3D camera" code making it 100% congruent with
the normal (TrueBSP) camera.  Mlook is crappier, but this fixes the
problem with disappearing chunks when mlooking far up or down.  Also
means Zooming now works in GL mode :).  The code is much nicer too,
replaced that icky custom matrix guff with a single glFrustrum().

Still to do: clip psprites to render frame, and only draw sky where
necessary...

2000/05/26:

Worked on getting THICK + TRANSLUCENT extrafloors working...

OK got it going in the software TrueBSP renderer.  Need to apply the
changes to the GL code now (this separation of almost identical code
bites -- but the common code is "middleware" and thus hard to factor
out in a nice way).

2000/05/23:

Added a check against the -players option disallowing more than
MAXPLAYERS players (currently 8).

Added new weapons.ddf command REFIRE_INACCURATE, defaults to FALSE,
when set to TRUE then the weapon becomes less accurate whilst the
trigger is held down.  Mimics Boom/MBF behaviour: the first shot is
dead on target, subsequent shots use the attack's inaccuracy.

Fixed the single shotgun -- it actually was shooting properly (in a
horizontal line) but the random value added to the puff height was too
big, making it look strange.

Started work on "Internal DDF" mode, which reads all DDF/RTS info from
EDGE.WAD instead of from external files.  External-ddf mode is engaged
by (a) using the -ddf option, or (b) detecting a ddf file (such as
"things.ddf") in the DDF directory.  One problem is that LANGUAGE.LDF
is now loaded later than before -- may have to forego some
translations.  Another issue is that the nice "....." dot stuff that
used to be shown when starting EDGE has been messed up -- might be
best if the DDF/RTS files in EDGE.WAD are handled differently (i.e.
earlier) than those in normal PWADs.

Made P_SetupLevel() enable TrueBSP mode if GL-Nodes are detected, so
the -truebsp option no longer needs to be specified for glBSP-itised
wads (but may still be handy for plain wads).  I'm rather glad about
this, it was too easy before to forget adding -truebsp and then see
some pretty strange results.

Added a "-classic" option to force EDGE to use the classic renderer
even when GL-Nodes are detected.  If we ever dump the old renderer
then both options (-truebsp and -classic) can be dumped with it.

2000/05/22:

Worked on a design for a new layered display system to replace
E_Display() -- firstly to fix the bugs with screen areas not being
updated (e.g. tips), secondly to have a framework for implementing the
non-rendering stuff for the GL port, and thirdly just to make the code
more understandible (and hence easier to fix & maintain).

2000/05/20:

OK completed the update of the docs.  Will now upload to SourceForge
so everyone can double check them.

2000/05/19:

The documentation is coming along nicely.  The update should be
finished by tomorrow.

Fixed a problem where dropped items from killed monsters would appear
underneath an extrafloor.

Implemented the PLAYER_SCREAM code pointer, which will play the
"PDIEHI" sound if the lump exists and the player's health had dropped
below -50% (unclipped) when dying.

Fixed a bug where missiles would be eaten (instead of exploding) when
hitting the bottom of an extrafloor that was below sky.

2000/05/18:

More work on them docs...

2000/05/17:

Started updating Garth's DDF documentation, updating any parts that
have changed recently.  Slow going...

2000/05/16:

Finished off the EPI docs.  The EPI could do with some work, in
particular: the way handles are used in I_LoadSfx() is weird, the
I_SetScreenSize() function is too complex, the int pointers in the
music functions are weird, I_Warning (maybe I_Printf) are poorly
defined, and the network interface should follow the others (i.e.
I_StartupNet and I_ShutdownNet -- called from the platform code).

2000/05/15:

Did more work on the EPI docs today.

Damn SourceForge, it won't let me change the mailman configuration or
approve/reject messages.  Gives me the shits.

2000/05/14:

Started writing EPI documentation in the i_system.h header.

2000/05/05:

Removed the RTS EXTEND_MAP primitive, more confusing than helpful, and
the only slight benefit it brought (debugging embedded RSCRIPT lumps)
can still be achieved (albeit not as easily).

2000/05/03:

Fixed problem with X offsets on the sides of extrafloors, most
noticeable with horizontal scrollers.

Made COUNT_AS_ITEM and COUNT_AS_KILL work even for dynamically spawned
things.  Whilst this has its dangers, being consistent is better than
trying to second guess what was intended (e.g. when RTS spawnthing
comes into play).

Made sure extrafloor records are sorted in a reasonable order, since
the order that extrafloors are added to a sector is significant (e.g.
liquid floors should be added after solid floors).

2000/04/28:

Improved the RTS error message when a primitive is used in the wrong
place (e.g. "RADIUSTRIGGER" without any "START_MAP"), and fixed the
bug having the place names reversed.

2000/04/27:

* Uploaded EDGE 1.23 binaries to SourceForge *

2000/04/25:

Made the linux music code (i_mussrv.c) look for the music server
program ("musserv") in the following directories: homedir, current
dir, /usr/local/games, and /usr/games.

2000/04/23:

Split RAD_Init into two halves, with the new half being RAD_LoadParam.
This new half is responsible for handling the -script option.  Now
RAD_Init (which loads the EDGE.SCR file) happens earlier, before any
WAD files are processed.  This should fix any problem where stuff in a
PWAD RSCRIPT lump is clobbered by stuff in the EDGE.SCR file.

2000/04/22:

Added check for NULL target in the LaunchProjectile function, should
prevent possible crashes.

2000/04/21:

Made the RSCRIPT lump loaded just like the DDF lumps in w_wad.c,
preventing problems with stuff needed in RSCRIPT that are defined in a
DDF* lump (since previously, the DDF lumps were loaded later).

Made the TrueBSP and GL renderers ignore single-sided walls that have
no texture -- should prevent AASHITTY appearing on some sky parts.

Fixed some bugs in the TrueBSP sprite code w.r.t. scaled sprites.

Added MAX_DISTANCE field to sounds.ddf -- if the sound is further away
than this value, it is not played at all.

Made the sound code use 3D distance for attenuation, and made sure
various sound objects (like sector_t's soundorg) had reasonable Z
values.  Moved the fake object for the RTS PLAYSOUND primitive into
the trigger itself, and added a KILLSOUND primitive which kills the
sound from a trigger -- might need to extend it so it can kill sounds
from any named trigger (not just the one it occurs in).

2000/04/19:

Fixed the not-playing-OOF-sound bug.

Looked for problems of singular low priority sounds cutting off high
priority sounds...  OK, found a big bug with the linux sound driver,
all sounds were being played on voice #0 !  Also found a bug in
s_sound.c, S_StopChannel() was only doing I_SoundKill() and _playing_
channels, but it needs to do it on finished-but-still-allocated ones
as well.

Implemented a PRECIOUS field for sounds.ddf :- the default is FALSE,
but when set to TRUE it makes any already playing sound keep on
playing if it was going to be overridden by a same-priority or
same-singularity sound, rather than been cut off.

2000/04/17:

Added a new sector special "PUSH_CONSTANT", normally the push is a
force which will make heavier things (i.e. larger MASS) move slower
than lighter things.  This tag makes all things pushed at a constant
speed, regardless of their mass.  Good for conveyor belts (etc) which
should carry all objects at the same speed.

72000/04/16:

Began work improving the language.ddf code, in particular to get the
"-lang" option working again.  OK, the ddf_lang.c code now stores all
languages in memory, and if a refname isn't found (e.g. ChatKeys) then
it will be looked for within the other languages.

Added a "Language" option to the main menu.  Found out it didn't
change much :(, pickup messages are looked-up once when parsing
things.ddf.  Therefore... changed the code to do dynamic lookups, it
is not very optimal yet, but it works.

Implemented scrolling flats.  The following entries in sectors.ddf do
the trick.

    FLOOR.SCROLL_ANGLE=<num>;    // 0 is east, 90 is north, etc..
    FLOOR.SCROLL_SPEED=<num>;    // 32 is one pixel per tic

    CEILING.SCROLL_ANGLE=<num>;
    CEILING.SCROLL_SPEED=<num>;

Implemented pushing sectors.  Looks like this in sectors.ddf:

    PUSH_ANGLE=<num>;    // 0 is east, 90 is north, etc..
    PUSH_SPEED=<num>;    // 0 is none, 50 is quite fast
    PUSH_ZSPEED=<num>;   // 0 is normal, > 0 is upwards

Added a new sector special "PUSH_ALL", which makes sure _all_ objects
are pushed, including NOGRAVITY ones.  Note that the WHOLE_REGION
sector special also affects pushing sectors: when absent the push only
happens when the object is touching the floor.

Made the "True3D gameplay" option default to "on".

Fixed the GL code to handle scrolling flats.

2000/04/14:

Added KEYD_CAPSLOCK value to dm_defs.h for the capslock key.

Added support in the Linux/LibGGI code for capslock.  Considered
making the code behave specially: keydown event when the capslock
light comes on, keyup event when the capslock light goes off.  That
would allow the main code to keep synchonised with the keyboard light,
_but_ that would make other keys unusable for the "toggle autorun"
feature.

Made the DJGPP code also handle capslock.  Not yet tested.

Implemented `Toggle Autorun' as a bindable key, defaulting to capslock
as you would expect.  Tested it, and it works.

2000/04/11:

Discovered some icky bugs in the TrueBSP sprite renderer.  Y offset
strikes again :(.  This plain sucks, the engine thinks the object is
in one place (thing->z & thing->height, etc), but the sprite could be
in a quite different place.  Hmmm... not much can be done about it,
we'll just need to support it as well as possible.

2000/04/07:

Fixed a small bug in glBSP, passing a zero `x' parameter to BCC's
atan2() function causes a division by zero exception (GCC's atan2
seems to work fine).

Completed the web page for glBSP 1.7, compiled the source and binary
packages and uploaded all the goodies :) to my homepage.

2000/04/06:

Made glBSP not create the blockmap and reject entries when in GWA mode
(since in GWA mode they are totally ignored).

2000/04/04:

Discovered a major bug in glBSP: the offset values in the segs that
lie on the _back_ side of a linedef are miscalculated (but the offsets
on the front side are OK).  No, the bug is not in glBSP but actually
in EDGE !  Fixed now.

2000/04/03:

* Uploaded EDGE 1.22 to onelist *

2000/04/01:

Checked the transparent door hacks in the GL renderer.  Good, now both
the TrueBSP and OpenGL renderers are drawing the transparent doors
found in TNT MAP02 and Eternal MAP01 correctly.

Bumped the MAX_TEX value in the temporary GL texture management code
from 4096 to 10000.  Now sprites in QDOOM can be seen.

More documentation work for glBSP, it is nearly finished now.

glBSP: the -normal option has no effect in "GWA Mode", changed this
from a warning to an error message.  Also renamed the -normal option
to -forcenormal, and the -gwa option to -forcegwa.

glBSP: turned the -nowarn option into -warn, and made it show the
extra-ish warning messages (like ones about unclosed sectors), these
are generally harmless and we don't need to fill the screen (and worry
users) about them by default.

Reworked oof code and maxfall code in p_mobj.c.

2000/03/31:

Squashed the bug giving twice the ammo in skill 1 at game start.

Made glBSP allow a missing output filename.  When absent, a GWA
companion file for the input wad is created.  This will make it easier
for the most common case: people using glBSP on pre-existing wad files
in order to play EDGEGL.

Wrote some documentation to glBSP.

Fixed (well, hacked really) the TrueBSP code to make the transparent
door trick work again.

Made projectiles once again launch from the center of the shooter
thing, instead of at 1.5 times the radius.  Fixes the problem where
you could should a missile into a wall and it wouldn't blow up.
Actually it is not dead center, but 0.5 units from the center, this
prevents the bug where you would always be thrusted due east when the
missile blew up.

2000/03/30:

Found the real reason why sprites are disappearing in the classic
renderer.  Things are now stored per subsector, but the old code
visited them per SECTOR (using validcount to mark the sector as
already visited).  Since the BBOX info of normal nodes does not cover
the whole subsector, subsectors can be skipped, and so the sprites in
them are now being skipped.  Damn the bogus bboxes.

OK, put each subsector in a list of the parent's sector, and reverted
the sprite code in the classic renderer to the old method (using
validcount), fixing the disappearing sprites bug.

Specifying non-unity extrafloor translucency on a non-SEE_THROUGH
extrafloor type now produces an error.

2000/03/29:

A problem with mid-masked textures being drawn in the wrong place when
extrafloors were around (e.g. QDOOM MAP01) fixed, in both r2_bsp.c and
r2_gl.c.

2000/03/28:

* Uploaded EDGE 1.21 to onelist *

Reworked BSP bounding boxes, reverting to the original method: storing
two bboxes in each node (one for left child, one for right child).

Argh !  It still doesn't work, yet it works OK in normal doom which
uses the same algorithm.  I just dunno.

2000/03/27:

Found the bug causing missing mid-masked textures in the "classic
renderer" (i.e. the old clunker :->) -- it only happened when the GL
node information was loaded (e.g. GWA file).  Fixed.

Fixed a problem in the TrueBSP renderer where mid-masked textures were
being drawn at the wrong height(s).

Added a small optimisation to the OpenGL renderer: now it doesn't
enable GL_BLEND when the texture is known to be totally opaque (e.g.
a single sided wall).

Fixed vertical alignment issues with the OpenGL renderer.  Fixed a
horizontal alignment issue: the seg's offset was not being used.
Fixed a problem in both r2_gl and r2_bsp with mid-masked textures
which sit into the floor or ceiling.

Tracked down the bug causing certain sprites to disappear in the
classic renderer.  It occurs because the bboxes from the normal NODES
info may not cover the whole subsector (worst case: a single vertical
or horizontal seg), but the current code does a visibility test using
the bbox.  The fix is to revert to the old way: only test bboxes for
stuff in the _back space_, i.e. visit everything in the front space.

Fixed a bug causing EDGE to crash if you started the game with no
weapons.

2000/03/26:

Added R2GL_Init() code for setting up default GL state.  Added hints
for fog and perspective-correctness.

Fixed translucency in the GL code (using glColor4f instead of making
the texture itself be translucent).  Added support for SHADOW monsters
and players -- they are shaded blue with 0.3 translucency.

Fixed the problem in the GL code with player sprites moving up/down
the screen when MLOOK'ing up and down.  Also reworked R2GL_Flat(),
R2GL_Texture() and R2GL_Sprite(), no longer passes alpha value, the
translucency effects are done using glColor4f().

Updated the w_textur.c/h code to manage (a) non-power-of-two textures
and (b) textures with transparent parts.

Cleaned up the texture/flat/sprite management code in r2_gl.c, and
implemented preliminary support for mid-masked textures and non-PO2
textures.  It's an improvement :), even translucent mid-masked
textures are working.

Reworked the DDF handling for extrafloors.  The type and specials have
been merged into one.  The new syntax is like this:

    EXTRAFLOOR_TYPE = LIQUID, WATER, FLOODER;

and one of the defining values (THIN, THICK or LIQUID) must be
present, or an error occurs.  LIQUID will imply both SEE_THROUGH and
SHOOT_THROUGH.

Fixed numerous warnings that the Borland BCC 5.5 compiler produces,
especially debugging stuff in r2_bsp.c, r2_gl.c and r2_poly.c.

Removed the actionf_t type, replacing the last two uses of it with
"void (* action)(mobj_t * object)".  Updated the weapon code to cope:
previously all weapon code pointers has two args: player and psp, now
they all have an object, the player comes from mo->player, and the psp
comes from a new field in player_t "action_psp".

Began hunting down other warning messages produced by GCC's -pedantic
option.  Fixed the messageRoutine awfulness in m_menu.c.  Fixed the
ChangeMusic cheat -- now you type in a music number for the entry in
playlist.ddf.  Removed the now defunct I_ZoneBase() functions from the
linux and win32 platform code.  Removed the unused -DUNIX define from
the linux makefile.  Ditto for -DNO_ASM.

Decided on the fix for the linux sound code woes: use the profiling
interval timer to generate SIGPROF signals at regular intervals (we'll
ask for 20 milliseconds, but we won't get that, more like an average
between 30 and 40 ms without significant competition).  Forking a
child process to signal the main process is a similar alternative,
it's a bit more clunky so I'll go with the interval timer for now.

Yep, that did the trick, sounds no longer become choppy when the
framerate gets low.  Also fixed a bug with looping sounds (in the
linux code), but it seems the main code is not killing them off like
it should (e.g. lowering platform in blue room in MAP01).  OTOH my
I_SoundCheck() could be wrong...

2000/03/25:

Made the VOLUME field of sounds.ddf accept a percentage instead of a
value from 0 to 255.

Began work on adding sound support to the Linux port, using the code
from my old game engine `Rampage' as a basis.  Will limit it to 8 bit
support for now.

OK, preliminary linux sound code is working.  There's a couple of
issues, the most pressing one is the most expected one: delays when
rendering complex scenes (or anything that makes the framerate low)
causes I_SoundTicker() to not be called enough, making the sound very
choppy.  All of the potential solutions suck in one way or another:
threads are not portable enough, fork() or a separate server is very
clunky and inefficient, and putting more I_SoundTicker calls
everywhere is not really feasible.  Hmmm....

2000/03/23:

Added "VISCOSITY" field for lines.ddf, it works like friction and
gravity: when the line is activated, the viscosity value is
transferred to the tagged sector(s).

Renamed the `grav' field of gameflags_t to `menu_grav', and added a
MENU_GRAV_NORMAL define.  This is to prevent confusion with real
gravity fields -- the menu_grav field does not define an exact gravity
but a proportional value, multiplied by the real gravity.

Changed the "GRAVITY" field of lines.ddf and sectors.ddf, it now
accepts floating point values.  Normal gravity is 8.0.  Updated the
P_ZMovement to handle negative gravities properly.  Also changed the
`sentinel' value of gravity/friction/viscosity value for lines from 0
to M_PI (since 0 is valid for gravity and viscosity).

Made switches only activateable if they are not already in the button
waiting list.  This fixes a problem with textures getting out of sync
on certain buttons if they are activated twice in quick succession.

2000/03/22:

Fixed the P_ChangeSector() routine and extrafloors: the previous
method (controlled_secs field of sector_t) was bogus, a dummy sector
can control multiple real sectors but this was limiting it to just a
single set of sectors with the same tag.  This has fixed problems with
rising/lowering liquid floors being drawn where they shouldn't be and
eating other thick floors.

Fixed the problem with the linux musserver code when changing the
volume.  It seems `musserv' gets out of sync.  Added a `R' command
(resume) directly after the `V' (volume) command did the trick.

2000/03/21:

Added support to glBSP for detecting linedefs belonging to PolyObjs.
Such linedefs are ignored for the purposes of building the BSP tree.

Tested the different split factors of glBSP on Doom 2 IWAD.  Here are
the results:  (The comma parts are: Min,Avg,Max)

   Factor   GL Lump Size   Number Segs   Tree Height   Tree Diff
   ------   ------------   -----------   -----------   ---------
     3         1181K      204,2149,4603    7,13,22      0,1,11
     7         1081K      185,1987,4283    9,15,27      0,2,16
     11        1046K      182,1932,4102   10,16,27      0,2,14
     17        1019K      182,1888,3991   11,18,28      0,4,14
     26        1004K      182,1864,3935   13,20,35      0,4,15

Based on that, changed the default factor to 7.

Following Andre Majorel's suggestion, changed glBSP not to accept the
"infile outfile" syntax, and now it also requires an output filename
using the -o option (previously you could omit the outfile and it
would default to "tmp.wad").

Made the `Building nodes on ...' message in glBSP show what type of
nodes are built (GL and/or normal).  Added better error messages for
certain things (like an unknown option), instead of just showing the
usage information.

Began work on adding MUS music support to the Linux port, using the
`musserv' music server program (the same one Colin Phipp's LxDoom
uses)...  OK, the new file i_mussrv.c is done and the hooks have been
added to i_music.c...  Righteo, wir haben musik ! :-)  

Improved the DDF and RTS error messages even further, they both now
show the line contents when an error occurs.

2000/03/20:

Added proper keyboard support to the Linux/GL/Glut code.

Fixed a problem with the GL version where textures & sprites would be
a funny colour, since they were being converted to RGBA using the
_current_ palette which might be red-ish for pain or gold-ish for a
pickup bonus at the time.

Fixed MLOOK code in the GL renderer.  Also discovered that the problem
with disappearing walls at the edge of the screen is because the GL
camera is not congruent to the EDGE camera.  OK, fixed now :-)).

2000/03/19:

Again Linux has locked up on me while running EDGE, this time
ALT+CTRL+DEL worked but two partitions were not clean.  Either there
is some hard-to-trigger race-condition-like bug in linux (e.g. console
code), or there's something subtly wrong with my hardware.

Fixed small bug in r2_bsp, computing tx2 incorrectly.

Added very primitive support in GL code for things sprites and the
player's weapon sprites.  For now, they are just coloured boxes.

Wrote the W_ConvertSpriteRGBA routine in w_textur.c/h for converting
sprites to OpenGL format.

OK, got some thing sprites being drawn properly by the OpenGL
renderer.  There are some artifacts since sprites are not yet clipped
to subsector boundaries as they should be.

Righteo, the player's weapon sprite is now drawn properly by the
OpenGL renderer.

Made the NO_TRACE_CHANCE field in attacks.ddf use Erik's new
percentage parser.

* Uploaded EDGE 1.20 to Andy Baker :) *

2000/03/18:

Reworked zoom code.  Added a level special "LIMIT_ZOOM", when set then
the zoom key is limited to weapons that support zooming, and can only
be used when the player is holding such a weapon.  Added a weapons.ddf
field "ZOOM_FOV=<angle>" which gives the weapon the zooming ability,
and sets the FOV angle, controlling how much to zoom.

Implemented shadow, translucent and translated sprite effects in the
TrueBSP code.

Cleaned up the texture handling in the r2_gl code, moving the flat and
texture conversion functions into w_textur.c/h where they belong.

Implemented drawing the sky in the r2_gl code.

Fixed a major bug in the r2_gl code that was causing certain lowers
and uppers on 2S walls to disappear (or sometimes just be drawn
partially).  Phew, glad to have finally nailed that one down.

2000/03/17:

Made properties for player movement come from the vertical region the
_feet_ are in, instead of the one the stomach is in.  This makes a bit
more sense, the feet are making you move so you should slow down if
they are below a shallow river with high friction or low viscosity.

2000/03/16:

Fixed a bug where killing yourself (or a team mate) would give you a
frag instead of removing a frag.

Fixed the problem with TrueBSP textures sloshing about horizontally.

Nailed down the following semantics for the X/Y offsets for THICK
extrafloors: the Y offset comes from the "dummy" line, and the X
offset comes from the "real" line.  As simple as that.

Improved and optimised the TrueBSP handling of sky, now sky is only
drawn where necessary, and not everywhere like before.

2000/03/13:

Changed the error message when solid extrafloors don't fit.

2000/03/11:

Studied the r2_gl.c code looking for anything that could cause uppers
and lowers to sporadically disappear, fixed some bugs but nothing
particularly egregious.

Fixed a serious bug with the new FLOODER handling.

2000/03/10:

Fixed the WHOLE_REGION sector special which was broken.

Fixed a problem with weapons changing when picking up ammo for e.g.
rockets when the player doesn't yet have any rocket-using weapons.

Fixed y offsets for mid-masked textures in the TrueBSP code.

Reworked ddf_lang, cleaned it up a little bit.  Ideally it should
store _all_ languages, thereby allowing the language to be changed
in-game via a menu and/or console command.

Made RTS error messages generally more informative.

Moved the `thinglist' from sector_t to subsector_t, in other words
keep a list of things in each subsector rather than each sector.  This
should improve the rendering speed in TrueBSP and OpenGL mode, and
simplifies the normal rendering code too.

Added a check in R2_WalkThing() that skips the sprite if it is totally
occluded by the 1D occlusion buffer.  Later it might be worth trying
to clip against the 2D occlusion buffer.

Determined that the TrueBSP plane drawing (using a particular test
level) takes twice as long than the wall drawing for roughly the same
area.  Something is slowing it down -- it is not the call to
V_GetColtable() though.  Nor the W_CacheLumpNum/W_DoneWithLump calls.
Nor is it using the translucent span drawer by mistake.  Dunno, maybe
it's just a limitation of the span drawer vs the column drawer.

Worked some more on the OpenGL renderer, and now it draws textures on
walls.  Yeah ! :-)  It needs fixing for horizontal/vertical offsets
(plus the fact that textures are upside-down :->), but it's a nice
start...

2000/03/09:

Rather hack-ish fix for intermission camera seeing the player: make
all player mobjs invisible at end of level.

2000/03/08:

I think the way sprites are visited by the TrueBSP code is responsible
for a significant slowdown, between 10% to 30% of rendering time.
This will need fixing.

Fixed tips, the delay was 35 times too big.

Fixed the SLEEP RTS primitive.

Made teleportation not only copy the angle (in the absence of the
SAME_DIR special) but also the mlook angle.  Just for kicks.

When a monster dies, it loses the CLIMABLE property.  Should prevent
that jump over effect when killing a monster with the chainsaw (which
personally I didn't mind).

Fixed the so-called "Bouncy Bouncy" bug with the no-clip cheat.

Made the MF_SHADOW drawer never have the modulation "stop" (which
could happen before).  

Partial fix for FLOODER extrafloors, but I don't see why it fails when
the liquid levels hits the solid part of an extra floor.

2000/03/07:

Spent a while getting flats drawn in the r2_gl code.  Some stupid
mistakes and the fact that Mesa just crashed when you don't give it a
texture cost a lot of time (rebuilt bloody Mesa about four times to
get debugging info).  Nice to see the flats though :-).  Used the big
demon head on MAP20 to make sure flats were orientated the right way.

Added support for translucent flats to the r2_gl code.

Fixed the problem where plasma balls would appear on the top of a
monster when shooting it.  The code was erroneously invoking the
"climb on top of things" rule for missiles.

Implemented the code to read "<ddf-dir>/edge.scr" as the standard
place for our RTS files (no longer in the RSCRIPT lump in edge.wad).

Fixed the bug where picking up a new weapon (especially the rocket
launcher) would sometimes bring up the pistol instead.  It was the
ammo that you get with the weapon that caused the problem.

Changed the TAGGED_REPEATABLE RTS primitive, simpler now: it just
takes a single delay time, not two values like before which was
confusing.

* Uploaded EDGE 1.19 to onelist *

2000/03/06:

In levels.ddf, renamed these subfields of `END' and `PRE': PIC ->
GRAPHIC, PICWAIT -> GRAPHIC_WAIT, and added `_' to the TEXTXXX ones. 

Removed the pretty-non-useful `LUMPEXISTS' feature of lines.ddf and
sectors.ddf.

Reworked the DDF semantics (and code) for number-only files like
lines.ddf, sectors.ddf and playlist.ddf.  The ugly "[:1234]" syntax
hass been removed (no colon anymore).  For these files, only the
number (in ddf_base_t) is significant, and used for replacement and
templates; the name is ddf_base_t should be NULL and should never be
used.  The things.ddf syntax (e.g. "[IMP:3001]") and everything else
is unchanged.

Reworked docs/ddf_rule.txt to match the new semantics.

Removed the default sfx_slop from the MakeOverKillSound action, and
added the necessary OVERKILL_SOUND fields to THINGS.DDF.

Removed sfx_bosdth sound from A_BrainScream in p_enemy.c, just use the
deathsound instead.

Improved the blue and yellow text colourmaps.

Renamed stuff switches.ddf: SWITCHON -> ON_TEXTURE, SWITCHOFF ->
OFF_TEXTURE, SWITCHSOUND -> SOUND.

OK everthing still works :-).

Changed the `GiveArmour' RTS primitive, now it is like this:

   GIVEARMOUR  <type>  <amount>
   GIVEARMOUR  <type>  <amount>  <limit>

where <type> is one of GREEN, BLUE, YELLOW or RED.

Removed the hard-coded `BRAIN_SPAWNSPOT' for brain shooters, and added
the SPIT_SPOT field for things.ddf which does the job.

Removed the LINK feature from sounds.ddf.  Made the VOLUME field
(which previously was only used for linked sounds) into a volume
adjustment -- 255 means normal (the default value), lower values make
the sound quieter, larger values make the sound louder (upto a certain
point anyway).

Removed the last traces of the `playxtra' field of mobj_t.
Unfortunately this also removed the "-andymagic" cmdline option; it
will need to be reimplemented somehow.

Fixed (I think) the DDF_WGetUpgrade routine.

Made both 8 and 16 bit modes have the same darkening amount: exactly
50 percent.  Seems the best compromise between visibility of
foreground menus and visibility of the background scene.

Fixed a problem in the non-truebsp code with bleeding visplanes (ouch,
sounds painful :->) when underwater.

Fixed the problem with the noclip cheat and sinking into stairs when
you run up them.

Removed the fuzztable once and for all, now we just grab pixels from
the same column.  Looks a bit different, better in some ways.

2000/03/05:

Started work on removing the PALREMAP lump.  Converted the PALREMAP
lump into three sets of colourmaps: TEXTMAPS, PLYRMAPS and SKINMAPS,
and added all the new entries into colmap.ddf, and udjusted the
PALETTE_REMAP stuff (code and things.ddf).  Updated the sprite code to
support the new system.  Tested it with PALETTE_REMAP=ALLWHITE for
imps, yep it works (makes the imps look like mummies :->).

Changed the translation patch drawers (V_DrawPatchTrans and
V_DrawPatchInDirectTrans and 8/16 bit versions, plus M_WriteTextTrans)
to take a pointer to a translation table directly (instead of an
index).  Removed the PALREMAP code, and the `translation_tables'
global var, and added a bunch of text colour tables (text_colour_white
and others).  Works nicely.

Renamed `mission.ddf' to `games.ddf'.

Renamed GRAPHIC_NAME field of levels.ddf to NAME_GRAPHIC (for
consistency with games.ddf).

Renamed these in games.ddf: BACKGROUND -> INTERMISSION_GRAPHIC,
BACKGROUND_CAMERA -> INTERMISSION_CAMERA, MUSIC -> INTERMISSION_MUSIC,
SPLAT -> SPLAT_GRAPHIC, YAH# -> YAH#_GRAPHIC, TITLE_PIC ->
TITLE_GRAPHIC, GRAPHIC_NAME -> NAME_GRAPHIC.  Added TITLE_PRIORITY
field, for determining which titles get shown first (don't work yet).

2000/03/04:

Made the GIVEARMOUR and HEALPLAYER RTS primitives have an optional
limit value, defaulting to 200 for each.  Removed the RAD_CheckBetween
function (a two liner used in only two places).

Removed B.C. support for the old colourmap methods in lines.ddf and
sectors.ddf.  "USE_COLOURMAP=NAME" is the one to use instead.

Changed the RTS SECTORV primitive behaviour, now the increment value
is _added_ to either the floor or ceiling.  The old way was to add it
to floors, but subtract it from ceilings -- very counter-intuitive.

Change the format for anims.ddf.  Renamed "TICS" to "SPEED", and
"ISTEXTURE=0" becomes "TYPE=FLAT", and "ISTEXTURE=1" becomes
"TYPE=TEXTURE".  Updated our DDF files to match.

Looked for the reason why certain attacks (like Imp's fireball, or
Cacodemon's fireball) are misfiring.  Couldn't see anything different
from older code.  Just in case, updated P_LaunchProjectile() to have a
yoffset defaulting to 1.5 times the object's radius, so the projectile
is spawned clear of the spawning object.

Improved the angle spread of blood splats in `MoreBlood' mode.

Moved the InitTranslationTables routine from r_draw1.c and r_draw2.c
(it was not colour-depth specific code) into v_colour.c, and setup
initially along with the palette.

Fixed a bug in AdjacentSegPair() in r2_poly.c that would crash out
under certain circumstances (because really short segs fool the
perpendicular test, sneaking under the POINT_ACCURACY bar).

Discovered that the completely crap way the TrueBSP code draws the sky
(the whole sky, every frame) is a big time eater; in large resolutions
here (like 1024x768x16) it halves the framerate !

Found the problem with true spawners like the Pain Elemental: the
ddf_atk code was indeed resolving the objinitstate_ref, but resolving
it for the wrong thing.  Fixed.

Removed the "WEAPON_" prefix from all the weapon code pointers.
Renamed all weapon states to the "STATES(XYZZY)" syntax.

Wrote R_PointInVertRegion(), for determining the vertical region of an
object.  Made P_XYMovement() and P_ZMovement() use it for players, but
it is prolly too slow to be used on everything.  At least players will
experience the correct friction/viscosity/gravity.

Reworked our DDF files for the changes in states.

Changed the lines.ddf/sectors.ddf fields that begin with "FLOOR_" or
"CEILING_" to "FLOOR." and "CEILING.", in preparation for a better
system that handles subfields (reducing code).  Similarly changed
fields in levels.ddf that begin with "PRE" or "END" now begin with
"PRE." and "END.".

Renamed the lump name DDFMOBJ to DDFTHING, and removed the B.C. lump
names DDFCRTR, DDFITEM and DDFCNRY.

Made sure sprites in non-TrueBSP mode are drawn with the correct
lighting/colourmap when extrafloors are around.

OK, fixed the non-TrueBSP code to draw walls and planes in a suitable
colourmap/lighting when extrafloors are present.  Looks pretty
reasonable.

2000/03/02:

OK more work reworking the benefit/backpack system.  The code in
ddf_mobj.c is in place, but not yet tested.  OK new code for p_inter.c
is also now in place.

Righteo, the new benefit system is working well.

Fixed a bug causing the Doom 2 Finale to crash when it reached the
Pain Elemental.

Reworked the player startup code to use the new INITIAL_BENEFIT to set
the initial/maximum ammo (etc) for the player.  Removed explict
references to the "PISTOL" weapon from the code, it now uses the
highest priority FREE weapon.  New routine P_GiveInitialBenefits()
does all this.  Also removed that `maxammo' structure -- yeah !

Oh I should describe the new benefit system :).  Basically all the
previous ways (BENEFIT_TYPE=xxx, BENEFIT_AMOUNT=###, BACKPACK_XXX=YYY,
etc) are collapsed into one simple system:

    PICKUP_BENEFIT=<benefit> , <benefit> , ... ;

each benefit looks like this:

   <name>
or
   <name> ( <amount> )
or
   <name> ( <amount> : <limit> )

where the name is an ammo name (BULLETS, ROCKETS, SHELLS or CELLS), an
ammo-limit name (ammo name with ".LIMIT" on the end), a weapon name
(e.g. SHOTGUN), key name (e.g. KEY_BLUECARD, KEY_YELLOWSKULL), armour
name (GREEN_ARMOUR, BLUE_ARMOUR and the new YELLOW_ARMOUR and
RED_ARMOUR), or HEALTH, or a powerup name (e.g. POWERUP_JETPACK).

The <amount> is how much to give.  Required for everything except keys
and weapons (which you can only have 1 of).  For powerups, the amount
is the time in seconds for the powerup to last.

The <limit> is the limit on what to give.  If the player already has
the limit amount, nothing is given and the object might not be picked
up (the object is picked-up if _any_ benefit can be gotten from it).
If the player is under the limit amount, then the amount (e.g. health)
is given to the player, but no more than the limit.  [This is no
different to the previous BENEFIT_LIMIT field].  Only armour, health
and powerups can have limits.

For example the berserker box has this:

   PICKUP_BENEFIT=POWERUP_BERSERK(60:60),HEALTH(100:100);

which says: give 60 seconds of berserk strength (up to a limit of 60
seconds), and give 100 points of health (up to a limit of 100).

Another example is the backpack:

   PICKUP_BENEFIT=BULLETS.LIMIT(400),SHELLS.LIMIT(100),
                  ROCKETS.LIMIT(100),CELLS.LIMIT(600),
                  BULLETS(10),SHELLS(4),ROCKETS(1),CELLS(20);

which gives 10 bullets, 4 shells, 1 rocket and 20 cells.  It also
raises (if needed) the bullet limit upto 400, the shell limit upto
100, the rocket limit upto 100 and the cell limit upto 600.  NOTE: the
ammo-limits should be put _before_ the ammos, so that the ammo are not
restricted by the old limits.

Fixed Berserk red-ness.

2000/03/01:

Scrapped the very-non-useful NO_BRIGHT colmap.ddf special.

Made the TrueBSP code not draw missing textures (name is "-").

Added the necessary tags to the DDF files.  Removed some unneeded
stuff from colmap.ddf.

Fixed a problem in r2_poly's IntersectLines(), it wasn't detecting
parallel lines properly.

Fixed a bug in the truebsp sprite code, it seems the rocket explosions
have a large negative Y offset.

Well, it's pretty rare for Linux to just lock up solid, but that's
what happen when I tried MAP02 and rockets just now.  There was a
small bug with the above fix, but it definitely shouldn't cause Linux
to go catatonic.

Removed "TAGGED_INDEPENDANT" as B.C. primitive in RTS.

Reworked ready_wp/pending_wp stuff again, to support having no weapon
at all.  Works a treat.

Put back "TAGGED_INDEPENDANT", at least until our own RSCRIPT lump is
fixed...

Began reworking backpack support, and a more generic item system.

Removed the hack-ish support for more than 4 ammo types.

2000/02/29:

Looked for a bug where missiles that _should_ hit a lower wall part
that sits on a sky floor are disappearing instead.  For some reason,
the missile survives P_XYMovement(), but then hits the floor in
P_ZMovement().  Dunno why yet.

Changed ddf_lang.c so the filename is now "LANGUAGE.LDF", and the
default language name is "[ENGLISH]".

2000/02/28:

Started to rework the extrafloor code.  Removed EXFL_TURN_OFF type &
EXSP_FallThrough special, and added a new EXFL_LIQUID type.  Fixed
P_ComputeSectorRegions() to handle new semantics.

Fixed a bug in glBSP causing it to segfault when building normal nodes
on an WAD fresh out of Yadex.  A single semicolon out of place (man
that sucks).

Added fix to truebsp renderer for sprites that have top_offset less
than the sprite height.  Normally this causes the sprite to sit a bit
lower, quite common it seems and I think the ID guys did it for better
realism, but for TrueBSP it causes problems since the sprite may lower
into another on-screen subsector (and hence ugly overdraw).

Fixed a bug with RTS: RAD_Init() should happen after
SpecialWadVerify(), so that scripts via "-script" are loaded after the
RSCRIPT lump in EDGE.WAD.

2000/02/27:

Made player weapon sprites drawn with the correct light level /
colourmap when extrafloors are present (e.g. when underwater).

2000/02/26:

Fixed some damn stupid bugs with the weapon code (ddf_weap.c and
p_weapon.c).  Secondary attacks work properly now, clipsize and reload
states and automatic firing, etc.  Also fixed the ordinary CHECKRELOAD
code pointer which got broken too.

Added "EJECT_ATTACK=" field for weapons.ddf.  This is the attack used
by default for the WEAPON_EJECT code pointer.

Merged in the new build-walls code from r2_bsp.c into r2_gl.c.  Made
the prototype GL renderer use flat lighting on the solid-colour walls
and planes -- an improvement.  Texturing is sure going to kick arse.

Worked on truebsp vertical sprite splitting code.  Righteo, seems to
work, and that cacodemon rising out of the translucent water in my
BMWATER wad looks sweet as.  I made sprites that are near the bottom-
most floor or top-most ceiling behave like in normal Doom: not clipped
to them.  Prevents a small problem with the tops/bottoms of sprites
(like health potions) being chopped off.

2000/02/25:

Hmmm, the PTR_ShootTraverse changes for extrafloors needs improving,
it occurs that it still allows monsters underneath a solid extrafloor
to be shot through it (since the monster occurs in the intercept list
before the linedef where extrafloor checking is done).  Ouch.  One
solution comes to mind: put floors/ceilings in the intercept list
(adding extra code to PathTraverse routine).  Will try this.

* Uploaded EDGE 1.18 to onelist *

2000/02/24:

Added a check to p_setup.c which checks for linedefs that are marked
TWOSIDED but only have one sidedef.  The converse, having two sides
but with the TWOSIDED bit clear, is allowed and used for certain
tricks (IIRC lines that you can see through but not shoot through).

Worked on fixing PTR_ShootTraverse to (a) fix certain cases of being
able to shoot the sky, and (b) check for and hit extrafloors (top,
bottom and sides thereof).  In doing so, made `bulletpuff' a static
variable of p_map.c (de-globalized it), and passed explicitly as a
parameter to P_LineAttack().

Reworked secondary attack support.  Renamed the DDF fields to be
following names:

    SEC_AMMOTYPE=    SEC_AMMOPERSHOT=
    SEC_CLIPSIZE=    SEC_AUTOMATIC=

and the following state sets:

    SECATTACKSTATE=      #SECATTACK
    SECRELOADSTATE=      #SECRELOAD
    SECFLASHSTATE=       #SECFLASH

and the code pointers are now:

    WEAPON_SEC_SHOOT
    WEAPON_SEC_REFIRE
    WEAPON_SEC_NOFIRE
    WEAPON_SEC_FLASH
    WEAPON_SEC_CHECKRELOAD

While I was at it, renamed WEAPON_SPAWN to WEAPON_EJECT (since it was
pretty useless for anything but ejecting shell effects), and made it
completely not affect ammo or ever need any (i.e. the attack no longer
needs the NOAMMO special).

2000/02/22:

Added `DDFMUSIC' lump (w_wad.c) as lump for playlist.ddf.

Finally got round to re-implementing the R2_BuildWalls() routine in
r2_bsp.c.  Tested it, haven't seen any problems, and texture alignment
seems to be OK (and it should be better now with extrafloors).

Discovered why some sky parts produce puffs: the P_ShootTraverse()
routine only does partial checking, and never explicitly against
uppers & lowers (relying on hitting a one-sided wall).  Will fix.

2000/02/21:

Made zero damage attacks not call P_DamageMobj(), thus monsters are
not woken up or enter their pain states when damage is zero.

Moved RAD_Init() down the initializer list, so that scripts can find
stuff like things.ddf and sounds.ddf entries.

Improved the error messages for DDF.

Removed last bits of the prototype slope support (HEIGHT() etc).

Made sure the Linux/GL code (and r2_gl.c) still compile and work.

Fixed a bug I introduced where selecting a weapon (when cheating) that
doesn't have a sprite (e.g. BFG with the DOOM 1 shareware WAD) would
crash.

Improved mid-masked textures in TrueBSP mode.

Fixed a bug causing the cube shooter on MAP30 to go awry when
restarting the level.  In doing so, moved the shoot_to_spot targets
into the mobj_t struct.  That not only allows multiple brain shooters
per level, but is a good way to ensure the spot info is archived
properly in savegame files.

2000/02/20:

Fixed our sounds.ddf file.  Fixed the sounds.ddf NAME= backwards
compatibility field to change the dynamic name (Ugh !).  Backwards
Compat. sucks major arse...

Made the DDF parser produce an error instead of just ignoring
unexpected characters.

Fixed a memory leak (DDF_MainCreateUniqueName) in the ddf code, and
prevented a name lookup when the name is null, and changed
DDF_MainCreateUniqueName() to accept the current number of XXX to
append to the string, so that the unique names won't change for one
DDF file (e.g. lines) when another DDF file is edited -- preventing
potential problems with savegames.

Fixed a problem where the NORMAL_BLOOD level special was forcing more
blood _on_ instead of off.  Added a "MORE_BLOOD" level special to
force it on.

Fixed a problem causing EDGE to crash when completing MAP30.  An
object (in this case the death missile) could be removed in
P_MobjThinker() (e.g. by hitted a wall or floor), thus setting
mobj->state to NULL, but the run-state loop assumed it was valid.

Fleshed out a future-friendly save-game system some more.

2000/02/18:

Fixed a problem with numbers in DDF headers (e.g. [IMP:3001]).

Reworked all our DDF files for the latest changes.

2000/02/17:

Made DISLOYAL and ATTACK_HURTS apply not only to missile attacks,
but now also to shooting attacks and close combat attacks.

Implemented support for usable things.  The things.ddf special flag
"USABLE" will mean that when a player tries to "use" the thing (i.e.
via the spacebar), it will enter its TOUCH_STATES.  The TOUCHY_REARM
code pointer must be used to re-enable usability.

Implemented new path support: the code pointers "PATH_CHECK" which
jumps to the meander states if the thing is a path follower (use it in
the very first IDLE_STATE), and "PATH_FOLLOW" which makes the thing
follow the path.

Refined the PATH_FOLLOW algorithm, monsters now follow paths much more
like what you would expect, and can handle obstacles getting in their
way.

Made MEANDER and CHASE states by default (i.e. without any redirector)
loop back to themselves.  Fixes some problems.

* Uploaded 1.17 sources to onelist *

2000/02/15:

Added `last_redir' field to state_starter_t, for complete control over
which states jump (by default) to which states.

Replaced some #ifdef DEVELOPERS stuff in ddf_main.c with DEV_ASSERT2.

Replaced DDF_MainGetLumpName() with DDF_MainInlineStr10() and
DDF_MainInlineStr32() for inline strings (e.g. char startname[10]).

Replaced most `char *xxx' in the structures in ddf_main.h with either
`char xxx[10]' or `char xxx[32]', and used the above two routines to
read them.  This prevents problems with allocated string pointers
being overwritten (and the memory lost), especially with templates in
the picture.

Found the non-rising weapons problem (they would instantly appear).
Turns out that the UP states (and I presume DOWN states too) should by
default redirect to themselves.  Fixed.

Fixed the `lastattackdown' kludge in st_stuff.c, using a new field
`attackdown_count' in player_t.  Reworked the ST_UpdateFaceWidget()
routine some more, moving the face variables into player_t, and did
some tidying up.

Made P_KillMobj() remove MF_SPECIAL from the flags.  That should
prevent the multiple pickup problem.

2000/02/14:

Moved the grin stuff into the player_t struct, and removed the
`oldweapons' static var from st_stuff.c.  One small step towards a
multiple player capable status bar system.

Renamed `newhupd' to `stbar_update', and removed that really weird
ST_Responder(AM_MSG*) shit from am_map.c.  Did some more tidying up of
the st_stuff.c code (e.g. moved st_oldhealth into player_t).

Removed the unused `retrace' option, and the unused `novert' var.
Removed the unused `backpack' field of the player_t struct.  Removed
the unused `type' field of mobjinfo_t and mobj_t.  Removed
`weaponupdate', and `available' in weaponkey_t has become
`avail_weapons[6]' in player_t.

Reworked ammo, merging the amount and maximum values into a new
structure: playerammo_t.  Moved creation of the `weaponkey' array from
on-the-fly in DDF_WGetBindKey, now it is done all-at-once in
DDF_WeaponCleanUp().

OK, weapons are now mostly working again.

2000/02/13:

Decided to put off implementing "template capable" state code until
the new stuff all works again.  What was going to take just 1 day's
work (this DDF overhaul) has already become 5 days work -- ugh.

Added support for mice wheels under Linux/LibGGI.

Removed code to sort mobjinfos.  A simple cache will suffice (I made
sure that modulus 211 was a reasonable hash value), plus the code
should find *newer* thing entries when doing number lookups, but the
old sorting code destroyed the old/new ordering.

Half way thru converting the DDF stuff to stack arrays...  Easier than
what I thought (the stack array stuff RuLeZ).  OK, done.  Hope it
compiles :).

Replaced F_GetNextActor() with DDF_MobjLookupCast().

Whoops, started doing some weapon reworkings, but it's a bigger job
than expected.  Will "hack it" and fix later.  Ugh II.

Renamed p_pspr.c to p_weapon.c, and moved some weapon routines into
there from p_action.c.

OK, got it compiling again and working again.  Weapons are FUBAR,
backpacks most likely as well, and maybe sound too on the ports that
have it, and the DDF files themselves need an overhaul, but most
things are working properly now.

2000/02/12:

Ow!  Realised something today that I should never forget: Z_ReMalloc'd
arrays and pointers don't mix.  I'm tempted to convert _all_ the DDF
arrays into linked lists just so it never bites me again.

Hmmm, looks like a job for the "Stack Array" (duh da da da!).  Hohum.

Separated the weapon code pointers from the thing code pointers, and
moved them back out of ddf_stat.c into ddf_weap.c and ddf_mobj.c.

Added DDF_LinedefCleanUp(), to take care of teleport MOBJs.

Righteo, everything compiles once again, but I know the semantics are
wrong in a number of places, so I don't expect it to run properly yet.

Found some mistakes in DEFAULT.LDF, there are places where quotes (")
are used inside a string but are not quoted (like this: \").

Well, the main part (menu, titlescreen, etc) still works, but no go
for the rest.  States are really really tricky (especially with
templates in the picture), I'll need to rethink them and re-implement
the state code.  Doing that, plus converting all ddf parsers to stack
arrays, should fix everything, but take quite a while :-((.

2000/02/11:

Worked more on the DDF overhaul...  ddf_mobj.c now compiles...
ddf_atk fixed and compiles.  That completes the ddf* files for the
overhaul, now gotta fix everything else...  Moved cleanups into their
own files (ddf_atk: DDF_AttackCleanUp, ddf_mobj: DDF_MobjCleanUp,
etc).  Removed `mobjinfohead' and the linked list, fixing the 3 places
that used it.  Removed `COMMAND_TERMINATOR', and made the lists be
terminated with NULL names.  Constified all the command tables.  Added
an extra parameter (`private') to the commandlist_t function, which
will be used to pass extra info to the parser routine (especially for
states).  Moved the actioncode list into ddf_stat.c, I'm sure it is
the best place for it now.  Wasn't planning to rework the state code
(and that FDF_ stuff) just yet, but it was getting hard to ignore, so
what the hell...  Also doing lots of CONSTifications along the way.

State stuff coming along.  Implemented preliminary support for labels,
like this:

    TROO:A:1:BRIGHT:@MYLABEL:CODE_POINTER,
                    ^^^^^^^^
Only one label per state allowed (like RTS).  Can't be used for the
very first state frame of a list (e.g. SPAWNSTATES=), since there the
label is already in use (e.g. "SPAWN").  Paves the way for more
readable jumping-to-different-parts-of-the-script abilities.

2000/02/10:

Reworked the `parse_field' stuff in the new DDF parser.  Cleaner now.
This also fixed up some ugly hacks for LDF.

2000/02/09:

Added utility routines to m_crc32.c to process integers, fixeds,
floats and strings.

Removed the prototypical support for true sloped floors/ceilings.
There's way too many changes (big, complex changes) needed to fully
support slopes, so for now I'm not going to worry about it.  Too much
other stuff that needs doing.

Began some heavy duty reworking of the DDF code.  Moved all state
stuff from ddf_main.c to the new file ddf_stat.c.  Moved various bits
in ddf_main.c elsewhere.  Fixed ddf_anim.c.  Fixed ddf_swth.c.  Fixed
ddf_colm.c.  Fixed ddf_mus.c.  Moved switchlist_t from p_spec.h into
ddf_main.h.  Moved sfxinfo_t from lu_sound.h into ddf_main.h, making
lu_sound.h obsolete.  Fixed ddf_sfx.c.  Moved gamma table from
v_colour.c to new file lu_gamma.c.  Fixed ddf_weap.c.  Fixed
ddf_main.c (no template support yet).  Fixed ddf_lang.c (just as
hack-ish as before however).  Fixed ddf_game.c and ddf_levl.c.  Fixed
ddf_sect.c and ddf_line.c, converting the hash table into a simple
cache (hashing no longer needed now that line_t and sector_t contain
direct pointers to the info, like with mobjs).  Phew, what a slog !

2000/02/08:

Implemented "Second Attacks".  Apart from an extra key, this includes
the following fields for weapons.ddf:

   SECONDATK_AMMO=ROCKET;
   SECONDATK_PERSHOT=1;
   SECOND_ATTACK=PLAYER_MISSILE;
   SECONDATK_STATE=...;

plus the "WEAPON_SECONDATK" code pointer which fires the weapon using
the second attack ammo & states.

Implemented the "WEAPON_KICK(amount)" code pointer, which produces a
kick effect, bigger values inside the brackets produce bigger kicks.
The value (and the brackets) can be omitted, in which case the default
value (0.05) is used instead.

2000/02/05:

Added support to truebsp code for BRIGHT things, and partial support
for SHADOW things.

Replaced `int sidenum[2]' in the linedef structure with pointers to
the sidedefs themselves.  Makes for neater code.  Along the way, added
some sanity checks (e.g. PTR_ShootTraverse), which should fix the
crash a got a short while ago.

Reworked the "doc/ddf_rules.txt" document a bit.

2000/02/03:

Implemented new RTS pritimive:

    WHEN_PLAYER_NUM  <num>
    WHEN_PLAYER_NUM  <min>  <max>

and such an RTS trigger will only be placed on the map when the level
is started with the specified number of players.  The first one
requires an exact match.  The second one gives a range.

2000/02/02:

Renamed "invisibility" in some structures to "visibility" which it
logically is (0.0 means invisibile, 1.0 means solid).  Renamed
deltainvis to delta_vis accordingly.

Wrote DDF_MainCheckSpecialFlag() routine, which has support for
matching names with different prefixes, e.g. if "FOO" is matched it
returns CHKF_Positive, and if "NO_FOO" is matched it returns
CHK_Negative.  Only "FOO" has to be in the flag table.  Other prefixes
are ENABLE_, DISABLE_, and USER_ which is for level specials, meaning
"don't force the option on/off, but let the user decide".  Part of
this generalisation is for supporting DDF templates, which need a way
for entries to undo some "SPECIAL=" flag in the template.

Renamed "gameflags" to "level_flags", and "settingflags" to
"global_flags", so that their purpose is more obvious.  Renamed
"respawnsetting" in gameflags to "res_respawn", and made it a
boolean_t.

Changed `flags' in the mapstuff structure to two new fields: force_on
and force_off.  The idea is, any user-controllable setting can either
be forced on or force off by a tag in the level's specials.  Therefore
all the MPF_XXX / MPF_NO_XXX pairs were singularised, and the g_game.c
and m_option.c code has been generalised.

Made the `e_exit' field of the DDF sector/line structures enum-erated
with an "exittype_t" typedef.

Okidoke, updated all the specflags_t lists (and their parse routines)
to use the DDF_MainCheckSpecialFlag() stuff.

Fixed a bug that crashed TrueBSP mode when you got the invisibility
powerup (fuzz_coltable was not being initialized).

Wrote the new file m_crc32.c, based on the Adler-32 algorithm as
described in RFC-1950.  

2000/02/01:

Began work adding HEXEN support to glBSP.  First thing: handle the
extra level-specific lump "BEHAVIOR"...  Done.  Second thing: handle
the different format "LINEDEFS" lump...  Done.  Hope that's all :-).

Fixed two bugs in glBSP: (1) The "load_all" option was reversed, it
should default to off, but the code was reading everything into
memory.  (2) The non-load_all mode was broken.

Hmmm, it seems the level markers (MAP01, etc) in Hexen actually have
some data (12 bytes, nul-terminated "version 2.3").  Will need to fix
glBSP for that...  Done.  Tested it, and it works :->.

Fixed a small bug in glBSP causing a bogus "Read directory consistency
failure" when it processed a wad file that contained GL_* lumps.

Made the attack special `REMOVE_FAILED_SPAWN' the default, and added a
new special `KILL_FAILED_SPAWN' which must be used now to get the
"kill-on-fail" behaviour (which is only useful for rockets, so they
can blow up in your face instead of disappearing).

2000/01/31:

Made the "primitive out of place" error messages in the RTS parser
more informative.

Fixed the problem with monsters not sighting the player properly.

2000/01/29:

Made the ENABLE_SCRIPT and DISABLE_SCRIPT RTS primitives not konk out
when a trigger with the given name doesn't exist on the map.  Prints a
warning and does nothing else.

Made the SECTORV RTS primitive accept the words "FLOOR" and "CEILING"
for the third parameter (as well as a pure boolean).

2000/01/28:

Improved the "bad boolean" error message.

2000/01/26:

Fixed a bug in glBSP where it konked out on an Eternal level due to
creating a zero-length seg.  Seems it is possible for the cut-list to
contain empty cuts.

Discovered something with glBSP in seg.c: the `a' and `b' values can
be pretty big, and so can the length, thus "len * a" overflows the 32
bit range, producing erroneous results.  Hmmm....  OK, functionised it
and made it use floating point when `a' or `b' are large.

Excellent !  The whole of Eternal now builds in glBSP without
crashing...  Great, MAP01 works a treat in TrueBSP mode.

2000/01/23:

Small changes to P_CalcHeight in p_user.c, to prevent the viewheight
getting "stuck" in a low position.

* Uploaded EDGE V1.16 sources to my home page (since damn onelist
* wouldn't accept it).

2000/01/18:

Removed the RTS #INCLUDE primitive.  Nobody uses it, plus the present
code was not reentrant like it would need to be (and making it
reentrant would be a lot of work).

Added `spriteheight' array, analogous to `spritewidth'.  Needed for
TrueBSP rendering.  Good, this fixes the problem with fireballs only
being half drawn.

2000/01/14:

Worked on the `glBSP' and `GL-Friendly Nodes' webpages tonight, the
former still has some long ways to go but the latter is more-or-less
finished.

2000/01/13:

Cleaned up r2_bsp.c, removing the ALTERNATIVE code, and implemented
the 2D clip buffer (a la normal Doom).

OK, new r2_bsp system with both 1D and 2D occlusion buffers is now
working.  Amount of overdraw is definitely reduced, and there is
plenty of room for improvement.

Implemented the final pieces for drawing sprites in TrueBSP mode.

2000/01/12:

Made the WHOLE_REGION sector special _not_ make the damage
proportional to the amount you're in it.  Instead there's a new sector
special: "PROPORTIONAL" which does the trick.

Implemented weapon specials, following the trend of line & sector
specials.  Currently only one is defined:

     SPECIAL=SILENT_TO_MONSTERS;

which means that monsters won't be woken up when this weapon is fired.

2000/01/10:

Forgot to implement tagged stuff for RTS...  So today I implemented
the following RTS primitives:

     ENABLED_TAGGED   <tag num>
and  DISABLED_TAGGED  <tag num>

which work just like the lines.ddf and things.ddf stuff with the same
names.

Discovered that EDGE crashes when no levels are defined in levels.ddf,
but I can't for the life of me find why !  Tried NULL-guarding the two
places where `currentmap' var is set, and still a NULL-deref seg
fault.  Must be: it isn't set at all somehow.  Too bad, don't wanna
waste any more time on it tonight.

Made the RTS primitive TAGGED_REPEATABLE's <delay> parameter optional,
defaults to 1 tic delay.  Omitting it is mainly useful for triggers
that begin with a SLEEP or WAIT primitive.

2000/01/09:

Implemented new RTS primitive "SLEEP".  All it does is disables the
trigger -- it goes to sleep.  The trigger will only wake up when
another trigger (etc) enables it.  When it wakes up, it continues from
where it left off (i.e. at the very next primitive).

Allowed RTS triggers to have tag numbers, like sectors do.  The format
is what you would expect: TAG 123 (for example).  What's the point of
that, you ask ?  Read on...

Implemented the following fields for lines.ddf:

     RADIUS_TRIGGER=ENABLE_TAGGED;
and  RADIUS_TRIGGER=DISABLE_TAGGED;
 
when such a line is activated, all the radius triggers that have the
same tag as on the linedef will be enabled or disabled.  Doesn't
matter if the line was activated by player, monster or missile.

Implemented new code pointer for things:

     ACTIVATE_LINETYPE("linenum, tagnum");

which works exactly the same as the RTS primitive of the same name.
Mainly useful for BOSSES, as a faster alternative to ONDEATH (which is
quite sub-optimal ATM, it must check every thing on the map, and that
is expensive when there are 1000+ things !).  The quotes are necessary
for now, not enough time to rewrite the whole DDF parser... :)

Added the following two new code pointers for things:

     RTS_ENABLE_TAGGED(tagnum);
and  RTS_DISABLE_TAGGED(tagnum);

which work just like the new RADIUS_TRIGGER linedef fields above: all
triggers with the same tag are enabled or disabled.  Mainly useful for
BOSSES, as a faster alternative to ONDEATH.  This basically completes
the LINES <--> RTS <--> THINGS interactivity methods.

Fixed a small problem in ddf_main.c, checking the action name against
the list now uses DDF_CompareName, so that both "RANGE_ATTACK" and
"RANGEATTACK" can be used synonymously.

2000/01/07:

Implemented the RESET_PLAYER special for lines.ddf.  When you start
playing such a level, you lose all weapons and armour and health goes
back to 100%, like you had died and pressed spacebar to restart it.

2000/01/06:

Weird thing: the functions RAD_ParseSectorMove and RAD_ParseTaggedPath
just vanished from the rad_pars.c file -- and I don't know how.  Maybe
it has something to do with the power failure I had the other night
when I was editing the rad* files (but they compiled fine yesterday
morning).  Odd !

Made RTS scripts support multiple ONDEATH and ONHEIGHT conditions.
They *all* have to succeed before the trigger will activate.  The
opposite way (requiring *any* to succeed) is still possible: have a
trigger for each condition, and let each trigger do an ENABLE of
another common trigger which does the actual action(s).

Began work on new TrueBSP sprite clipping code.  Each drawsub will
keep a list of "clip segs", used for clipping sprites.  Sprites are
initially on a "raw" list, parts that remain completely within the
subsector are moved to a "good list" (which is later split vertically
against the multiple floors).  Sprites that cross a clipseg are split,
and the other part is moved to the raw list of the drawsub on the
other side of the clipseg.  Once all the visible subsectors have been
visited, a few extra passes over them will be needed to split sprites,
until all the sprites are 100% contained in their own subsector.

Well, fuck.  Just found a problem with the TrueBSP concept of "clip
sprite billboards at subsector boundaries" -- part of a sprite may be
visible, but the subsector containing the sprite may NOT be visible,
so that subsector is never visited, and thus the visible portion of
the sprite never makes it into a drawsub, so never gets drawn.  Argh.

OK, OK, a solution comes to mind: the checks for whether a node or
subsector are visible need to be extended, so that the RADIUS of the
biggest object contained within it is added to each side of the
checking coordinates (i.e. the bbox).  The trick is: computing
"biggest object" in an efficient way -- maybe by keeping a maximum
value which can be increased whenever an object moves into the
subsector, and doing a gradual recomputation of the real maxima over
many seconds (e.g. 5 subsectors on each tic).  Node values can be
adjusted every time the renderer walks the BSP tree (so better values
bubble up the tree over a second or two).

Despite that problem, sprites are now being more-or-less correctly
clipped to subsector boundaries :).  Still a few glitches to sort out,
like bits of monsters poking though thin closed doors, but I'm ready
to implement drawing the actual sprite images.

2000/01/05:

Made code that wants to printf the difference between two pointers
(which is `long' in DJGPP, but `int' in Linux) explicitly case to
(int) to prevent warnings.

Extended the RTS primitive PLAYSOUND with an optional <z> parameter.

OK, new radius trigger system is working.

Changed the RAD_CheckForXXX functions to have no return value (when an
error occurs, it doesn't return anyway).  Likewise removed the
boolean_t return type from the parser functions.

Implemented the long-awaited "WAIT" RTS primitive.  Takes one
argument: the number of tics to wait.  Wow :).

Implemented limited RTS support for jumping around scripts.  There are
two new primitives:

     LABEL  <name>
and
     JUMP  <label>  <random chance>

The former gives an RTS state (i.e. the following action primitive)
the given label.  The latter will jump to that state WHEN the random
chance is fulfilled.  It works line PAINCHANCE -- 0 is never, 127 is
50% chance, and 255 is always.  The chance value can be omitted, in
which case the jump always occurs.  This paves the way for
script-external entities (like things, lines, other triggers, etc) to
make RTS triggers jump to named states -- potentially very powerful.

2000/01/04:

Began some heavy duty RTS changes.  Split all the parsing code off
into a new file "rad_pars.c".  Rewrote the RAD_LoadScript function,
merging the two readers (file & lump) into one.  Reworked the error
handling, now there's just RAD_Error() which takes a string directly
(not unlike DDF_Error).  Split the radius trigger structure into a
static half (rts_script_t) and a dynamic half (rts_trigger_t).

Moved RadiusScrCheck into rad_trig.c and renamed it RAD_Init.
Replaced RAD_ResetRadiTriggers with the RAD_SpawnTriggers /
RAD_ClearTriggers pair.  Implemented the radius trigger state machine,
using tics just like MOBJs, and re-implemented the Tagged_Repeatable
handling.  Removed the ol' hash table code, it served us well but now
it is no longer needed.

Note: in the new RTS code "SCRIPT" refers to the static non-changing
part, and "TRIGGER" refers to a dynamic per-level part.

2000/01/03:

Removed the TRUEBSP #if..#endif conditionals from the code. 

Split off the OpenGL code from r2_bsp.c into a new file: r2_gl.c, and
made sure that it still works.

2000/01/02:

Reworked RTS primitive ACTIVATE_LINETYPE.  Now it only takes two
parameters (line type and tag number), the other parameters (method
and side) were pretty redundant.

Reworked RTS #define code -- replacement now occurs automatically
during CollectParameters().  No need for the manual checks used
previously.  Also #define values can now be any single valid token
(not just integer numbers like before).

Changed the `special' field in the sector_t and line_t structures to
be references to the DDF structures: specialsector_t and linedeftype_t
(or be NULL when not special).  Slightly more efficient, but the main
benefit is simplicity in the code (can access the special info without
having to call DDF_GetFromXXXHashTable everywhere).

DDF-itised the crusher info with new sectors.ddf fields CRUSH_TIME and
CRUSH_DAMAGE.  Similar semantics to the DAMAGETIME and DAMAGE fields.

Added an optional `threshhold' parameter to the ONDEATH primitive:

    ONDEATH  <thing>  <threshhold>

and the trigger will only activate when the number of living things of
the specified type becomes less than or equal to the threshhold.
Defaults to zero (i.e. *all* things must be dead).

Implemented yet another new RTS primitive:

    DAMAGE_MONSTERS  <monster type>  <damage amount>

which will damage all monsters of the specified type (either DDF name,
or DDF mapnumber, or "ANY" to damage any type of monster) which are
locating within the trigger's radius.

Made the RTS primitive TIP's time & sound parameters optional (time
defaults to 3 seconds, sound defaults to FALSE).

Added "EXTEND_MAP" to RTS, which is like "START_MAP", but it doesn't
clear out any previous triggers (it _extends_ them with some new
triggers).

Improved mid-masked texture rendering in -truebsp mode.

1999/12/30:

Fixed a small problem of EDGE not detecting BPP == 3, which is out of
range of the video func table.

Fixed missile-activation lines, both on impact, and pass-through.

Tried a new algorithm for R_DrawFuzzColumn16().  Looks OK, but it's
rather slow (which goes to show, that Alpha Sprites are going to be
quite slow too).  Made the fuzzing color be dc_colormap[0], at least
_some_ limited control is now possible using colmap.ddf.

Did some work to get mid-masked textures rendered by the TrueBSP code.
Wrote an initial R2_DrawMaskedColumn() routine -- boy do we need a
better texture management system !  ...  OK, got the railing behind
you on MAP01 drawn partially correctly -- the posts themselves are
fine, but the texture mapping *within* each post is screwy.

1999/12/29:

Fixed a bug (noticeable in MAP18) causing HOM where there the sky
should have been drawn.  Bug occurred because the I added a check
which prevented further BSP traversal when the sector behind the line
has ceiling height <= floor height.  Sounds reasonable (there is
already a similar check for back-ceiling <= front-floor), but you
need to reach a one-sided wall to get the sky drawn.

OK, got sprite billboards being clipped to subsector boundaries.  One
problem has surfaced: a sprite whose unclipped portion lies totally
off the left or right side of the screen is being clobbered.  Weird !

Ahh... the problem occurs because drawthings are already clipped to
screen, so the intersection point seems to be totally off the sprite.
I can see now that this _REALLY_ indicates the whole drawthing should
be moved into the bordering subsector.

Fixed that little problem, now I've got another one: when adding a
drawthing into an already visited subsector, the segs have already
been visited and so the pieces don't get further clipped.  Sigh...

1999/12/27:

Changed R_SortVisSprites and removed the Z_Malloc/Z_Free (using a
realloc array instead), since normal memory allocation can eat up
quite some time.

Fixed QSORT macro in e_search.h to allow pointer types.

Sprites are now being sorted correctly within each subsector.

No wonder my core dumps were so big, the Linux code was doing an extra
Z_Init !  Fixed that little problem quick smart.  Also put a line in
e_main.c to show the amount of memory initially allocated for Zone.

1999/12/26:

Started work in TrueBSP for rendering sprites.  Got some very pretty
flashing squares going (as an ultra-rough prototype), and will now
concentrate on the crux: splitting sprite billboards across subsector
boundaries.

1999/12/25:

Fixed bug with background cameras, being stuck when choosing the
`New-Game' option from the menu.

Completed support in EDGE for "GL-Friendly Nodes", by implementing the
checking and loading code for "GWA" companion files.

1999/12/22:

Fixed glBSP's "GWA" mode.  Verified that it works: yep, just fine.
Added code to check for unclosed subsectors, and subsectors that have
segs from different sectors.  Improved intersection calculation and
also parallel-line checks by using the _original_ (before any splits)
extent of the seg (prevents accumulation of round-off errors).

Fixed a bug that caused glBSP to crash.  It was making a zero-length
segment when splitting.  Now _all_ calculations from partition lines
use the t* fields instead of p* fields (in the seg).  In other words
we always use the original extent as the partition line (and never the
actual seg which is subject to round-off error).

1999/12/20:

OK, implemented the MINISEG adding code for glBSP, and generally
debugged everything until it worked.  I'm almost ready to implement
the EDGE code to actually _USE_ this GL-friendly node lumps.  Removed
the `CheckConvex' routine; now for the convexicity test I'm just
relying on PickNode() to fail.

Fixed a problem with the "MUST_REACH" line special.

Started to implement the "GL-Friendly Nodes" specification in the EDGE
sources.

1999/12/18:

glBSP is coming along.  Implementing vertex system today, which will
allow the DivideSegs code to determine where to place new minisegs
along the BSP divider line.  Improved the calculations of where a seg
is split.  Made sure when choosing a partition line, that there is
always at least one REAL seg (i.e. not MINISEG) on each side.

Yes !!  glBSP is actually working now, albeit only for the normal BSP
node information, but the only thing left for "GL Friendly" nodes is
to implement adding minisegs in the open spaces along divider lines.
With the new vertex system, it should be a snap !

1999/12/17:

Altered radius trigger check slightly.  New code allows a radius of -1
AND a height range to mean what you'd expect: you have to be within
the height range, but in no particular 2D location on the map, for the
trigger to activate.

More glBSP work...  Removed support for "coalesce" sectors.  Got the
logic sorted out for handling either NORMAL node building or GL node
building or BOTH simultaneously.  Implemented the vertex & linedef
pruning functions.  Fixed up the semantics for the `index' field of
segs, subsecs & nodes, and wrote a "double bubble" sorter for segs.

1999/12/11:

Worked some more on glBSP.  Compared the left/right height results
with the old BSP: generally as good, and in some cases a lot better
(especially MAP24 -- prolly something to do with those really thin
walkways).  Fixed the SortLumps routine.  Showed the progress
indicator when reading & writing the input/output wads.

1999/12/09:

Improved handling of COUNT_AS_KILL and COUNT_AS_ITEM things which are
spawn by RTS: when the trigger is once-only and immediate, the total
number is increased, otherwise the object loses the COUNT_AS_XXX
property.  Should make intermission stats correct now.

1999/12/08:

Floatified DAMAGEPLAYER, HEALPLAYER & GIVEARMOUR primitives in RTS.

Reworked ONDEATH, now accepts a thing name directly.

Added new RTS primtive:

   ONHEIGHT  <low Z>  <high Z>
   ONHEIGHT  <low Z>  <high Z>  <sector num>

which only allows the trigger to activate when the sector's floor
height is in the range low..high.  If the sector number is missing,
the sector containing the radius trigger is used.

Implemented line special "SWITCH_SEPARATE".  Such a switch will only
change the texture on the pushed linedef, and not all the other
linedefs with the same tag.

Fixed missiles crossing special lines (allowing them to activate
them).

Reworked "GL Friendly Nodes" specification into HTML.

1999/12/07:

Renamed "DAMAGE_SPECIAL" to just "SPECIAL".  Like things (and other
stuff in DDF), both sectors and lines will have a field called
"SPECIAL" which contains a comma-separated list of miscellaneous tags.

Implemented line special "MUST_REACH", such a linedef cannot be pushed
(e.g. a switch) unless the player can vertically reach that linedef.
The switch should be vertically indented into a niche for this to work
properly (the _whole_ linedef is tested for reachability, not just the
part where the switch texture is !).

Cleaned up the donut stuff in p_plane.c.  Now the donut info doesn't
have to be maintained whenever the linedeftype_t type is extended.

Fixed a bug in GAP_RemoveSolid in p_maputl.c.

Made P_ActCreateSmokeTrail in p_action.c center the smoke trail
vertically behind the rocket better.  Not perfect, because the rocket
sprite has a big YOFFSET.

Extrafloors now always visible on automap, thanks to the new
CheckSimiliarRegions() function.  This is only called when either
front or back has > 1 storey -- thus no slowdown in the general case.

Improved the "use switch" test, a bit more stringent.  Paves the way
for having more intelligent switches (like not being able to press the
one in MAP02 once the platforms have been lowered).

When dead, you now lose the jetpack.

Improved handling of "floor > ceiling" cases in p_maputl.c.  Shouldn't
crash now when weird things happen (like with 3D platforms).  The
P_ChangeSector() code REALLY needs an overhaul, to cope with 3D floors
fully: instead of "change height, then make everything fit again" it
should be more like: "test what happens when floor/ceiling is adjusted
by <n>", and then make the moving plane either crush, stop or reverse.

Fixed problem of spawn attacks and stuck APLSA0 sprites.  Problem due
to using P_DamageMobj() to kill an object, but the object may not be
SHOOTABLE and thus damage has no effect.

1999/12/05:

Added an extra debug check in R_DrawMaskedColumn, to find the bug.
Don't understand what causes the problem, unless it is some funky "NaN
or INF value" thing being compared wrong (and converted to a very big
integer).

1999/12/01:

DDF-itized a thing's overkill sound using "OVERKILL_SOUND" in
things.ddf.  When not overridden, defaults to the SLOP sound.

1999/11/29:

Rewrote wad code in glBSP for handling the GL level lumps.

1999/11/28:

Began rewriting the DivideSegs() routine for glBSP.  It will be
somewhat different to the one in the original `BSP 2.3'.

1999/11/26:

Added W_VerifyLumpName() routine to w_wad, which checks that the lump
has the expected name.  Used it in p_setup.c to check that the level
lumps are what they should be.

1999/11/25:

Implemented "DAMAGE_SPECIAL=WHOLE_REGION;" for sectors.ddf.  This
causes the damage to apply to the whole region, instead of just when
the player is touching the floor.  Updated P_PlayerInSpecialSector
accordingly, and made it properly handle multiple extra floors.

Improved TrueBSP sky handling.

Fixed TrueBSP problem of wall textures not animating.  Also fixed a
problem with texture alignment on lowers with DONTPEGBOTTOM.

1999/11/23:

Improved slope calculations (cur_world_x1/y1/x2/y2) in r2_bsp.c.  No
more grossly wobbly slope edges.

Began reworking some extrafloor code, to allow e.g. water to rise
above the sector ceiling or fall below the sector floor.

Added a new extrafloor_special: "FLOODER".  Such an extra floor will
"flood" all vertical regions below it with the same sector properties.
Useful for liquids that raise/lower past other extra floors (without
this tag, the lighting/colourmap/viscosity won't be "waterish" in
places where you would expect it to be).

OK, mostly done with new extrafloor code (the all-too-wordy
`extrafloor_record_t' list in sector_t, and P_ComputeSectorRegions in
p_maputl.c).  At least the "can't walk through" bug at the end of
QDOOM MAP01 was fixed in the process.

1999/11/22:

Fixed horizontal texture alignment in the -truebsp code.

Fixed vertical texture alignment in the -truebsp code.  This was much
trickier, Doom has all these special cases (upper, middle, lower
with/without the UNPEG flag).  May be some things not 100% working,
especially the sides of thick extra floors.

Fixed the V_DrawBox16() function.

1999/11/21:

Okidoke, tackled the lesser beasty of the glBSP code: the PickNode
routine.  Never did fully understand all the diff/total/count magic
that was going on, so rewrote it to be simpler, creating a new routine
EvalPartition() which evaluates the cost of a partition seg.  The code
_looks_ good, whether it works (and works well) remains to be seen...

1999/11/20:

glBSP...  Restructure nearly done, 5 out of 7 sources files now
compile again.

Well, C really stinks sometimes -- glBSP compiled but was fucking up,
simply because BIG_ENDIAN is defined in some header file here under
Linux.  Grrr.

1999/11/19:

Yep, more glBSP work.  Nope, nowhere near ready.

1999/11/18:

glBSP is coming along...  slowly...  Just realised that the code uses
the lump data _directly_ for everything except temp-nodes & temp-segs.
Very efficient, but a major barrier to working on big endian machines.
Hohum.

1999/11/17:

Disabled the DISK icon for the time being, since it causes crashes.
The M_Disk routine can also recurse into itself -- NOT GOOD.

Spent more time on glBSP, still learning the code... :-<

1999/11/16:

More work on `glBSP', managed a lot of reformatting and generally
making it consistent.  Removed all the visplane overflow checking
(quite a chunk of code), won't be needed for GL/TrueBSP, and
simplifies the code a lot.

1999/11/15:

Began work on `glBSP', a nodes builder that adheres to my "GL-friendly
NODES" specification.  Using the good work of Colin Reed, Lee Killough
and others (namely: BSP 2.3) as a base to work from.  Right now
reformatting the code to follow the EDGE coding standards, not a bad
way to become familiar with the overall structure of the code.

1999/11/14:

Made the small-damage-very-often scenario produce more red on the
screen.

Added extra music-info-type to ddf_mus.c: "TRACK", just to make the
playlist entries for CDs look nicer.  Totally ignored.  Perhaps
someday it might make sense to have something else (e.g. for the
10-at-a-time CD jukebox thingies).

Separated linux music & sound code (broken as it is) into i_music.c
and i_sound.c.

Found problem causing -truebsp to crash on new levels: a hurriedly
written R2_FreeupPoly() routine.  Fixed.

1999/11/10:

Added preliminary support for sloped planes (aka inclined planes).
Got some rendering going -- man it's rough though.  There are two new
fields for LINES.DDF:

  FLOOR_SLOPE_DIFF=...
  CEIL_SLOPE_DIFF=...

and when a special linedef with one/both of the these appears on the
map, the sector on the _right_ side of the line will be sloped (floor
or ceiling, depending on FLOOR_SLOPE_DIFF or CEIL_SLOPE_DIFF).  The
direction of inclination is along the linedef, and the amount of
inclination depends on the DIFF value: at the first vertex of the
linedef, the height is NORMAL (i.e. the one in map editor), and at the
second vertex the height will be NORMAL + DIFF.  Ramps are a piece of
cake with this.

There is a _long_ way to go before sloped planes will work properly.
Just rendering them properly (the first step) will take some doing,
handling the physics of the planes (climbing up, sliding down) and the
implications for p_map.c and p_maputl.c are immense.  In other words,
DO NOT count of it being usable for a long long _long_ time.

1999/11/07:

Fixed the "palette corrupted on resolution change" bug.  Allegro
doesn't remember the palette when changing the res (but keeping BPP
the same), and the old code assumed it did.

Noticed a weird line in M_FloatToFixed:

  if (fl < -32767)
    return -1;

... which under normal circumstances wouldn't be executed, so wouldn't
have caused any noticeable bugs.  Fixed anyway.

Fixed (for good I hope) the R_DrawColumn bug with extra floors.

Fixed the bug that Marc got when using "-truebsp" : minisegs don't
have walls but the code was trying to draw some.

Fixed RTS bug with `NAME' primitive, also `TAGGED_PATH', and a bug in
`PLAYSOUND'.  Talk about BugFest '99 :-).  Fixed CheckForFloat() so
that #defines are checked too.

1999/11/06:

Jumping had become exaggerated, due to removal of dud "momz friction"
code.  Toned it down some.

Wrote P_ThrustMobj() routine in p_inter.c, and P_RadiusThrust() in
p_map.c, and then implemented two new code pointers "THRUST" and
"VARIED THRUST", which work like "EXPLOSIONDAMAGE" and
"VARIEDEXPDAMAGE" but without the damage, just the thrusting effect.

Well f**k me, the thinker code was using a piece of memory after
freeing it -- a massive NO NO !  Someone slap the id guys :).
Reworked the thinker code, changed from a ring (thinkercap) to a
linked list.

Moved the code to unlink an object from the blockmap / sector links
from DoRemoveMobj back into P_RemoveMobj.  Objects need to be unlinked
immediately, otherwise strange things could happen e.g. picking up the
same box of rockets multiple times.

There's a bug somewhere that causes mobj_t's to have state == 0x0,
which is bogus (should never be NULL).  Prime example: box of rockets
on the skinny platform in MAP30.  Ah f**ken hell, state _can_ equal
0x0, set when a object is removed.  Someone slap _me_ now :-/.  Anyway
added extra checks for removed (but queued) objects.

1999/11/04:

Added a rather dirty hack to linux/i_compen.h which renames certain
variables to have an underscore (`_') prepended, so that when using
assembly they get linked to the corresponding symbols in the asm
files.  Welcome to the lovely world of C/ASM interfacing :->.

Added some extra checks to help find the DrawColumn bug.

1999/11/02:

Cleaned up linux Makefile some more, and added support for NASM.

Added O_BINARY to linux/i_compen.h, removing the ad hoc definition
from m_misc.c and w_wad.c

Removed the GLU functions for the prototype GL code in r2_bsp.c, and
changed #includes from glut.h to vanilla gl.h.

1999/10/31:

Changed the RADIUSTRIGGER primitive to handle the following 
possibilities:

   RADIUSTRIGGER <x> <y> <radius>                    // old way
   RADIUSTRIGGER <x> <y> <radius> <low z> <high z>   // new way

Changed the SPAWNTHING (etc) primitives to handle the follow
possibilities:

   SPAWNTHING <type>                        // old way
   SPAWNTHING <type> <angle>                // old way

   SPAWNTHING <type> <x> <y>                // new way
   SPAWNTHING <type> <x> <y> <angle>        // old way

   SPAWNTHING <type> <x> <y> <angle> <z>             // new way
   SPAWNTHING <type> <x> <y> <angle> <z> <slope>     // new way

(same applies to SPAWNTHING_AMBUSH and SPAWNTHING_FLASH).

Went through and GPL'd the sources ! :-D

1999/10/27:

Fixed SPAWNTHING, which was producing a bogus MLOOK angle.

Fixed plane lighting and flat alignment in TrueBSP renderer.

1999/10/26:

Fixed some stupid rad trig parsing bugs.

Added // comment detection to DDF parser.  Added a DDF_Error()
function which shows the line number where the error occurred.

Reworked BOUNCE code in P_XYMovement again -- the code "looks" right,
but needs testing...  Tested & tweaked, now pretty spot on.

The ever changing in-again out-again Disk is now in again :).

Changed all P_SetMobjState in each P_Act* routine to use
P_SetMobjStateDeferred, and put a limit to the number of deferred
states that can be executed in a single tic.  Since P_Act* routines
(aka code pointers) can be called by P_SetMobjState, which executes
the code pointers... that's right, an infinitel loop was possible.
This new scheme should have eliminated the "hang when using the god
cheat and dying" bug.

1999/10/24:

Added things.ddf fields SIGHT_SLOPE and SIGHT_ANGLE which controls the
vertical range (SIGHT_SLOPE) and horizontal range (SIGHT_ANGLE) of a
monster's sight when looking for a player.  SIGHT_SLOPE is an angle
between 0 and 90 degrees (cannot be exactly 90), and SIGHT_ANGLE is an
angle between 0 and 180 degrees (90 is normal, 180 gives total sight
in all directions).

Split up rad_trig.c into two new files: rad_main.h (containing the
structure definitions) and rad_act.c (containing the code to perform
the actions).  Prototypes for the action functions are currently in
rad_trig.h (not enough to justify a new .h file).

Some fuckwit accidentally deleted ddf_main.h, didn't they ?  ARGH !!
Somebody slap me.  Had to reimplement some stuff, but it could have
been a lot worse.

Finished rad trig reorganisation.  Along the way, implemented //
comments for radius trigger files.

1999/10/23:

Implemented a new DDF field for lines and sectors: WHEN_APPEAR, and a
corresponding type `when_appear_e'.  Special lines/sectors won't be
active (and will do nothing) when they "don't appear", exactly like
radius triggers.  Cleaned up the radius trigger code accordingly.

Began work on a state model for radius trigger scripts.  Might split
the rad_trig.c into two files, one for the actions, the other for
parsing and general maintainence.

Also started working on cleaning up the parser code, by having all of
the RTS primitives in a big table (not unlike the DDF code).
Implementing a few extra primitives along the way, so far: TIP_LDF
which has an ldf-entry instead of a string, TIP_GRAPHIC which as a
patch name instead of a string, SPAWNTHING_FLASH to get that
teleporter flash when spawning, and TAGGED_INDEPENDENT spelt correctly
(the other one still works).

1999/10/22:

Fixed up deathmatch handling for things (p_mobj) and radius triggers
(rad_trig).

Implemented RTS primitive SPAWNTHING_AMBUSH, which spawns a monster in
ambush (a.k.a "deaf guard") mode.

Replaced most "strcmp"s in rad_trig.c with DDF_CompareName, which is
more forgiving.  Replaced various malloc, strdup & free about the
place with the Zone equivalents.

Implemented end-of-level cameras.  Used like this in missions.ddf:

  BACKGROUND_CAMERA=<thing type name>;

The first object on the level of the given DDF type will be used to
generate the background image.  If no such object exists, the normal
background is used.

Allowed extrafloor side textures that come from the dummy sector's
line to be horizontally aligned.  Vertical alignment not possible
without TrueBSP due to current hackish implementation.

Implemented three new floor/ceiling dest refs: NEXTLOWESTFLOOR,
NEXTHIGHESTCEILING and NEXTLOWESTCEILING, which work analogously to
the original NEXTHIGHESTFLOOR dest ref.

1999/10/21:

Added a check for unclosed { } comments in DDF.

Added check for missing player starts, and improved the
G_DeathMatchSpawnPlayer code (removing requirement of having at least
4 deathmatch spots).

Man, the code for handling players is sure messy and tangled, quite
FUBAR in my opinion.  I still can't find the piece of code that
explicitly binds the consoleplayer to a specific mapthing -- looks
like the code just assumes it will be filled in automatically.

Wrote RAD_CheckForFloat() in rad_trig.c.

Fixed up SCROLL_PARTS.

Implemented new RTS primitive ACTIVATE_LINETYPE, which does the same
actions as if a line of a specific type was walked over, shot or
pushed.  Usage:

  ACTIVATE_LINETYPE <method> <linetype> <tag> <side>

Method is one of PUSH, WALK or SHOOT.  Linetype is the linedef type
number (e.g. 97 for teleporter), Tag is the sector tag, and Side is
which side to activate (0 for right side, 1 for left).

1999/10/18:

Fixed BOUNCE things forever entering bounce states when they slow down
on the floor.  Added new code pointers BOUNCE_REARM and BOUNCE_DISARM
TOUCHY_DISARM for complete control.  When an object bounces, it will
automatically be dis-armed and needs to be re-armed before it will
enter it's BOUNCE_STATES again.

Moved the specialslist from ddf_main.c to ddf_mobj.c.

More BOUNCE work, it's pretty close now, just need to set & take into
accound the objects vertangle and then use P_SetMobjDirAndSpeed() to
get some consistent behaviour.

1999/10/17:

Added M_CheckBooleanParm() function to m_argv, which checks for
positive flags (like "-extra") and negative flags (like "-noextra")
and sets a boolean value appropriately (or leaves it unchanged, if
neither is present).  Made E_SetGlobalVars use this method.

Removed never used `oldsetup' variable, also the `lessaccurate*'
stuff.

1999/10/16:

Removed unused `spanstop' array.

Got TrueBSP drawing code for walls & planes partly working, with
texture mapping, lighting, colourmaps & translucent planes.

1999/10/15:

Shit.  Found a nasty problem with the current polygonisation method
(using the BSP tree to create convex subsectors), namely that some
subsectors ARE NOT CONVEX !  Here's an ascii-art diagram of the
problem:
           .               .
           .               .
    ...........#-------#...........
           .  /         \  .
           . /           \ .
           ./             \. 
           #               #
           |     void      |    sector #123
           |               |
           |               |

Each `#' is a vertex, and the dotted lines are BSP divider lines.  The
problem is the two triangle areas.  According to the BSP tree, they
belong to the same subsector (along with the void space, i.e. forming
square shape).  But for our purposes, the triangles need to be
_SEPARATE_ subsectors.  Damn it.

The upshot is, we'll have to write our own nodes builder which (a)
always creates convex subsectors, (b) adds extra segs for the bits
normally missing, and (c) ensures a one-to-one correspondence between
segs on either side of a dividing line.  Ouch.

1999/10/14:

Added some sanity checks to p_setup.c -- should detect a
non-nodes-built levels now and abort.

1999/10/12:

Fixed the automap to show extra floors (like the bridge).  Needs
improving.

Added new lines.ddf field SCROLL_PARTS, which takes the following
comma-separated flags: RIGHT_UPPER, RIGHT_MIDDLE, RIGHT_LOWER,
LEFT_UPPER, LEFT_MIDDLE, LEFT_LOWER, and also RIGHT & LEFT which
enable the whole side to scroll.  Defaults to the normal Doom
behaviour: the whole right side scrolls.  Also rhe flags
LEFT_REVERSE_X and LEFT_REVERSE_Y which change the horizontal and/or
vertical direction on the left side.

1999/10/11:

Reworked the float_t get/put code in sv_util.c using the ANSI frexp &
ldexp functions.  Not tested yet.

1999/10/10:

Fixed switches (the textures weren't changing).

1999/10/09:

Split the texture & offset info out of the sidedef into a new
structure `sidepart_t'.  Helps with extrafloor code, plus will allow
more fine-grained control of scrolling that Fanatic would like.

Created routines P_AddExtraFloor() and P_RemoveExtraFloor() in
p_spec.c which can split/merge the vert_regions of sectors.

Added an additional RTS when_appear field: `extra'.  When present, the
RTS trigger will be ignored when -noextra is used.  Defaults to false.

1999/10/08:

Added new structures `plane_info_t' and `region_properties_t' and
`vert_region_t' to r_defs.h, which will help clean up the extra floor
stuff and pave the way for multiple extra floors per sector.  Changed
the sector_t type accordingly.

Fixed the problem with shooting & extra floors (p_map.c).  Still no
code for shooting extra floors themselves yet.

Reworked viscosity code.  Previously viscosity was just an inverted
friction, now it is a movement dampener.  This gives DDF authors an
extra dimension to play with.

Reworked MASS code, and made things with greater mass fall at a faster
rate (or slower rate, for small mass).

Reworked not-on-ground movement code in p_user.c.

1999/10/07:

Allow things to be spawned at arbitrary angles, not just multiples of
45 degrees.

Renamed gameflag `blood' to `more_blood', and added a new gameflag
`have_extra', and a corresponding DDF thing special "EXTRA".  Extra
things (like rain) are not spawned on the map when the "extra" option
is false.  Also command line option "-noextra".

Ported the linux version to LibGGI.  Rough as guts at the moment.

Made a very very rough port to OpenGL (the Linux/MESA flavour).
Nothing but flat-shaded solid-colour walls & planes for now.

1999/10/06:

More work on True BSP, fixing the NODES bounding boxes which helped
a surprisingly lot with the frame rate.

Removed unused function R_AddPointToBox from r_main.

Simplified bboxes: now each node_t and each subsector_t has a single
bounding box.  Will come in handy for doing quick rejection of extra
storeys based on ceiling/floor height and furthest point.

Made the ANGLED_SPAWN attack special use the speed from the SPAWNER
attack (ASSAULT_SPEED) instead of the spawned thing's speed.

Renamed `speed' field of attacktype_t to `assault_speed', and made it
fixed point instead of integer.

1999/10/05:

Removed the check for tics < 0 in P_SetMobjStateDeferred, which was
bogus (preventing Commander Keen on MAP32 from working properly).

Made sure radius triggers were being removed & freed properly when
being replaced by ones in later RTS files/lumps.  

Implemented the #CLEARALL directive for RTS which clears out all
current radius triggers.

1999/10/03:

Looks like _all_ the bounding boxes in the NODES lump are unreliable
for true bsp rendering.  Need to compute our own.

1999/10/02:

Made `visplanes' in r_planes.c be an array of _pointers_ to visplane_t
structs, preventing spurious crashes since Z_ReMalloc() was being used
but old pointers (like floorplane, ceilingplane, extraplane in the
drawsegs) were not being updated.

Added these DDF thing specials:

  MONSTER  :  Thing is considered a monster (mainly for -nomonsters).
              Fixes the 3006 hack in the code.  Implied by the
              COUNT_AS_KILL tag.
  
  CROSSLINES  :  Thing can cross lines which are marked as blocking
                 (via linedef flags).  Implied by the MISSILE tag.
  
  NOFRICTION  :  Thing is not affected by friction/viscosity (so
                 doesn't slow down by air).  Also implied by the
                 MISSILE tag.
  
  BARE_MISSILE  :  Same as `MISSILE', but doesn't imply anything
                   (CROSSLINES or NOFRICTION).
 
Made objects spawned on paths try and enter their MEANDER_STATES.

Cleaned up linux code a bit.

Wheee.....  Accidentally made player have no friction, it was like
playing pinball from the perspective of the ball !

Stopped the misc1/misc2 fields of weapon states from affecting sprite
placement.

Made { } comments in DDF recursible.

Removed the non-functional palette.ddf code.

Added check for non-existing default weapon when the player runs out
of ammo.  For now, just konks out with an error.

Made the extra blood not hang around forever (which really starts to
slow things down), but instead a random amount, increasing
exponentially to 60 seconds (i.e. skewed so that longer times are much
less common that shorter times).  Perhaps it would be better to have a
maximum number of mobjs that can be used for blood, which are recycled
FIFO style.

1999/09/30:

Got linux code working under new system.

1999/09/29:

Discovered another "Gotcha" with True BSP -- the bounding boxes from
the NODES lump only covers the segs and not any of the minisegs
(understandable really).  This explains why some subsectors were
disappearing.  Need to fix R2_CheckBBox.

The revelations keep coming: now I know that segs have to be split up
according to info in the 1D occlusion buffer.  All of a sudden, the
stuff in R_ClipSolidWallSegment makes perfect sense.

1999/09/28:

Worked on True BSP some more.  Found out that the boundaries between
sectors were not clearly defined, and now I have to code a much better
algorithm (one that can split segs).  Bugger.

1999/09/27:

Added some explanatory comments about the angle crap in
R_ScaleFromGlobalAngle() and R_StoreWallRange(), with some tidying.

1999/09/26:

Made the DDF parser recognise a mismatched '}' char.  This showed up
some bogus commenting in lines.ddf -- now fixed.

Started work on rewriting the savegame code.

1999/09/25:

Implemented extrafloor flags SIDE_UPPER and SIDE_LOWER which control
where the texture for the side of THICK floors comes from.  Normally
the mid-texture on the tagged line in the control sector is used, but
when one of these flags is present, the sidedef on the line where the
extrafloor is drawn will be used instead.

Implemented new RTS primitive `WHEN_APPEAR'.  Takes a single parameter
which is a colon (`:') separated list of skill values ("1" to "5") and
the following: "sp" (single player), "dm" (deathmatch) and "coop".
When not used, the RTS will be enabled for all skills and styles.

Implemented some new RTS primtives:

  NAME <name>             ; gives a name to an RTS trigger

  TAGGED_DISABLE          ; trigger is initially disabled (won't
                          ; activate until enabled).

  ENABLE_SCRIPT <name>    ; enables the trigger with the given name.

  DISABLE_SCRIPT <name>   ; disables the trigger with the given name.

Implemented new RTS primitive "TAGGED_PATH", taking a single parameter
which is the name of the next RTS trigger in the path.  Any objects
spawned by this trigger will follow the path (beginning with this
trigger) when the MEANDER code pointer is used in its states.

Made the thing options Boom compatible.

Implemented the Boom "PassThru" linedef flag (bit 9).

1999/09/24:

Fixed corpse sliders on extrafloors.

Changed back the puff & blood spawners to use P_Random() again, on the
off-chance the someone's puff/blood DDF stuff actually does something
important for demo/netgame sync.

Added ANGLED_SPAWN attack special, and updated P_ActObjectSpawning to
set the initial angle/slop/speed when used.

Implemented WATERWALKER special for things.ddf, and WATER extrafloor
special for lines.ddf.  Things that have the WATERWALKER flag will not
fall through extrafloors that have the WATER flag, instead they will
walk on the water.

1999/09/23:

Removed `miniseg_t' as a separate type, and made all the segs be a
linked list in the subsector.

1999/09/22:

Implemented the Boom thing flags NOT_DM (32) and NOT_COOP (64).

Removed the extrafloor flag MTF_EXTRAFLOOR (8192), the "EXTRAFLOOR"
field for things.ddf, and the P_PutThingsOnExtraFloor routine in
p_spec.c.  No longer needed, now that RTS can spawn things at specific
heights.

Fixed the buglet where the sides of thick extrafloors would disappear
when there were no extrafloor planes in view.

Fixed the NO_AMMO attack special.

1999/09/21:

Moved the drawing of extrafloor sides into R_DrawExtraFloors.  The
drawseg order is based on the BSP traversal, so this ensures that they
drawn properly (no more bleeding of planes into the sides), though
sprites will look strange in places.

Added more sanity checks to R_MakeSpans.

1999/09/20:

Move the visplane creation out of R_FindPlane and R_CheckPlane into a
new function NewVisplane().  In the process, found the cause of all
the visplane errors/crashes !  The pl->bottom[] array was not being
cleared properly.

Got an ultra simple prototype of "true BSP" working, all it does is
walls.  Not sure if the current screenline approach will cut it, for
speed it is vital that the 1D occlusion buffer works optimally...
Test results are encouraging though.

1999/09/19:

Added sector check to RTS sectorv/sectorl functions.

Got the subsector polygonisation code working.  There are still a few
failure cases, which seem to be due to segs which face the wrong
direction.  Whether this is a problem with the polygonisation code, or
with the wads themselves, remains to be seen.

1999/09/18:

Added z_urgency_e type for the zone.

Added NOAMMO attack special flag, to prevent the attack from depleting
ammo.  Mainy useful with the WEAPON_SPAWN code pointer for ejecting
shells.

Made DDF_MainGetSlope() convert the angle properly to a slope, using
the finetangent[] array.

Mork work on "True BSP", the subsector polygonisation code is almost
there.

1999/09/17:

Just decided that I hate `indent' :-).

Fixed (at last) tips carrying over into next level.

Fixed 16 bit translucent span drawer (it was bogus as hell).

Fixed Linux 16 bit code for new SCREENDEPTH semantics.

Made V_LoadColourmap cache the lump into PU_STATIC memory, so that the
following Z_Malloc() does not free it before we use it.

Moved the increment of new_palette in V_SetPalette back below the if
statement.  The previous way was causing all the colourmaps to be
invalidated each and every frame, i.e. a significant slowdown.

Found the cause of black text etc.: V_SetPalette was being called
before the PLAYPAL lump had been read in, thus the values in
pixel_values[] were bogus (all black).  Solution is simple:
V_SetPalette bails out if PLAYPAL has not been read yet.

1999/09/16:

Added `FlushCaches' routine to z_zone.c.  The idea is, when the zone
cannot fulfill a malloc request, then call other parts of the code and
make them free any unused stuff.  There is an urgency value, so things
that are very expensive to free (like textures & sprites) will only be
freed as a last resort.  Nothing uses it yet.

Cleanup up the "*17" stuff in s_sound.c using a macro SLIDER_TO_VOL
and using a non-slider constant MAX_VOLUME.

In ddf_main.c, replaced DDF_TransferExisting with DDF_MainInitStates
and rearranges some bits to make it tidier.  ARACHNOTRON_PLASMA should
work now.

1999/09/15:

More work on externalising the remaining hard-coded things & states.
Added CUBETRACER code pointer (P_ActHomeToSpot routine) which
precisely homes the cube onto the spawnspot & explodes the cube when
it reaches the spot.

Removed some no longer used stuff from p_enemy.c: A_Scream, A_XScream,
A_Pain, A_Fall, A_Explode.

In P_MobjCreateObject, changed the mobjlisthead code so that it adds
to the new map object onto the _head_ of the list.  Big speedup in
Fanatic's rain !

Added some sanity checks in P_UnsetThingPosition, to try and find the
source of the latest hangs (infinite loops).  Added the same checks to
p_mobj.c, and factored out the common code of P_RemoveMobj and
P_MobjRemoveMissile into a single function: DoRemoveMobj.

Turns out MAP30 doesn't need AUTOAIM after all -- it is obviously
meant to be incredibly difficult to kill the boss brain.

Got the bossbrain blowing up sequence (BRAIN_DEATH_MISSILE) working
and looking pretty reasonable.  Don't know how it compares with the
original though.

1999/09/14:

Made the side texture of THICK extrafloors come from the line in the
dummy sector.  Also made it share the translucency of the extrafloor
itself.  Fixed the problem of adding in the rowoffset from the line
that the extrafloor side is on.

Fixed linedef type 87, changing the type from PLAT to CONTINUOUS.  The
lift in the red-keyed builing on MAP13 now works properly.  Seems like
"PLAT" can now be removed as an independent floor type (i.e.  make it
synonymous with CONTINUOUS or MOVE).

Started work removing the remaining hard-coded things and states from
the code (mainly the bossbrain stuff for MAP30 of Doom II).

1999/09/13:

Added "AUTOAIM" to the SPECIALS for Doom II MAP30 in levels.ddf.
Without auto aiming, the BFG shots (and anything else) miss the brain
when standing on the pedestal (something which is not really obvious
when playing that level).

Allowed missiles to hit special lines like bullets can.  The line in
ddf must have TYPE=SHOOT and MISSILE in the ACTIVATORS.  New routine
MissileHitWall in p_mobj.c for this.

1999/09/12:

Changed the `player' field of camera_t to `view_obj', which can point
to an arbitrary object.

Allowed radius triggers to have a Z and height.  When not specified,
it defaults to the old behaviour: not caring about Z/height (i.e.
strictly two dimensional).

Made some variables in rad_trig.c and ddf_main.c static.  This is the
second time I've been bitten by this problem (two variables with the
same name being combined by the linker).  C sucks.

Using the sheer power of `--warn-common' :->, removed and cleaned up
all such nonsense.  Three variables were not defined anywhere except
in the headers !  One of them was mobjlisthead, which has caused
problems in the past (with RTS and game saving), and this must be the
reason.

Added the function P_SetMobjStateDeferred, which is similar to
P_SetMobjState but does NOT execute any action pointers -- the "real"
state (and the action pointers) will be performed in P_MobjThinker
(perhaps on the next tick, but no later).  This should prevent many
problems to do with re-entrancy -- previously a state could be entered
through PIT_CheckRelThing() from TryMove() etc. and the action pointer
caused the thing to do re-enter TryMove() etc. which is not designed
for re-entrancy.

1999/09/11:

Added new DDF routine: DDF_MainGetSlope.

Reworked the "SPAWNTHING" code in rad_trig.c, making it support more
parameters, one for the Z value, and one for the slope (which might
come in handy for cameras and such).  Also allowed the thingid to be
looked up *by name* (when not numeric), and allowed the angle to be in
degrees (when between -360 and +360).  Note: the thing is no longer
looked up during the parse phase -- this was unreliable (mobjinfos can
move about), and it is also possible that things referred to in the
RTS script have not been loaded yet (e.g. by DDFMOBJ).

Added P_MobjSetDirAndSpeed() utility function to p_mobj.c, and
P_AproxSlope() utility function to p_maputl.c, and updated some stuff
to use 'em.

Removed all the free() stuff out of rad_trig.c -- the code was
unreliable (accessing fields after the memory was freed).

Wrote a DDF_CompareName() routine which is like strcasecmp(), but
ignores spaces & `_' chars.  Only DDF_MobjLookup() uses it for now,
but later every DDF files (RTS too) will use it for most things
(including the name in [], field names, special/flag names).

Changed the internal prefix for attack names from "__" to "ZZ_", in
case the above rule causes matches that would not have occurred
before.

Made player close-combat weapons (fist & chainsaw, or anything using
ATK_CLOSECOMBAT attack) used the player thing's MELEE_STATES instead
of the missile states.

Implemented JUMP_SOUND for things.ddf.  Only the player can jump
currently, but in the future monsters which jump off ledges may also
use this field.

1999/09/10:

Fixed the bug causing monsters to get stuck in doortracks.  Used the
same method as Lee Killough's.  Seems to work OK.  Also adjusted when
the door sound gets made, so that monsters trying to open already open
doors don't make the opening sound (bit of a hack).

Made `volume' in s_sound.c generally have the full range 0 to 255.
Note that snd_SfxVolume, S_MIN_VOLUME and S_MAX_VOLUME are still in
the range 0 to 15.

Experimented with an echo effect -- it sucked, timing-wise DosDoom
just doesn't have the precision to pull it off.  Added S_Ticker during
this experiment, no longer used but it might come in handy later.

Added two new attack.ddf fields: ANGLE_OFFSET and SLOPE_OFFSET.  The
first one is in degrees and is added to the attack direction.  The
second one is also degrees (roughly speaking), and gets added to the
vertical direction (actually momz) of the attack.

Added I_Warning(), for anything that is not quite serious enough to
drop out like its counterpart I_Error() does.

Tidied up the currentcmdlist[commandref].data stuff in ddf_main.c, and
the errors when it or `info' were NULL.  Rewrote DDF_MainGetFixed and
DDF_MainGetTime to use sscanf() and floats, and remove the routine
DDF_MainGetFixedHelper.  Added a new routine: DDF_MainGetAngle.

1999/09/09:

Implemented WEAPON_SPAWN action, which is just like WEAPON_SHOOT
except that is never kicks, never shows the flash psprites, and
doesn't change the player's current state.

Changed A_FireWeapon so that weapons with ENGAGED_SOUND don't return
early (I guess this was never a problem before since the only weapon
using ENGAGED_SOUND is the chainsaw).  Note: not to be confused with
the ENGAGED_SOUND field used in attacks.ddf.

1999/09/07:

Fixed a problem with RTS tips carrying over into the next level (and
then not going away for a long time).

Allowed multiline tips in RTS, using \n to separate them.  Increased
some maximum sizes (MAXTIPLEN, MAXSTRLEN) to cope with the demand.

In the process, updated hu_lib to write centered text. 

1999/09/06:

After three days of hacking, discovered the algorithm for polygonising
floors & ceilings based on the BSP tree.  Essentially we just traverse
the BSP tree down to a subsector, and find the 2D intersection (Venn
diagram style) of all the halfplanes from each traversed node, and
then the halfplanes from all the segs of the subsector.  As simple as
that !

The algorithm for finding the 2D intersection ended up being simple
too: collect all the points where each pair of halfplanes intersect,
and then test them all against those halfplanes for inclusion (making
sure that any points that lie directly _on_ a halfplane line is not
excluded).

Sweet.

1999/08/31:

Began work on "true bsp rendering".  Might take some time...

1999/08/30:

Fixed small gap between an extra floor & a normal floor.

1999/08/29:

Fixed a small problem in r_bsp.c with extra floors that butted up
against each other not working properly.

1999/08/24:

Fixed up the code that renders extra floors, which included quite some
rearrangements in r_things.c.  The current method is ain't too good,
probably has many failure case & especially masked middle textures
don't work very well near extra floors.  True BSP rendering (as per
John Carmack's notes) will fix all this.

1999/08/22:

Spent quite some time getting the new BOUNCE code to work properly,
including splitting off a new P_BounceOffWall routine in p_mobj.c.

Added TOUCHY_REARM code pointer, and made a touchy contact
automatically "disarm" the touchy thing.  Prevents the touched states
from being continuously re-entered when e.g. a player moves over it.

Found a major problem.  When doing P_CheckRelPosition, a collision
between two objects may cause some other object to (a) try and move,
thus recursing into a non-recursible routine, or worse (b) remove an
object via P_UnsetThingPosition and thereby throwing the blockthing
iterator out of whack.  Hmmm...

Nuked `P_SpawnPlayerMissile' -- no longer used.

Argh !  Spent many hours today just finding a bug that occasionally
caused a fired missile to halt the game completely.  Culprit turned out
to be P_ActCheckMissileSpawn() which changed the objects x & y fields
directly -- not a good idea as I now well know...

1999/08/21:

Fixed G_DefineGetSpeedDivisor in g_game.c (I had buggered it up).

Added BOUNCE_SPEED to things DDF.
Added TOUCHY special flag to things DDF.
Added BOUNCE_STATES and TOUCH_STATES to DDF.  

Also went through the code and added "if (xxxxstate)" before each
P_SetMobjState() call -- probably not absolutely necessary but it's
better than objects just vanishing if they don't have XXX states.

Added EXPLODE code pointer, and noticed that P_ExplodeMissile() and
P_ActExplodeMissile() were exactly the same & merged 'em.

Made R_PointToDist more general, and collapsed R_PointToAngle and
R_PointToAngle2 into just one function.

1999/08/17:

Renamed WEAPON_MULTIFIRE to WEAPON_NOFIRE_RETURN, and added a new code
pointer "WEAPON_NOFIRE" which does a similar thing, but doesn't
remember the position in the attack states.

1999/08/16:

Fixed a problem with colourmaps not being reloaded when BPP changes.

Changed the MTF_EXTRAFLOOR thing flag from bit 10 to bit 13.

Got rendering of thick floors working.  Yay !  Sprites are not drawn
correctly though, and doing so won't be easy either...

1999/08/15:

Started work on rendering multiple floors.

Changed `floorplane' & `ceilingplane' variables from ints to
visplane_t pointers, and added `extraplane' & `extraclip' for the
extra floor.

Added `transp' and `subsec' to R_FindPlane and the visplane struct.
Visplanes of extra floors will only span a single subsector, to make
clipping sprites against them easier.  Doesn't affect normal
floors/ceilings (they still can merge for faster rendering).

1999/08/13:

Renamed SCALE & ASPECT in things.ddf to "SPRITE_SCALE" &
"SPRITE_ASPECT", which is more accurate.

1999/08/11:

Changed `weaponowned' array in player_t in d_player.h to be
"playerweapon_t *weapons", and defined the playerweapon_t type in
p_pspr.h to contain some extra info (e.g. number of shots fired).

Put WEAPON_REFIRE back to normal (in case it *did* break B.C.), and
coded up WEAPON_MULTIFIRE instead.

1999/08/10:

Removed "REVERSE" flag from colmap.ddf.  Pretty crap idea.

Renamed `keylookspeed' to `mlookspeed', and tidied up a bit the
G_BuildTicCommand() function in g_game.c.

Implemented multiple attacks, of the form "WEAPON_SHOOT=ATK_NAME".
The same thing applies to monster's CLOSE_COMBAT, RANGE_ATTACK and
SPARE_ATTACK (for what it's worth).

Made the WEAPON_REFIRE work differently: it remembers where it left
off, so that it can be used with multiple attacks (e.g. a weapon where
the first shot goes left, the second shot goes right).  Looking at
various DDF files, this should't break backwards compatibility.

1999/08/09:

Increased the XXX_Printf buffers up to 4096 in size (was bitten by a
buffer overflow in linux/l_system's I_Printf).

Changed I_Printf(DDF_LanguageLookup(...)) to I_Printf("%s", DDF_...) in
various places.  This protects against any stray `%' characters that
someone may put in default.ldf.

Moved the action list out of p_action.h (with the DDF_MAIN hack) into
ddf_mobj.c instead, and added a function "handler_arg" to the
actioncode_t type for handling special arguments (like the bit after
the `=' in "WEAPON_SHOOT=FIREBALL").

Changed default float_speed to 2.0.  That's a compromise value for
backwards compatibility with floating monsters (normally 4.0) and
puffs (normally 1.0).

1999/08/08:

Implemented the FORCE_AIM attack special to fix the chainsaw.

Fixed clipping cheat in new p_map code.

Made scaling of things work properly.  The fact that dc_texturemid is no
longer used by R_DrawMaskedColumn() is a bit worrysome, but everything
still looks OK.

Replaced P_Random()-P_Random() in various places with a single
routine: P_RandomNegPos().  The former could produce different results
depending upon the order of evaluation, as Lee Killough points out in
his sources.

1999/08/07:

Found the bug with close combat attacks (esp. the chainsaw).  Solution
not yet implemented (probably a FORCE_AIM attack special flag).

Fixed the crushers on MAP13 -- they no longer get stuck at the bottom of
the crush when a player (esp. an invulnerable one) is caught.

Experimented with "SCALE" and "ASPECT" fields for things.ddf, for making
things bigger or smaller (but mainly for supporting higher resolution
sprites).  Implemented it via xscale & yscale fields in mobjinfo_t.

1999/08/06:

Fixed a bug WRT bufferreplacemobj not being reset to NULL.

Created P_FindThingGap() in p_maputl.c, which contains the code
previously in p_map.c for finding the best gap.  P_ComputeThingGap() now
uses this routine, and it fixes the candles-not-rising problem.

1999/08/04:

Removed DAMAGE_EVERYWHERE from sectors.ddf -- a more flexible approach
would be better (e.g. "DAMAGE_SPECIAL").

More rewriting of the linux video code. Works now. Still needs a lot
more work.

1999/08/02:

Added V_ColourNewFrame() to v_colour, to finally fix the "gamma too late
on walls" bug.  Made radius trigger scripts for a map non-accumulative
(a new "start_map xxx" will clear out any old triggers for that map).

Worked on the linux port.

1999/07/31:

Added "DAMAGE_EVERYWHERE" boolean field to sectors.ddf, which makes
sector damage occur everywhere, not just on the floor.  Updated
P_PlayerInSpecialSector & P_PlayerInExtraSector in p_spec.c accordingly.

Added code for things riding on top of other things.  Ridable platforms
a la quake and ridable vehicles are on their way :-).

More work rewriting p_map.c for extra floors. Re-introduced `tm_floorz'
and `tm_ceilnz', and removed the tm_gaps. Choosing which gap is now done
in PIT_CheckRelLine, simplifying things immensely.

1999/07/30:

Getting a much clearer picture now of how the code should handle extra
floors.  My previous code (in p_map.c et al) was pretty dodgy, so I've
begun to rewrite it.

Removed the guts of P_SpawnMobj in p_mobj.c.  It was virtually identical
to P_MobjCreateObject.

Added `ex_floor' & `ex_ceiln' fields to sector_t which cache the extra
floor position.  The problem was EXFL_THICK floors, since these have an
unusual relationship (control's _ceiling_ is the extra floor, and
control's _floor_ is the extra ceiling *underneath* it), and the extra
checks needed were beginning to get ugly.  Turned out easier than I
expected: they can be calculated in P_UpdateSectorGaps along with the
line gaps.

Split P_CheckPosition into two: AbsPosition and RelPosition.  For
P_CheckAbsPosition & P_TeleportMove: added a z parameter to make it more
flexible (and not make assumptions about thing's current z).

Fiddled with the EF_BOUNCE code -- purely experimental stuff.

1999/07/29:

Added `tag_next' & `tag_prev' to sector_t, and some code in p_setup.c
(namely P_GroupSectorTags) which calculates them when sectors are
loaded.  This replaces the clumsier method I was using (an array of
pointers), and will speed up normal tag searches once I reimplement
P_FindSectorFromTag() and/or stuff using it.

Removed `floornum' field from mobj_t (a bogus idea).

1999/07/28:

Added support for players being damaged when underwater.

1999/07/27:

Added an Mlook key to the extended controls.

Fixed a bug in p_plane.c where non-crushing once-only floors would try
to go back down if some thing gets in the way.

1999/07/25:

More work / tweaking getting the new extra floor code to work.  Found
and fixed the new bug where monsters were getting stuck near dropoffs.
Added `extrafl_offset' to r_bsp.c & r_segs.c, which fixes the walls
moving when the deep water surface rises/falls.

Changed the MLOOK axis code in g_game.c and removed the "*4".  Mlook
seems more reasonable now (to me at least :->).

Found the bug that stopped teleporters working: the RESPAWN_FLASH had a
conflicting mapnumber (14) with the good 'ol TELEPORT_FLASH.

Changed RAD_UpdateThingsinSector() to just call P_ChangeSector, instead
of doing the damage itself.  This makes sure that the line gaps get
recomputed.

1999/07/21:

Added P_UpdateSectorGaps, which gets called whenever an extrafloor is
added to a sector (in p_spec.c).  Added `floornum' to mobj_t, so that
P_ThingHeightClip() can clip things to the correct floor when sectors
change height.

Made bit 10 of the thing flags in WAD files be the "on extra floor"
flag.  (Subject to change after discussion).  Added the "EXTRAFLOOR"
special to things.ddf which can be used to achieve the same thing (but
not really recommended).

Implemented "EDGEWALKER" and "GRAVFALL" specials in things.ddf.  The
first one makes monsters walk along dropoffs like players can, the
latter means that DROPOFF monsters will fall using gravity (and not
instantly jump down to floor as before).

Did heaps of stuff to p_map.c, p_maputl.c (and a few other bits) for
implementing extra floors.  Solid "water" than you can work on now
works.  I'm happy now :-).  Glass floors should work too (untested).
Still lots of things to fix...

Added the "CLIMBABLE" special to things.ddf (and associated flag in
mobj_t's extendedflags).  Such things can be climbed by other things as
if they were a platform (so long as step_size allows it).

1999/07/19:

Worked on getting extra floors to work in the p_map.c (etc) game code.
Just one extra floor per sector complicates things enormously.  Had to
rewrite all the `tmfloorz/tmceilingz' bits, and instead keep a list of
all the gaps between sectors.

This involved doing one of the suggested optimisations: keep the gap
information in line_t & only update when needed (i.e. when a bordering
sector changes height).  Thus R_LineOpening is no more...

Cleaned up m_random.c/h, removing J_Random, and replaced various
P_Random calls in the code which don't affect demo sync (such as blood
splats, bullet puffs, choice of sound to play) with M_Random.  Demo sync
is so very very fragile -- there's just no way to guarantee backwards
compatibility in an evolving engine, but this might help a tiny bit.

1999/07/16:

Added `xoffset' and `yoffset' to R_FindPlane & the visplane struct.
Paves the way for scrolling flats.

1999/07/15:

Underwater sprites (including the player's weapon) were not being
affected by the underwater colourmap.  Fixed.  Also allowed colourmaps
to control FULLBRIGHT sprites (can use the "BRIGHT" colourmap instead).

Fixed two bugs in LINES.DDF, one which had xxxSPEED=65536 (which ends up
as 0 in fixed_t, thus no movement), the other (#24) should be G1 and not
GR (fixes the shootable wall in MAP01 of Eternal).

1999/07/14:

Due to popular demand :), DDF-itised the bullet puffs (using FLOAT_SPEED
in things.ddf).  This also removed the hardcoded FLOATSPEED value for
floating monsters (cacodemons etc).

Sometime in the last few days, I fixed the gamma handling in the
interpolate_colourmaps code (need to lookup gamma on the interpolated
points, and not just the end-points).  (Same mistake as before :->).

Moved the "usegamma = current_gamma" into V_ChangeGamma, seems to be the
most logical place.  At least gamma works again :).

1999/07/13:

Implemented direction/speed/height preserving teleporters
(TELEPORT_SPECIAL in lines.ddf).

It was a real hair-pulling session :-/, but I finally got 16-bit mode to
work on the Linux port.  Did some more cleanup of the Linux code --
still a long way to go but.

Made bullets puffs not float up (i.e. momz be 0 instead of FRACUNIT in
P_SpawnPuff).

Fixed the "gamma too late on walls" bug.

1999/07/12:

Finished off colmap.ddf support over the last three days. Getting the
SHADOW effect to work correctly took some doing, but eventually the
correct solution (using `coltable' in the vissprite struct) shone
through.  Updated LIGHTLEVELS to 32 -- can't tell much difference but
it's nice all the same :-).  24-bit mode is gonna rock.  Made r_things.c
use zlights[] instead of scalelights[], not much benefit but it did
remove a FixedDiv in there.  Fixed scrolling second sidedefs -- the
vertical direction was wrong.

Found the Doom1-intermission-crash bug, it is something to do with
`splat' not being initialized in wi_stuff.c but still being passed to
WI_DrawOnLnode().  Don't know the correct fix yet...

Did some work on the Linux port.  At least now it doesn't segfault on
exit :->.

1999/07/09:

Started writing support for COLMAP.DDF and PALETTE.DDF, in the form of
"ddf_colm.c" and extra stuff in ddf_main.h.  Made the colmap.ddf file
simpler than the one I posted to the ML, there's no big need to describe
the type.

Experimented with "interpolating palettes", and for large pain it looks
nice (but not really noticeable for bonuses & small pain).  Will wait
until PALETTE.DDF is fully implemented before coding it properly.

1999/07/05:

Commented out F_DrawPatchCol in f_final.c: this will be moved to
v_video1/2.c, in keeping with the idea that no BPP-depended code should
exist outside of the v_*.c and r_*.c files.

Added `pixel_values' array to v_colour, to replace the use of allegro's
`palette_color'.  Added I_Colour2Pixel to the i_video.h interface, used
by v_colour to create that array.  Removed all the remaining #includes
of allegro.h, i_alleg.h & i_allegv.h that existed in the main doom code.
Some things are broken right now, but I don't want the patch to be
excessively big...

Added I_ScreenRows & I_ScreenCols to the i_system.h interface.

1999/07/04:

Removed references to SAMPLE from the i_sound.h & lu_sound.h files, and
changed `data' to `priv_data' in sfxinfo_t.  Added I_GetTruecolInfo() to
the i_video.h interface, and implemented it in i_allegv.c & linux code.

Spent a while rewriting the code that calculates the col2rgb16 LUT
(moving it from i_allegv.c to v_colour.c), it can now handle any
reasonable 16 bit format (reverse endianness won't be hard either :->).
Tidied up the linux code a bit, removing some of the "#ifndef DOSDOOM"
in there.

Added extra functions to v_res.h (V_DrawPixel, V_DrawLine, and
V_DrawPixel), and moved line drawing code from am_map.c into
v_video1/2.c (making am_map.c using the new functions).

1999/07/03:

Created some palette handling code (V_SetPalette, PALETTE_*, etc), and
removed the `redness' parameter from I_SetPalette.  Thus cleaned up the
various PLAYPAL references that were scattered about. Added
I_MakeColourmapRange to the i_video.h interface (the alternative was
just having a I_MakeCol function analogous to Allegro's makecol(), but
that could be too slow).  Moved some other colour related stuff to
v_colour.c/h (mainly gamma).

1999/06/30:

Started work on the Linux version, and started on moving some of the
code that can be shared between the different OS version (such as the
calculation of the translucency tables) into the common code.  To that
end, created `v_colour.c' and `v_colour.h', and moved the rgb_32k,
col2rgb8 & col2rgb16 tables there.  

I've noticed that access to the PLAYPAL palette lump occurs all over the
place, so added a V_ReadPalette function & `playpal_data' variable to
the v_colour files.  So far, nothing but V_CalcTranslucencyTable uses it.

Implemented translucent mid-textures for 2S lines.

1999/06/25:

Fixed the vertical scrollers (SCROLL_YSPEED etc. in lines.ddf).

This showed up another (more serious) bug: the GetFixedHelper code in
ddf_main.c will accept "-0.3" (for example), as it should, but it
converts it to the wrong value (+0.3).  I'll wait until the new version
before fixing it.

1999/06/22:

Implemented BOOM's deep water affect, with some extra fields in
lines.ddf (EXTRAFLOOR=... etc), and paved the way for "thin" and "thick"
floors.

1999/06/20:

Added code in ddf_sect.c & ddf_line.c which ignores an unknown linedef
or sector type (and displays a message), just like the way unknown
things are handled.  Dawning.wad now works (as much as possible anyway).

1999/06/18:

Found "a" fix for the sector-damage-not-erasing bug on MAP20.  It relies
on the model sector having a special type of 0 (as far as I can tell).
The real fix is probably to add some extra stuff in lines.ddf to make
the FLOOR_TEXTURE="-" and FLOOR_TEXTURE="+" and SECTYPE=0 more
understandable (right now it's pretty hard to understand).

It may even make sense to define "plane actions" in a DDF file: things
that can be done to a moving floor/ceiling when they start or stop
moving, including transferring a floor texture, transferring a sector
trait, and in particular making a certain sound.

1999/06/16:

Fixed the stair bug that caused a problem on MAP21.  The problem was
that that the next stair was being raised relative to its current
height, instead of relative to the previous stair's destination height.

Added some code to i_video.c which computes the lighting colourmaps
(0..31) in hicolor mode by linearly interpolating the start & end colors
(providing better shading on screen).  Had to fix it: the gamma handling
was wrong (gamma should be applied _after_ the linear interpolation).

